

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Templify ‚Äì Ultimate Editor v1</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#0b5fff;
      --muted:#aab0bd;

      --bg:#050712;
      --panel:rgba(15,18,32,.58);
      --panel2:rgba(15,18,32,.36);
      --stroke:rgba(255,255,255,.10);
      --text:#f6f7fb;

      --shadow:0 18px 50px rgba(0,0,0,.45);
      --radius:18px;

      --topH:58px;
      --leftW: 220px;
      --rightW: 240px;
    }
    [data-theme="light"]{
      --bg:#f5f7ff;
      --panel:rgba(255,255,255,.76);
      --panel2:rgba(255,255,255,.55);
      --stroke:rgba(10,20,60,.12);
      --text:#0b1020;
      --shadow:0 18px 40px rgba(10,20,60,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(11,95,255,.22), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(136,71,255,.18), transparent 55%),
        radial-gradient(900px 600px at 35% 95%, rgba(0,225,255,.10), transparent 55%),
        var(--bg);
      overflow:hidden;
    }

    /* Layout */
    .app{
      height:100%;
      display:grid;
      grid-template-rows: var(--topH) 1fr;
      grid-template-columns: 1fr;
    }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid var(--stroke);
      background:var(--panel);
      backdrop-filter: blur(16px);
      box-shadow: 0 8px 26px rgba(0,0,0,.25);
      position:sticky;top:0;z-index:50;
    }

    .brand{
      display:flex;align-items:center;gap:10px;min-width:210px;
    }
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:linear-gradient(135deg, rgba(11,95,255,.95), rgba(136,71,255,.88));
      box-shadow:0 10px 26px rgba(11,95,255,.22);
      border:1px solid rgba(255,255,255,.16);
      flex:0 0 auto;
    }
    .brand b{font-size:13px;letter-spacing:.2px}
    .brand span{display:block;font-size:11px;color:var(--muted);margin-top:1px}
    .pill{
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background:var(--panel2);
      color:var(--muted);
      font-size:11px;
      white-space:nowrap;
    }

    .tools{
      display:flex;align-items:center;gap:8px;
      flex: 1 1 auto;
      min-width: 260px;
      overflow:auto;
      padding:2px 0;
    }
    .tools::-webkit-scrollbar{height:8px}
    .tools::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}
    [data-theme="light"] .tools::-webkit-scrollbar-thumb{background:rgba(10,20,60,.14)}
    .btn{
      appearance:none;
      border:1px solid var(--stroke);
      background:var(--panel2);
      color:var(--text);
      padding:9px 10px;
      border-radius:14px;
      font-weight:600;
      font-size:12px;
      cursor:pointer;
      transition:.15s ease;
      backdrop-filter: blur(16px);
      display:inline-flex;align-items:center;gap:8px;
      white-space:nowrap;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(11,95,255,.35)}
    .btn:active{transform:translateY(0px)}
    .btn.primary{
      background:linear-gradient(135deg, rgba(11,95,255,.95), rgba(136,71,255,.85));
      border-color:rgba(255,255,255,.14);
      box-shadow:0 12px 30px rgba(11,95,255,.18);
    }
    .btn.danger{border-color:rgba(255,80,120,.35)}
    .btn.tiny{padding:7px 10px;font-size:11.5px;border-radius:12px}
    .righttools{
      max-width:140px;
      overflow:hidden;

      display:flex;align-items:center;gap:8px;flex:0 0 auto;
    }
    .kbd{
      max-width:200px;
      overflow:hidden;
      white-space:normal;
      word-break:break-word;

      max-width:260px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:normal;
      line-height:1.4;

      font-size:10.5px;color:var(--muted);
      padding:6px 10px;border:1px solid var(--stroke);
      background:var(--panel2);border-radius:999px;
      white-space:nowrap;
      display:flex;align-items:center;gap:8px;
    }

    /* Work area */
    .work{
      display:grid;
      grid-template-columns: var(--leftW) 8px 1fr 8px var(--rightW);
      height:100%;
      overflow:hidden;
    }

    .panel{
      border-right:1px solid var(--stroke);
      background:var(--panel);
      backdrop-filter: blur(16px);
      overflow:hidden;
      min-width: 220px;
    }
    .panel.right{
      border-right:none;border-left:1px solid var(--stroke);
      min-width: 260px;
    }

    .panelHeader{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--stroke);
      display:flex;align-items:center;justify-content:space-between;gap:8px;
    }
    .panelHeader b{font-size:12.5px}
    .panelHeader .seg{
      display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;
    }
    .seg .chip{
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background:var(--panel2);
      color:var(--muted);
      font-size:11px;
      cursor:pointer;
      user-select:none;
    }
    .seg .chip.active{
      color:var(--text);
      border-color:rgba(11,95,255,.40);
      box-shadow:0 10px 24px rgba(11,95,255,.10);
    }

    .panelBody{padding:12px;overflow:auto;height:calc(100% - 52px)}
    .panelBody::-webkit-scrollbar{width:10px}
    .panelBody::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}
    [data-theme="light"] .panelBody::-webkit-scrollbar-thumb{background:rgba(10,20,60,.14)}

    .search{
      width:100%;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.12);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      outline:none;
      margin-bottom:10px;
    }
    [data-theme="light"] .search{background:rgba(255,255,255,.55)}

    .list{display:grid;gap:10px}
    .item{
      border:1px solid var(--stroke);
      background:var(--panel2);
      border-radius:16px;
      padding:10px;
      cursor:pointer;
      transition:.12s ease;
    }
    .item:hover{transform:translateY(-1px);border-color:rgba(11,95,255,.30)}
    .item b{display:block;font-size:12.5px}
    .item span{display:block;font-size:12px;color:var(--muted);margin-top:3px;line-height:1.35}

    .splitter{
      cursor:col-resize;
      background:transparent;
      position:relative;
    }
    .splitter::after{
      content:"";
      position:absolute;left:50%;top:10px;bottom:10px;
      width:2px;transform:translateX(-50%);
      background:rgba(255,255,255,.10);
      border-radius:999px;
    }
    [data-theme="light"] .splitter::after{background:rgba(10,20,60,.12)}

    /* Canvas */
    .stage{
  position: relative;
  overflow: hidden;
  background: transparent;
  display:flex;
  align-items:center;
  justify-content:center;
  height: 100%;
}
    .stage::-webkit-scrollbar{width:12px;height:12px}
    .stage::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}
    [data-theme="light"] .stage::-webkit-scrollbar-thumb{background:rgba(10,20,60,.14)}

    .canvasWrap{
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
}
    .canvas{
      width: 980px;
      height: 620px;
      aspect-ratio: 980 / 620;
      max-width: calc(100% - 24px);
      max-height: calc(100% - 24px);
      border-radius: 18px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)),
        rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 22px 70px rgba(0,0,0,.45);
      position:relative;
      transform-origin: center;
}
    }
    [data-theme="light"] .canvas{
      background:
        linear-gradient(180deg, rgba(10,20,60,.05), rgba(10,20,60,.02)),
        rgba(255,255,255,.85);
      border:1px solid rgba(10,20,60,.12);
      box-shadow: 0 18px 55px rgba(10,20,60,.20);
    }

    .gridOverlay{
      position:absolute;inset:0;border-radius:18px;
      background-image:
        linear-gradient(to right, rgba(255,255,255,.07) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.07) 1px, transparent 1px);
      background-size: 24px 24px;
      opacity:.55;
      pointer-events:none;
      mix-blend-mode: overlay;
    }
    [data-theme="light"] .gridOverlay{
      background-image:
        linear-gradient(to right, rgba(10,20,60,.08) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(10,20,60,.08) 1px, transparent 1px);
      opacity:.45;
      mix-blend-mode: multiply;
    }

    .el{
      position:absolute;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.15);
      background: rgba(11,95,255,.18);
      color: var(--text);
      padding: 10px 12px;
      min-width: 120px;
      cursor: pointer;
      user-select:none;
      box-shadow:0 14px 38px rgba(0,0,0,.25);
    }
    .el h4{margin:0;font-size:14px;line-height:1.2}
    .el p{margin:6px 0 0;font-size:12px;color:rgba(255,255,255,.85);line-height:1.35}
    [data-theme="light"] .el{
      background: rgba(11,95,255,.10);
      border:1px solid rgba(10,20,60,.12);
      box-shadow:0 12px 28px rgba(10,20,60,.16);
    }
    [data-theme="light"] .el p{color:rgba(10,20,60,.82)}

    .selected{outline:2px solid rgba(11,95,255,.95); outline-offset:2px}

    /* Properties */
    .propGrid{display:grid;gap:10px}
    .field label{display:block;font-size:11.5px;color:var(--muted);margin:0 0 6px}
    .field input,.field select{
      width:100%;padding:10px 12px;border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.12);
      color:var(--text);outline:none;
    }
    [data-theme="light"] .field input,
    [data-theme="light"] .field select{background:rgba(255,255,255,.55)}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    .miniHelp{
      font-size:11px;color:var(--muted);line-height:1.45;
      border:1px solid var(--stroke);
      background:var(--panel2);
      border-radius:16px;padding:10px;margin-top:10px;
    }

    .hidden{ display:none !important; }
    .actionsRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .actionsRow .btn{ flex:0 0 auto; }

    /* Responsive */
    
    @media (max-width: 1120px){
      .kbd{display:none;}

      :root{ --leftW: 220px; --rightW: 240px; }
      .canvas{width: 900px;}
    }
    @media (max-width: 980px){
      .work{grid-template-columns: 1fr;}
      .panel,.splitter{display:none}
      .stage{padding:14px}
      .canvas{width: min(920px, 100%); height: 560px;}
      .tools{min-width: 1px}
    }
  
    /* === Canva-style layout clone (non-destructive) === */
    .work.canvaWork{
      display:grid;
      grid-template-columns: 72px 260px minmax(0,1fr);
      height:100%;
      overflow:hidden;
      gap:0;
    }
    .rail{
      border-right:1px solid var(--stroke);
      background:var(--panel);
      backdrop-filter: blur(16px);
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:10px 8px;
      gap:10px;
    }
    .railBtn{
      width:44px;height:44px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:var(--panel2);
      color:var(--text);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      transition:.15s ease;
      user-select:none;
    }
    .railBtn:hover{transform:translateY(-1px);border-color:rgba(11,95,255,.35)}
    .railBtn.active{
      background:linear-gradient(135deg, rgba(11,95,255,.95), rgba(136,71,255,.85));
      border-color:rgba(255,255,255,.14);
      box-shadow:0 12px 30px rgba(11,95,255,.16);
    }
    .sidePanel{
      border-right:1px solid var(--stroke);
      background:var(--panel);
      backdrop-filter: blur(16px);
      overflow:hidden;
      min-width:260px;
    }
    /* Hide old splitters/left panel styling if any leftover rules expect them */
    .splitter,.panel.left{display:none !important;}
    /* Stage gets all remaining space */
    .work.canvaWork .stage{padding:0; overflow:hidden;}

</style>



<style>
/* === NEW CANVAS SYSTEM (REPLACED) === */
.stage{
  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
  overflow:hidden !important;
}
.canvasWrap{
  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
  min-height:100% !important;
}
#canvas{
  width:880px !important;
  height:620px !important;
  position:relative !important;
  transform:none !important;
}
</style>


<style>
/* === FIX OVERLAY BLOCKING CLICKS === */
.canvas-overlay,
.visual-overlay,
.guide-overlay,
.stage-overlay {
  pointer-events: none !important;
}
</style>

</head>

<body data-theme="dark">
  <div class="app">
    <!-- TOP BAR (fixed alignment + visible) -->
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <b>Templify Editor</b>
          <span id="docTitle">Untitled</span>
        </div>
      </div>

      <div class="tools" role="toolbar" aria-label="Editor toolbar">
        <button class="btn tiny" id="backBtn" type="button">‚Üê Back</button>
        <button class="btn tiny" id="themeBtn" type="button">üåó Theme</button>
        <span class="pill" id="autosavePill">Autosave ON</span>

        <button class="btn tiny" id="selectBtn" type="button">üñ± Select</button>
        <button class="btn tiny" id="addBtn" type="button">Ôºã Add</button>
        <button class="btn tiny" id="duplicateBtn" type="button">‚éò Duplicate</button>
        <button class="btn tiny" id="deleteBtn" type="button">üóë Delete</button>

        <button class="btn tiny" id="undoBtn" type="button">‚Ü∂ Undo</button>
        <button class="btn tiny" id="redoBtn" type="button">‚Ü∑ Redo</button>

        
        
        

        
        <button class="btn tiny primary" id="exportBtn" type="button">‚¨á Export</button>
<button class="btn tiny" id="importBtn" type="button">‚¨Ü Import</button>
      </div>

      <div class="righttools">
        
    <button class="btn tiny" id="helpj" title="Shortcuts:
Shift+Click = Multi-select
Ctrl+D = Duplicate
Ctrl+Z / Ctrl+Y = Undo / Redo">‚å®</button>
    
      </div>
    </div>

    <div class="work canvaWork">
  <!-- LEFT ICON RAIL (Canva-style) -->
  <aside class="rail" id="rail">
    <button class="railBtn active" data-mode="design" title="Design / Templates">üé®</button>
    <button class="railBtn" data-mode="elements" title="Elements">‚¨ö</button>
    <button class="railBtn" data-mode="text" title="Text">T</button>
    <button class="railBtn" data-mode="uploads" title="Uploads">‚¨Ü</button>
    <button class="railBtn" data-mode="projects" title="Projects">‚ñ¶</button>
  </aside>

  <!-- LEFT SIDEBAR (single panel; switches modes incl. Properties) -->
  <aside class="sidePanel" id="sidePanel">
    <div class="panelHeader" id="sideHeader">
      <b id="sideTitle">Design</b>
      <div class="seg" id="sideTabs">
        <div class="chip active" data-tab="templates">Templates</div>
        <div class="chip" data-tab="layers">Layers</div>
        <div class="chip" data-tab="assets">Assets</div>
      </div>
    </div>
    <div class="panelBody" id="sideBody">
      <input class="search" id="leftSearch" placeholder="Search‚Ä¶" />
      <div class="list" id="leftList"></div>
    </div>
  </aside>

  <!-- CENTER STAGE -->
  <main class="stage" id="stage">
    <div class="canvasWrap">
      <div class="canvas" id="canvas">
        <div class="gridOverlay" id="gridOverlay"></div>
      </div>
    </div>
  </main>

  <!-- Hidden original right panel kept for logic + DOM moving -->
  <aside class="panel right hidden" id="rightPanel">
    <div class="panelHeader">
      <b>Properties</b>
      <div class="seg" id="rightTabs">
        <div class="chip active" data-tab="props">Selected</div>
        <div class="chip" data-tab="doc">Document</div>
        <div class="chip" data-tab="smart">Smart</div>
      </div>
    </div>
    <div class="panelBody" id="rightPanelBody">
      <!-- (Content will be injected by existing editor JS below in the file) -->
    </div>
  </aside>
</div>

<!-- DISABLED: REPLACED SCRIPT -->

<script>
/* === Canva clone: left sidebar modes + selection->properties === */
(function(){
  // Rail mode switching (visual only; keeps existing leftList population)
  const rail = document.getElementById('rail');
  const sideTitle = document.getElementById('sideTitle');
  const sideTabs = document.getElementById('sideTabs');
  const sideBody = document.getElementById('sideBody');
  const leftSearch = document.getElementById('leftSearch');
  const leftList = document.getElementById('leftList');

  // Keep references to original properties panel DOM (already built by existing code later)
  const rightPanel = document.getElementById('rightPanel');

  function setRailActive(mode){
    rail?.querySelectorAll('.railBtn')?.forEach(b=>{
      b.classList.toggle('active', b.dataset.mode===mode);
    });
  }

  function showDesignMode(){
    setRailActive('design');
    sideTitle.textContent = 'Design';
    sideTabs.classList.remove('hidden');
    // Ensure search + list visible
    if(leftSearch) leftSearch.classList.remove('hidden');
    if(leftList) leftList.classList.remove('hidden');
    // If we previously moved property UI into sidebar, move it back to hidden right panel
    const propsRoot = document.getElementById('propsRoot');
    if(propsRoot && rightPanel){
      // return to rightPanelBody if present
      const host = document.getElementById('rightPanelBody') || rightPanel.querySelector('.panelBody');
      if(host && !host.contains(propsRoot)) host.appendChild(propsRoot);
    }
  }

  function showPropertiesMode(){
    setRailActive('design'); // Canva keeps "Design" highlighted; we keep rail stable
    sideTitle.textContent = 'Position'; // Canva shows contextual label; "Position" is common
    sideTabs.classList.add('hidden');
    if(leftSearch) leftSearch.classList.add('hidden');
    if(leftList) leftList.classList.add('hidden');

    // Move properties UI into sidebar body (no duplicates)
    const host = sideBody;
    if(!host) return;
    // Find the existing properties UI (created by your editor code). We'll wrap it once as #propsRoot.
    let propsRoot = document.getElementById('propsRoot');
    if(!propsRoot){
      // Try common containers in current editor
      propsRoot =
        document.querySelector('#rightPanel .pane')?.parentElement ||
        document.querySelector('#rightPanel .propGrid')?.closest('.pane') ||
        document.querySelector('#rightPanel .panelBody');
      if(propsRoot){
        // Ensure stable id by wrapping children
        const wrapper = document.createElement('div');
        wrapper.id = 'propsRoot';
        // move all children of panelBody into wrapper
        const body = document.getElementById('rightPanelBody') || document.querySelector('#rightPanel .panelBody');
        if(body){
          while(body.firstChild) wrapper.appendChild(body.firstChild);
          body.appendChild(wrapper);
          propsRoot = wrapper;
        }else{
          propsRoot.id = 'propsRoot';
        }
      }
    }
    if(propsRoot && !host.contains(propsRoot)){
      host.appendChild(propsRoot);
    }
  }

  // Public-ish hooks for existing editor logic (non-breaking)
  window.__NEXORA_CANVA_CLONE__ = { showDesignMode, showPropertiesMode };

  // Click handling for rail
  rail?.addEventListener('click', (e)=>{
    const btn = e.target.closest('.railBtn');
    if(!btn) return;
    // For now only 'design' is functional; others are placeholders but keep Canva feel
    showDesignMode();
  });

  // Auto-switch to properties when selection changes:
  // Existing code often updates "selectedIds" or calls updateUI/renderAll.
  // We'll monkeypatch updateUI if present.
  const prevUpdateUI = window.updateUI;
  if(typeof prevUpdateUI === 'function'){
    window.updateUI = function(){
      const r = prevUpdateUI.apply(this, arguments);
      try{
        // If any element has .selected class, show properties; else show design.
        const hasSel = !!document.querySelector('#canvas .selected');
        if(hasSel) showPropertiesMode(); else showDesignMode();
      }catch{}
      return r;
    }
  } else {
    // Fallback: observe selection class changes
    const canvas = document.getElementById('canvas');
    if(canvas){
      const mo = new MutationObserver(()=>{
        const hasSel = !!canvas.querySelector('.selected');
        if(hasSel) showPropertiesMode(); else showDesignMode();
      });
      mo.observe(canvas, { subtree:true, attributes:true, attributeFilter:['class'] });
    }
  }

  // Start in design mode
  showDesignMode();
})();
</script>

<script>
/* SAFE NO-OP: rail buttons visual only */
(function(){
  const rail = document.getElementById('rail');
  if(!rail) return;
  rail.addEventListener('click', e=>{
    const btn = e.target.closest('.railBtn');
    if(!btn) return;
    rail.querySelectorAll('.railBtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  });
})();
</script>
<script>
/* Nexora Editor Core ‚Äì minimal, non-destructive controller
   Fixes: toolbar buttons + keyboard shortcuts + draft load
   Works with existing DOM (.canvas/#canvas, .el, .selected, #rightPanelBody)
*/
(function(){
  if(window.__NEXORA_EDITOR_CORE_V1__) return;
  window.__NEXORA_EDITOR_CORE_V1__ = true;

  const $ = (s)=>document.querySelector(s);
  const canvasEl = $("#canvas");
  const gridOverlay = $("#gridOverlay");
  const rightPanelBody = $("#rightPanelBody");
  const autosavePill = $("#autosavePill");

  if(!canvasEl){ console.warn("Editor core: #canvas not found"); return; }

  // Theme init
  try{
    const saved = localStorage.getItem("templify_theme");
    if(saved) document.body.setAttribute("data-theme", saved);
  }catch{}

  const KEY_DRAFT = "templify_draft";
  const KEY_SELECTED = "nexora_selected_template_v1";

  const state = {
    canvas: { w: 1080, h: 1080 },
    title: "Untitled",
    elements: [],
    selected: new Set(),
    zoom: 1,
    grid: true,
    history: [],
    future: []
  };

  const uid = () => (globalThis.crypto?.randomUUID?.() || ("id_"+Math.random().toString(16).slice(2)+Date.now().toString(16)));
  const safeParse = (s)=>{ try { return JSON.parse(s); } catch { return null; } };
  const deepClone = (o)=>JSON.parse(JSON.stringify(o));

  function escapeHtml(s){
    return String(s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }

  function snapshot(){
    return {
      canvas: deepClone(state.canvas),
      title: state.title,
      elements: deepClone(state.elements),
      selected: Array.from(state.selected),
      zoom: state.zoom,
      grid: state.grid
    };
  }

  function pushHistory(){
    state.history.push(snapshot());
    if(state.history.length > 60) state.history.shift();
    state.future.length = 0;
  }

  function restore(snap){
    if(!snap) return;
    state.canvas = snap.canvas || state.canvas;
    state.title = snap.title || state.title;
    state.elements = Array.isArray(snap.elements) ? snap.elements : state.elements;
    state.selected = new Set(Array.isArray(snap.selected) ? snap.selected : []);
    state.zoom = Number(snap.zoom || 1);
    state.grid = !!snap.grid;
    applyZoom();
    applyGrid();
    render();
    renderProps();
  }

  function autosave(){
    try{
      const payload = {
        meta: { title: state.title },
        template: { title: state.title, canvas: state.canvas, elements: state.elements },
        createdAt: Date.now()
      };
      localStorage.setItem(KEY_DRAFT, JSON.stringify(payload));
      if(autosavePill){
        autosavePill.textContent = "Saved";
        setTimeout(()=>autosavePill.textContent="Autosave ON", 700);
      }
    }catch{}
  }

  function loadDraft(){
    const draft = safeParse(localStorage.getItem(KEY_DRAFT) || "null");
    const sel = safeParse(localStorage.getItem(KEY_SELECTED) || "null");
    const tpl = (draft && draft.template) ? draft.template : sel;

    if(tpl && Array.isArray(tpl.elements)){
      state.title = tpl.title || "Untitled";
      state.canvas = tpl.canvas || state.canvas;
      state.elements = tpl.elements.map(e=>({
        id: e.id || uid(),
        type: (e.type || "card"),
        x: Number(e.x ?? 80),
        y: Number(e.y ?? 80),
        w: Number(e.w ?? 240),
        h: Number(e.h ?? 120),
        title: String(e.title ?? e.text ?? "Text"),
        subtitle: String(e.subtitle ?? ""),
        bg: e.bg ?? e.fill ?? null,
        color: e.color ?? "rgba(255,255,255,0.92)",
        radius: Number(e.radius ?? 16),
        opacity: Number(e.opacity ?? 1),
        fontSize: Number(e.fontSize ?? e.size ?? 22),
        weight: Number(e.weight ?? 700)
      }));
      state.selected.clear();
    }else{
      state.elements = [{
        id: uid(), type:"text", x:120, y:120, w:420, h:120,
        title:"Click to edit", subtitle:"",
        bg:"rgba(11,95,255,0.18)", color:"rgba(255,255,255,0.92)",
        radius:14, opacity:1, fontSize:28, weight:800
      }];
    }

    const titleChip = $("#docTitle");
    if(titleChip) titleChip.textContent = state.title;

    render();
    renderProps();
  }

  function clearEls(){
    canvasEl.querySelectorAll(".el").forEach(n=>n.remove());
  }

  function render(){
    clearEls();
    state.elements.forEach(e=>{
      const el = document.createElement("div");
      el.className = "el";
      el.dataset.id = e.id;
      el.style.left = e.x + "px";
      el.style.top  = e.y + "px";
      el.style.width  = Math.max(30, e.w) + "px";
      el.style.height = Math.max(20, e.h) + "px";
      el.style.opacity = String(e.opacity ?? 1);
      el.style.borderRadius = (e.radius ?? 14) + "px";

      if(e.type === "text"){
        el.style.background = "rgba(255,255,255,0.06)";
        el.style.borderColor = "rgba(255,255,255,0.14)";
      }else if(e.type === "image"){
        el.style.background = e.bg || "linear-gradient(135deg, rgba(11,95,255,.35), rgba(136,71,255,.25))";
      }else{
        el.style.background = e.bg || "rgba(11,95,255,0.18)";
      }

      el.style.color = e.color || "rgba(255,255,255,0.92)";
      el.style.fontSize = (e.fontSize || 22) + "px";
      el.style.fontWeight = String(e.weight || 700);
      el.style.display = "flex";
      el.style.flexDirection = "column";
      el.style.justifyContent = "center";
      el.style.gap = "4px";

      el.innerHTML = `
        <div style="line-height:1.12; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(e.title||"")}</div>
        ${e.subtitle ? `<div style="font-size:12px; opacity:.72; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(e.subtitle)}</div>` : ``}
      `;

      if(state.selected.has(e.id)) el.classList.add("selected");
      canvasEl.appendChild(el);
    });
  }

  // Selection + drag
  let drag = null;
  const hitIdFromEvent = (ev)=> ev.target?.closest?.(".el")?.dataset?.id || null;

  canvasEl.addEventListener("mousedown", (ev)=>{
    const id = hitIdFromEvent(ev);
    if(!id){
      state.selected.clear();
      render(); renderProps();
      return;
    }
    const isMulti = ev.shiftKey || ev.metaKey || ev.ctrlKey;
    if(!isMulti) state.selected.clear();
    if(state.selected.has(id) && isMulti) state.selected.delete(id);
    else state.selected.add(id);

    render(); renderProps();

    if(state.selected.size === 1){
      const e = state.elements.find(x=>x.id===id);
      if(!e) return;
      pushHistory();
      drag = { id, sx: ev.clientX, sy: ev.clientY, ox: e.x, oy: e.y };
      ev.preventDefault();
    }
  });

  window.addEventListener("mousemove", (ev)=>{
    if(!drag) return;
    const e = state.elements.find(x=>x.id===drag.id);
    if(!e) return;
    const dx = (ev.clientX - drag.sx) / state.zoom;
    const dy = (ev.clientY - drag.sy) / state.zoom;
    e.x = Math.round(drag.ox + dx);
    e.y = Math.round(drag.oy + dy);
    render();
  });

  window.addEventListener("mouseup", ()=>{
    if(drag){ drag = null; autosave(); }
  });

  // Properties
  function renderProps(){
    if(!rightPanelBody) return;
    rightPanelBody.innerHTML = "";
    if(state.selected.size !== 1){
      const msg = document.createElement("div");
      msg.style.color = "var(--muted)";
      msg.style.fontSize = "12px";
      msg.textContent = state.selected.size ? "Multiple selected (Shift+Click). Use toolbar to duplicate/delete." : "No selection. Click an element to edit.";
      rightPanelBody.appendChild(msg);
      return;
    }
    const id = Array.from(state.selected)[0];
    const e = state.elements.find(x=>x.id===id);
    if(!e) return;

    const wrap = document.createElement("div");
    wrap.className = "propGrid";
    wrap.innerHTML = `
      <div class="field"><label>Title</label><input id="propTitle" value="${escapeHtml(e.title||"")}" /></div>
      <div class="field"><label>Subtitle</label><input id="propSub" value="${escapeHtml(e.subtitle||"")}" /></div>
      <div class="row2">
        <div class="field"><label>X</label><input id="propX" type="number" value="${e.x}"></div>
        <div class="field"><label>Y</label><input id="propY" type="number" value="${e.y}"></div>
      </div>
      <div class="row2">
        <div class="field"><label>W</label><input id="propW" type="number" value="${e.w}"></div>
        <div class="field"><label>H</label><input id="propH" type="number" value="${e.h}"></div>
      </div>
    `;
    rightPanelBody.appendChild(wrap);

    const bind = (id, fn)=>{
      const inp = $("#"+id);
      if(!inp) return;
      inp.addEventListener("input", ()=>{
        pushHistory();
        fn(inp.value);
        render();
        autosave();
      });
    };
    bind("propTitle", v=> e.title = String(v));
    bind("propSub", v=> e.subtitle = String(v));
    bind("propX", v=> e.x = Number(v)||0);
    bind("propY", v=> e.y = Number(v)||0);
    bind("propW", v=> e.w = Math.max(30, Number(v)||30));
    bind("propH", v=> e.h = Math.max(20, Number(v)||20));
  }

  // Actions
  function addElement(){
    pushHistory();
    const id = uid();
    state.elements.push({
      id, type:"text", x:140, y:140, w:420, h:120,
      title:"New Text", subtitle:"",
      bg:"rgba(11,95,255,0.18)", color:"rgba(255,255,255,0.92)",
      radius:14, opacity:1, fontSize:26, weight:800
    });
    state.selected.clear();
    state.selected.add(id);
    render(); renderProps(); autosave();
  }

  function deleteSelected(){
    if(!state.selected.size) return;
    pushHistory();
    const ids = new Set(state.selected);
    state.elements = state.elements.filter(e=>!ids.has(e.id));
    state.selected.clear();
    render(); renderProps(); autosave();
  }

  function duplicateSelected(){
    if(!state.selected.size) return;
    pushHistory();
    const sel = Array.from(state.selected);
    const clones = [];
    sel.forEach(id=>{
      const e = state.elements.find(x=>x.id===id);
      if(!e) return;
      const c = deepClone(e);
      c.id = uid();
      c.x = Number(c.x||0) + 18;
      c.y = Number(c.y||0) + 18;
      clones.push(c);
    });
    state.elements.push(...clones);
    state.selected = new Set(clones.map(c=>c.id));
    render(); renderProps(); autosave();
  }

  function undo(){
    const prev = state.history.pop();
    if(!prev) return;
    state.future.push(snapshot());
    restore(prev);
    autosave();
  }

  function redo(){
    const next = state.future.pop();
    if(!next) return;
    state.history.push(snapshot());
    restore(next);
    autosave();
  }

  function exportJSON(){
    try{
      const data = { title: state.title, canvas: state.canvas, elements: state.elements };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type:"application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = (state.title || "templify") + ".json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
    }catch(e){ console.warn("Export failed", e); }
  }

  function applyGrid(){
    if(!gridOverlay) return;
    gridOverlay.style.display = state.grid ? "block" : "none";
  }
  function toggleGrid(){ state.grid = !state.grid; applyGrid(); }

  function applyZoom(){
    canvasEl.style.transformOrigin = "center";
    canvasEl.style.transform = "scale(" + state.zoom.toFixed(3) + ")";
  }
  function zoomIn(){ state.zoom = Math.min(3, Math.round((state.zoom + 0.1)*10)/10); applyZoom(); }
  function zoomOut(){ state.zoom = Math.max(0.2, Math.round((state.zoom - 0.1)*10)/10); applyZoom(); }

  window.Editor = { state, addElement, deleteSelected, duplicateSelected, undo, redo, export: exportJSON, toggleGrid, zoomIn, zoomOut };

  // Toolbar wiring
  $("#backBtn")?.addEventListener("click", ()=>{ window.location.href="index.html"; });
  $("#themeBtn")?.addEventListener("click", ()=>{
    const cur = document.body.getAttribute("data-theme") || "dark";
    const next = cur === "dark" ? "light" : "dark";
    document.body.setAttribute("data-theme", next);
    localStorage.setItem("templify_theme", next);
  });
  $("#addBtn")?.addEventListener("click", addElement);
  $("#deleteBtn")?.addEventListener("click", deleteSelected);
  $("#duplicateBtn")?.addEventListener("click", duplicateSelected);
  $("#undoBtn")?.addEventListener("click", undo);
  $("#redoBtn")?.addEventListener("click", redo);
  $("#exportBtn")?.addEventListener("click", exportJSON);
  $("#toggleGridBtn")?.addEventListener("click", toggleGrid);
  $("#zoomInBtn")?.addEventListener("click", zoomIn);
  $("#zoomOutBtn")?.addEventListener("click", zoomOut);
  $("#selectBtn")?.addEventListener("click", ()=>{
    $("#selectBtn")?.classList.add("primary");
    setTimeout(()=>$("#selectBtn")?.classList.remove("primary"), 220);
  });

  // Shortcuts
  window.addEventListener("keydown", (ev)=>{
    const tag = (ev.target && ev.target.tagName) ? ev.target.tagName.toLowerCase() : "";
    const typing = tag === "input" || tag === "textarea" || ev.target?.isContentEditable;
    const mod = ev.ctrlKey || ev.metaKey;

    if(!typing){
      if(ev.key === "Delete" || ev.key === "Backspace"){ deleteSelected(); ev.preventDefault(); return; }
      if(mod && (ev.key === "d" || ev.key === "D")){ duplicateSelected(); ev.preventDefault(); return; }
    }
    if(mod && (ev.key === "z" || ev.key === "Z")){ (ev.shiftKey ? redo() : undo()); ev.preventDefault(); return; }
    if(mod && (ev.key === "y" || ev.key === "Y")){ redo(); ev.preventDefault(); return; }
    if(mod && (ev.key === "s" || ev.key === "S")){ exportJSON(); ev.preventDefault(); return; }
    if(mod && (ev.key === "=" || ev.key === "+")){ zoomIn(); ev.preventDefault(); return; }
    if(mod && ev.key === "-"){ zoomOut(); ev.preventDefault(); return; }
    if(mod && (ev.key === "g" || ev.key === "G")){ toggleGrid(); ev.preventDefault(); return; }
  });

  // Init
  applyGrid();
  applyZoom();
  loadDraft();
  console.log("Nexora Editor Core V1 loaded ‚úî");
})();
</script>


<script>
/* === IMPORT IMAGE (LOCKED FILE SAFE ADDITION) === */
(function(){
  if(window.__IMPORT_IMAGE_V1__) return;
  window.__IMPORT_IMAGE_V1__ = true;

  const btn = document.getElementById("importBtn");
  if(!btn || !window.Editor) return;

  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.style.display = "none";
  document.body.appendChild(input);

  btn.addEventListener("click", ()=> input.click());

  input.addEventListener("change", ()=>{
    const file = input.files && input.files[0];
    if(!file) return;

    const url = URL.createObjectURL(file);

    const id = crypto.randomUUID ? crypto.randomUUID() : "img_"+Date.now();

    Editor.state.elements.push({
      id,
      type: "image",
      x: 160,
      y: 160,
      w: 320,
      h: 220,
      title: "",
      subtitle: "",
      bg: `url(${url}) center/cover no-repeat`,
      color: "transparent",
      radius: 14,
      opacity: 1,
      fontSize: 0,
      weight: 0
    });

    Editor.state.selected.clear();
    Editor.state.selected.add(id);

    Editor.state.history.push(JSON.parse(JSON.stringify(Editor.state)));
    Editor.state.future.length = 0;

    Editor.state.zoom = Editor.state.zoom; // no-op, preserve state
    document.getElementById("canvas").style.transform = document.getElementById("canvas").style.transform;

    document.getElementById("canvas").dispatchEvent(new Event("refresh"));

    if(typeof window.updateUI === "function") updateUI();
  });
})();
</script>

</body>
</html>
