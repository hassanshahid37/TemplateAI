<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Templify – Ultimate Editor v1</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- KEEP YOUR EXISTING CSS EXACTLY AS YOU HAVE IT ABOVE THIS POINT -->
  <!-- I am not changing your UI/CSS here. Paste your full original CSS block unchanged. -->

</head>

<body data-theme="dark">
  <!-- KEEP YOUR EXISTING HTML STRUCTURE EXACTLY AS YOU HAVE IT -->

  <!-- IMPORTANT: paste your existing editor HTML layout here, unchanged -->
  <!-- (topbar, panels, canvas, etc.) -->

<script>
(() => {
  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => [...el.querySelectorAll(s)];

  // Theme
  const savedTheme = localStorage.getItem("templify_theme");
  if(savedTheme==="light"||savedTheme==="dark") document.body.setAttribute("data-theme", savedTheme);

  function setTheme(next){
    document.body.setAttribute("data-theme", next);
    localStorage.setItem("templify_theme", next);
  }

  // Draft meta from index
  let draft = null;
  try{ draft = JSON.parse(localStorage.getItem("templify_draft")||"null"); }catch(e){}
  const title = draft?.meta?.cat ? `${draft.meta.cat} • ${draft.meta.style || "Style"}` : "Untitled";
  $("#docTitle").textContent = title;

  // State
  const canvas = $("#canvas");
  const stage = $("#stage");
  const gridOverlay = $("#gridOverlay");
  let zoom = 1;
  let gridOn = true;

  const state = {
    elements: [],
    selectedIds: new Set(),
    history: [],
    future: [],
    autosave: true,
  };

  // Helpers
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

  function snapshot(){
    const snap = JSON.stringify({
      elements: state.elements,
      selected: [...state.selectedIds],
      zoom, gridOn
    });
    state.history.push(snap);
    if(state.history.length>100) state.history.shift();
    state.future.length = 0;
  }

  function restore(snap){
    const obj = JSON.parse(snap);
    state.elements = obj.elements || [];
    state.selectedIds = new Set(obj.selected || []);
    zoom = obj.zoom ?? zoom;
    gridOn = obj.gridOn ?? gridOn;
    renderAll();
    updateUI();
  }

  function autosave(){
    if(!state.autosave) return;
    const payload = {
      v: 1,
      savedAt: Date.now(),
      docTitle: $("#docTitle").textContent,
      elements: state.elements
    };
    localStorage.setItem("templify_autosave", JSON.stringify(payload));
    $("#autosavePill").textContent = "Autosave ON";
  }

  let autosaveTimer = null;
  function scheduleAutosave(){
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(autosave, 250);
  }

  // Init content
  function addElement(x=80, y=80, w=260, h=130, title="Premium Title", sub="Add your text here…"){
    const id = uid();
    state.elements.push({ id, x, y, w, h, title, sub });
    snapshot();
    renderAll();
    selectOnly(id);
    scheduleAutosave();
  }

  function loadAutosaveOrSeed(){
    let saved = null;
    try{ saved = JSON.parse(localStorage.getItem("templify_autosave")||"null"); }catch(e){}
    if(saved?.elements?.length){
      state.elements = saved.elements;
      snapshot();
      renderAll();
      state.selectedIds.clear();
      updateUI();
      $("#autosavePill").textContent = "Autosave ON";
      return;
    }

    // ✅ NEW: if AI passed a real template with elements, load it
    if(draft?.template?.elements && Array.isArray(draft.template.elements) && draft.template.elements.length){
      state.elements = draft.template.elements.map((e)=>({
        id: uid(),
        x: Number(e.x ?? 80),
        y: Number(e.y ?? 80),
        w: Number(e.w ?? 260),
        h: Number(e.h ?? 130),
        title: String(e.title ?? "Premium Title"),
        sub: String(e.sub ?? "Add your text here…"),
      }));
      snapshot();
      renderAll();
      state.selectedIds.clear();
      updateUI();
      return;
    }

    // Seed (your original)
    addElement(90, 92, 320, 150, draft?.meta?.notes ? draft.meta.notes.slice(0,32) : "Luxury Template", "Drag, resize, duplicate…");
    addElement(470, 210, 360, 170, "Modern Card", "Click elements to edit properties.");
  }

  // Render
  function renderAll(){
    const kids = [...canvas.children].filter(n => n !== gridOverlay);
    kids.forEach(n => n.remove());
    gridOverlay.style.display = gridOn ? "block" : "none";
    canvas.style.transform = `scale(${zoom})`;
    canvas.style.width = `${980}px`;
    canvas.style.height = `${620}px`;

    for(const el of state.elements){
      const div = document.createElement("div");
      div.className = "el";
      div.dataset.id = el.id;
      div.style.left = el.x + "px";
      div.style.top = el.y + "px";
      div.style.width = el.w + "px";
      div.style.height = el.h + "px";
      div.innerHTML = `<h4>${escapeHtml(el.title)}</h4><p>${escapeHtml(el.sub)}</p>`;
      if(state.selectedIds.has(el.id)) div.classList.add("selected");
      canvas.appendChild(div);
      wireElement(div);
    }
  }

  function escapeHtml(str){
    return String(str??"").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

  function updateUI(){
    $("#zoomPill").textContent = Math.round(zoom*100) + "%";
    gridOverlay.style.display = gridOn ? "block" : "none";

    const sel = getSingleSelected();
    if(!sel){
      $("#propX").value = "";
      $("#propY").value = "";
      $("#propW").value = "";
      $("#propH").value = "";
      $("#propTitle").value = "";
      $("#propSub").value = "";
      return;
    }
    $("#propX").value = sel.x;
    $("#propY").value = sel.y;
    $("#propW").value = sel.w;
    $("#propH").value = sel.h;
    $("#propTitle").value = sel.title;
    $("#propSub").value = sel.sub;
  }

  function getById(id){ return state.elements.find(e => e.id === id); }
  function getSingleSelected(){
    const ids = [...state.selectedIds];
    if(ids.length !== 1) return null;
    return getById(ids[0]) || null;
  }

  function selectOnly(id){
    state.selectedIds.clear();
    state.selectedIds.add(id);
    renderAll();
    updateUI();
  }

  function toggleSelect(id){
    if(state.selectedIds.has(id)) state.selectedIds.delete(id);
    else state.selectedIds.add(id);
    renderAll();
    updateUI();
  }

  function wireElement(div){
    div.addEventListener("mousedown", (e)=>{
      const id = div.dataset.id;
      const multi = e.shiftKey;
      if(!multi) selectOnly(id);
      else toggleSelect(id);
    });
  }

  function deleteSelected(){
    const ids = new Set(state.selectedIds);
    if(ids.size===0) return;
    state.elements = state.elements.filter(e => !ids.has(e.id));
    state.selectedIds.clear();
    snapshot();
    renderAll();
    updateUI();
    scheduleAutosave();
  }

  function duplicateSelected(){
    const ids = [...state.selectedIds];
    if(ids.length===0) return;
    const newIds = [];
    for(const id of ids){
      const src = getById(id);
      if(!src) continue;
      const copy = { ...src, id: uid(), x: src.x + 24, y: src.y + 24 };
      state.elements.push(copy);
      newIds.push(copy.id);
    }
    snapshot();
    state.selectedIds = new Set(newIds);
    renderAll();
    updateUI();
    scheduleAutosave();
  }

  function setZoom(z){
    zoom = Math.max(0.35, Math.min(2.2, z));
    renderAll();
    updateUI();
  }

  function undo(){
    if(state.history.length<=1) return;
    const cur = state.history.pop();
    state.future.push(cur);
    const prev = state.history[state.history.length-1];
    restore(prev);
    scheduleAutosave();
  }

  function redo(){
    if(state.future.length===0) return;
    const snap = state.future.pop();
    state.history.push(snap);
    restore(snap);
    scheduleAutosave();
  }

  // Toolbar wiring (keep your existing button IDs)
  $("#backBtn")?.addEventListener("click", ()=>{ window.location.href = "index.html"; });
  $("#themeBtn")?.addEventListener("click", ()=>{
    const cur = document.body.getAttribute("data-theme") || "dark";
    setTheme(cur==="dark" ? "light" : "dark");
    renderAll();
  });

  $("#deleteBtn")?.addEventListener("click", deleteSelected);
  $("#duplicateBtn")?.addEventListener("click", duplicateSelected);
  $("#undoBtn")?.addEventListener("click", undo);
  $("#redoBtn")?.addEventListener("click", redo);
  $("#zoomInBtn")?.addEventListener("click", ()=>setZoom(zoom+0.1));
  $("#zoomOutBtn")?.addEventListener("click", ()=>setZoom(zoom-0.1));
  $("#toggleGridBtn")?.addEventListener("click", ()=>{
    gridOn = !gridOn;
    renderAll();
    updateUI();
  });

  // Boot
  snapshot();
  loadAutosaveOrSeed();
  updateUI();
})();
</script>

</body>
</html>
