

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Templify ‚Äì Ultimate Editor v1</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#0b5fff;
      --muted:#aab0bd;

      --bg:#050712;
      --panel:rgba(15,18,32,.58);
      --panel2:rgba(15,18,32,.36);
      --stroke:rgba(255,255,255,.10);
      --text:#f6f7fb;

      --shadow:0 18px 50px rgba(0,0,0,.45);
      --radius:18px;

      --topH:58px;
      --leftW: 220px;
      --rightW: 240px;
    }
    [data-theme="light"]{
      --bg:#f5f7ff;
      --panel:rgba(255,255,255,.76);
      --panel2:rgba(255,255,255,.55);
      --stroke:rgba(10,20,60,.12);
      --text:#0b1020;
      --shadow:0 18px 40px rgba(10,20,60,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(11,95,255,.22), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(136,71,255,.18), transparent 55%),
        radial-gradient(900px 600px at 35% 95%, rgba(0,225,255,.10), transparent 55%),
        var(--bg);
      overflow:hidden;
    }

    /* Layout */
    .app{
      height:100%;
      display:grid;
      grid-template-rows: var(--topH) 1fr;
      grid-template-columns: 1fr;
    }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid var(--stroke);
      background:var(--panel);
      backdrop-filter: blur(16px);
      box-shadow: 0 8px 26px rgba(0,0,0,.25);
      position:sticky;top:0;z-index:50;
    }

    .brand{
      display:flex;align-items:center;gap:10px;min-width:210px;
    }
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:linear-gradient(135deg, rgba(11,95,255,.95), rgba(136,71,255,.88));
      box-shadow:0 10px 26px rgba(11,95,255,.22);
      border:1px solid rgba(255,255,255,.16);
      flex:0 0 auto;
    }
    .brand b{font-size:13px;letter-spacing:.2px}
    .brand span{display:block;font-size:11px;color:var(--muted);margin-top:1px}
    .pill{
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background:var(--panel2);
      color:var(--muted);
      font-size:11px;
      white-space:nowrap;
    }

    .tools{
      display:flex;align-items:center;gap:8px;
      flex: 1 1 auto;
      min-width: 260px;
      overflow:auto;
      padding:2px 0;
    }
    .tools::-webkit-scrollbar{height:8px}
    .tools::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}
    [data-theme="light"] .tools::-webkit-scrollbar-thumb{background:rgba(10,20,60,.14)}
    .btn{
      appearance:none;
      border:1px solid var(--stroke);
      background:var(--panel2);
      color:var(--text);
      padding:9px 10px;
      border-radius:14px;
      font-weight:600;
      font-size:12px;
      cursor:pointer;
      transition:.15s ease;
      backdrop-filter: blur(16px);
      display:inline-flex;align-items:center;gap:8px;
      white-space:nowrap;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(11,95,255,.35)}
    .btn:active{transform:translateY(0px)}
    .btn.primary{
      background:linear-gradient(135deg, rgba(11,95,255,.95), rgba(136,71,255,.85));
      border-color:rgba(255,255,255,.14);
      box-shadow:0 12px 30px rgba(11,95,255,.18);
    }
    .btn.danger{border-color:rgba(255,80,120,.35)}
    .btn.tiny{padding:7px 10px;font-size:11.5px;border-radius:12px}
    .righttools{
      max-width:140px;
      overflow:hidden;

      display:flex;align-items:center;gap:8px;flex:0 0 auto;
    }
    .kbd{
      max-width:200px;
      overflow:hidden;
      white-space:normal;
      word-break:break-word;

      max-width:260px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:normal;
      line-height:1.4;

      font-size:10.5px;color:var(--muted);
      padding:6px 10px;border:1px solid var(--stroke);
      background:var(--panel2);border-radius:999px;
      white-space:nowrap;
      display:flex;align-items:center;gap:8px;
    }

    /* Work area */
    .work{
      display:grid;
      grid-template-columns: var(--leftW) 8px 1fr 8px var(--rightW);
      height:100%;
      overflow:hidden;
    }

    .panel{
      border-right:1px solid var(--stroke);
      background:var(--panel);
      backdrop-filter: blur(16px);
      overflow:hidden;
      min-width: 220px;
    }
    .panel.right{
      border-right:none;border-left:1px solid var(--stroke);
      min-width: 260px;
    }

    .panelHeader{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--stroke);
      display:flex;align-items:center;justify-content:space-between;gap:8px;
    }
    .panelHeader b{font-size:12.5px}
    .panelHeader .seg{
      display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;
    }
    .seg .chip{
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background:var(--panel2);
      color:var(--muted);
      font-size:11px;
      cursor:pointer;
      user-select:none;
    }
    .seg .chip.active{
      color:var(--text);
      border-color:rgba(11,95,255,.40);
      box-shadow:0 10px 24px rgba(11,95,255,.10);
    }

    .panelBody{padding:12px;overflow:auto;height:calc(100% - 52px)}
    .panelBody::-webkit-scrollbar{width:10px}
    .panelBody::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}
    [data-theme="light"] .panelBody::-webkit-scrollbar-thumb{background:rgba(10,20,60,.14)}

    .search{
      width:100%;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.12);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      outline:none;
      margin-bottom:10px;
    }
    [data-theme="light"] .search{background:rgba(255,255,255,.55)}

    .list{display:grid;gap:10px}
    .item{
      border:1px solid var(--stroke);
      background:var(--panel2);
      border-radius:16px;
      padding:10px;
      cursor:pointer;
      transition:.12s ease;
    }
    .item:hover{transform:translateY(-1px);border-color:rgba(11,95,255,.30)}
    .item b{display:block;font-size:12.5px}
    .item span{display:block;font-size:12px;color:var(--muted);margin-top:3px;line-height:1.35}

    .splitter{
      cursor:col-resize;
      background:transparent;
      position:relative;
    }
    .splitter::after{
      content:"";
      position:absolute;left:50%;top:10px;bottom:10px;
      width:2px;transform:translateX(-50%);
      background:rgba(255,255,255,.10);
      border-radius:999px;
    }
    [data-theme="light"] .splitter::after{background:rgba(10,20,60,.12)}

    /* Canvas */
    .stage{
  position: relative;
  overflow: hidden;
  background: transparent;
  display:flex;
  align-items:center;
  justify-content:center;
  height: 100%;
}
    .stage::-webkit-scrollbar{width:12px;height:12px}
    .stage::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}
    [data-theme="light"] .stage::-webkit-scrollbar-thumb{background:rgba(10,20,60,.14)}

    .canvasWrap{
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
}
    .canvas{
      width: 980px;
      height: 620px;
      aspect-ratio: 980 / 620;
      max-width: calc(100% - 24px);
      max-height: calc(100% - 24px);
      border-radius: 18px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)),
        rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 22px 70px rgba(0,0,0,.45);
      position:relative;
      transform-origin: center;
}
    }
    [data-theme="light"] .canvas{
      background:
        linear-gradient(180deg, rgba(10,20,60,.05), rgba(10,20,60,.02)),
        rgba(255,255,255,.85);
      border:1px solid rgba(10,20,60,.12);
      box-shadow: 0 18px 55px rgba(10,20,60,.20);
    }

    .gridOverlay{
      position:absolute;inset:0;border-radius:18px;
      background-image:
        linear-gradient(to right, rgba(255,255,255,.07) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.07) 1px, transparent 1px);
      background-size: 24px 24px;
      opacity:.55;
      pointer-events:none;
      mix-blend-mode: overlay;
    }
    [data-theme="light"] .gridOverlay{
      background-image:
        linear-gradient(to right, rgba(10,20,60,.08) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(10,20,60,.08) 1px, transparent 1px);
      opacity:.45;
      mix-blend-mode: multiply;
    }

    .el{
      position:absolute;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.15);
      background: rgba(11,95,255,.18);
      color: var(--text);
      padding: 10px 12px;
      min-width: 120px;
      cursor: pointer;
      user-select:none;
      box-shadow:0 14px 38px rgba(0,0,0,.25);
    }
    .el h4{margin:0;font-size:14px;line-height:1.2}
    .el p{margin:6px 0 0;font-size:12px;color:rgba(255,255,255,.85);line-height:1.35}
    [data-theme="light"] .el{
      background: rgba(11,95,255,.10);
      border:1px solid rgba(10,20,60,.12);
      box-shadow:0 12px 28px rgba(10,20,60,.16);
    }
    [data-theme="light"] .el p{color:rgba(10,20,60,.82)}

    .selected{outline:2px solid rgba(11,95,255,.95); outline-offset:2px}

    /* Properties */
    .propGrid{display:grid;gap:10px}
    .field label{display:block;font-size:11.5px;color:var(--muted);margin:0 0 6px}
    .field input,.field select{
      width:100%;padding:10px 12px;border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.12);
      color:var(--text);outline:none;
    }
    [data-theme="light"] .field input,
    [data-theme="light"] .field select{background:rgba(255,255,255,.55)}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    .miniHelp{
      font-size:11px;color:var(--muted);line-height:1.45;
      border:1px solid var(--stroke);
      background:var(--panel2);
      border-radius:16px;padding:10px;margin-top:10px;
    }

    .hidden{ display:none !important; }
    .actionsRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .actionsRow .btn{ flex:0 0 auto; }

    /* Responsive */
    
    @media (max-width: 1120px){
      .kbd{display:none;}

      :root{ --leftW: 220px; --rightW: 240px; }
      .canvas{width: 900px;}
    }
    @media (max-width: 980px){
      .work{grid-template-columns: 1fr;}
      .panel,.splitter{display:none}
      .stage{padding:14px}
      .canvas{width: min(920px, 100%); height: 560px;}
      .tools{min-width: 1px}
    }
  
    /* === Canva-style layout clone (non-destructive) === */
    .work.canvaWork{
      display:grid;
      grid-template-columns: 72px 260px minmax(0,1fr);
      height:100%;
      overflow:hidden;
      gap:0;
    }
    .rail{
      border-right:1px solid var(--stroke);
      background:var(--panel);
      backdrop-filter: blur(16px);
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:10px 8px;
      gap:10px;
    }
    .railBtn{
      width:44px;height:44px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:var(--panel2);
      color:var(--text);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      transition:.15s ease;
      user-select:none;
    }
    .railBtn:hover{transform:translateY(-1px);border-color:rgba(11,95,255,.35)}
    .railBtn.active{
      background:linear-gradient(135deg, rgba(11,95,255,.95), rgba(136,71,255,.85));
      border-color:rgba(255,255,255,.14);
      box-shadow:0 12px 30px rgba(11,95,255,.16);
    }
    .sidePanel{
      border-right:1px solid var(--stroke);
      background:var(--panel);
      backdrop-filter: blur(16px);
      overflow:hidden;
      min-width:260px;
    }
    /* Hide old splitters/left panel styling if any leftover rules expect them */
    .splitter,.panel.left{display:none !important;}
    /* Stage gets all remaining space */
    .work.canvaWork .stage{padding:0; overflow:hidden;}

</style>



<style>
/* === NEW CANVAS SYSTEM (REPLACED) === */
.stage{
  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
  overflow:hidden !important;
}
.canvasWrap{
  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
  min-height:100% !important;
}
#canvas{
  width:880px !important;
  height:620px !important;
  position:relative !important;
  transform:none !important;
}
</style>

</head>

<body data-theme="dark">
  <div class="app">
    <!-- TOP BAR (fixed alignment + visible) -->
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <b>Templify Editor</b>
          <span id="docTitle">Untitled</span>
        </div>
      </div>

      <div class="tools" role="toolbar" aria-label="Editor toolbar">
        <button class="btn tiny" id="backBtn" type="button">‚Üê Back</button>
        <button class="btn tiny" id="themeBtn" type="button">üåó Theme</button>
        <span class="pill" id="autosavePill">Autosave ON</span>

        <button class="btn tiny" id="selectBtn" type="button">üñ± Select</button>
        <button class="btn tiny" id="addBtn" type="button">Ôºã Add</button>
        <button class="btn tiny" id="duplicateBtn" type="button">‚éò Duplicate</button>
        <button class="btn tiny" id="deleteBtn" type="button">üóë Delete</button>

        <button class="btn tiny" id="undoBtn" type="button">‚Ü∂ Undo</button>
        <button class="btn tiny" id="redoBtn" type="button">‚Ü∑ Redo</button>

        <button class="btn tiny" id="zoomOutBtn" type="button">‚àí Zoom</button>
        <button class="btn tiny" id="zoomInBtn" type="button">Ôºã Zoom</button>
        <span class="pill" id="zoomPill">100%</span>

        <button class="btn tiny" id="toggleGridBtn" type="button">‚ñ¶ Grid</button>
        <button class="btn tiny primary" id="exportBtn" type="button">‚¨á Export</button>
      </div>

      <div class="righttools">
        
    <button class="btn tiny" id="helpj" title="Shortcuts:
Shift+Click = Multi-select
Ctrl+D = Duplicate
Ctrl+Z / Ctrl+Y = Undo / Redo">‚å®</button>
    
      </div>
    </div>

    <div class="work canvaWork">
  <!-- LEFT ICON RAIL (Canva-style) -->
  <aside class="rail" id="rail">
    <button class="railBtn active" data-mode="design" title="Design / Templates">üé®</button>
    <button class="railBtn" data-mode="elements" title="Elements">‚¨ö</button>
    <button class="railBtn" data-mode="text" title="Text">T</button>
    <button class="railBtn" data-mode="uploads" title="Uploads">‚¨Ü</button>
    <button class="railBtn" data-mode="projects" title="Projects">‚ñ¶</button>
  </aside>

  <!-- LEFT SIDEBAR (single panel; switches modes incl. Properties) -->
  <aside class="sidePanel" id="sidePanel">
    <div class="panelHeader" id="sideHeader">
      <b id="sideTitle">Design</b>
      <div class="seg" id="sideTabs">
        <div class="chip active" data-tab="templates">Templates</div>
        <div class="chip" data-tab="layers">Layers</div>
        <div class="chip" data-tab="assets">Assets</div>
      </div>
    </div>
    <div class="panelBody" id="sideBody">
      <input class="search" id="leftSearch" placeholder="Search‚Ä¶" />
      <div class="list" id="leftList"></div>
    </div>
  </aside>

  <!-- CENTER STAGE -->
  <main class="stage" id="stage">
    <div class="canvasWrap">
      <div class="canvas" id="canvas">
        <div class="gridOverlay" id="gridOverlay"></div>
      </div>
    </div>
  </main>

  <!-- Hidden original right panel kept for logic + DOM moving -->
  <aside class="panel right hidden" id="rightPanel">
    <div class="panelHeader">
      <b>Properties</b>
      <div class="seg" id="rightTabs">
        <div class="chip active" data-tab="props">Selected</div>
        <div class="chip" data-tab="doc">Document</div>
        <div class="chip" data-tab="smart">Smart</div>
      </div>
    </div>
    <div class="panelBody" id="rightPanelBody">
      <!-- (Content will be injected by existing editor JS below in the file) -->
    </div>
  </aside>
</div>

<script>
(() => {
  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => [...el.querySelectorAll(s)];

  // Theme
  const savedTheme = localStorage.getItem("templify_theme");
  if(savedTheme==="light"||savedTheme==="dark") document.body.setAttribute("data-theme", savedTheme);

  function setTheme(next){
    document.body.setAttribute("data-theme", next);
    localStorage.setItem("templify_theme", next);
  }

  // Draft meta from index (supports both legacy + current keys)
  let draft = null;
  let draftPrompt = "";
  let draftNotes = "";

  // 1) Preferred: settings saved by index
  try{
    const s = JSON.parse(localStorage.getItem("nexora_last_settings_v1")||"null");
    if(s && typeof s === "object"){
      draftPrompt = String(s.prompt||"");
      draftNotes  = String(s.notes||"");
    }
  }catch(e){}

  // 2) Current: selected template saved by index
  try{
    const t = JSON.parse(localStorage.getItem("nexora_selected_template_v1")||"null");
    if(t && typeof t === "object"){
      draft = { template: t, prompt: draftPrompt, notes: draftNotes };
    }
  }catch(e){}

  // 3) Legacy: older key
  if(!draft){
    try{ draft = JSON.parse(localStorage.getItem("templify_draft")||"null"); }catch(e){}
  }
const title = draft?.meta?.cat ? `${draft.meta.cat} ‚Ä¢ ${draft.meta.style || "Style"}` : "Untitled";
  $("#docTitle").textContent = title;

  // State
  const canvas = $("#canvas");
  const stage = $("#stage");
  const gridOverlay = $("#gridOverlay");
  let zoom = 1;
  let gridOn = true;
  let autoFitZoom = true; // keep canvas comfortably inside stage (Canva-like)
  let docW = 980, docH = 620, docBg = "";

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function fitZoomToStage(force=false){
    if(!force && !autoFitZoom) return;
    // stage is the center viewport; leave some padding so doc is smaller than background
    const r = stage.getBoundingClientRect();
    const pad = 46; // visual breathing room
    const availW = Math.max(200, r.width - pad*2);
    const availH = Math.max(200, r.height - pad*2);

    const zW = availW / Math.max(1, docW);
    const zH = availH / Math.max(1, docH);
    const next = clamp(Math.min(zW, zH) * 0.96, 0.08, 1.25);

    if(Number.isFinite(next) && Math.abs(next - zoom) > 0.001){
      zoom = next;
      try{ $("#zoomPill").textContent = Math.round(zoom*100) + "%"; }catch(_){}
    }
  }
const state = {
    elements: [],
    selectedIds: new Set(),
    history: [],
    future: [],
    autosave: true,
  };

  // Load a generated template (if provided by index)
  try{
    if(draft?.template?.elements && Array.isArray(draft.template.elements)){
      state.elements = draft.template.elements.map(e => ({
        id: e.id || uid(),
        x: Number(e.x ?? 80), y: Number(e.y ?? 80),
        w: Number(e.w ?? 420), h: Number(e.h ?? 120),
        title: String(e.title ?? e.text ?? "TEXT"),
        sub: String(e.sub ?? e.subtitle ?? "")
      }));
    }
  }catch(e){}


  // Helpers
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

  function snapshot(){
    const snap = JSON.stringify({
      elements: state.elements,
      selected: [...state.selectedIds],
      zoom, gridOn
    });
    state.history.push(snap);
    if(state.history.length>100) state.history.shift();
    state.future.length = 0;
  }

  function restore(snap){
    const obj = JSON.parse(snap);
    state.elements = obj.elements || [];
    state.selectedIds = new Set(obj.selected || []);
    zoom = obj.zoom ?? zoom;
    gridOn = obj.gridOn ?? gridOn;
    renderAll();
    updateUI();
  }

  function autosave(){
    if(!state.autosave) return;
    const payload = {
      v: 1,
      savedAt: Date.now(),
      docTitle: $("#docTitle").textContent,
      elements: state.elements
    };
    localStorage.setItem("templify_autosave", JSON.stringify(payload));
    $("#autosavePill").textContent = "Autosave ON";
  }

  let autosaveTimer = null;
  function scheduleAutosave(){
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(autosave, 250);
  }

  // Init content
  
  // --- Nexora: load generated templates from index (handoff) ---
  function getDraftTemplatePayload(){
    // draft can be:
    //  A) { template: {meta, template:{elements,canvas}} }   (index handoff wrapper)
    //  B) { template: {elements,canvas} }                   (direct)
    //  C) legacy shapes
    const t = draft?.template || null;
    if(!t || typeof t !== "object") return null;
    if(t.elements && Array.isArray(t.elements)) return t;              // direct
    if(t.template && t.template.elements && Array.isArray(t.template.elements)) return t.template; // wrapped
    return null;
  }

  function normalizeEditorElements(arr){
    // Ensure every element has required geometry + id + type
    const out = [];
    for(const raw of (arr||[])){
      if(!raw || typeof raw !== "object") continue;
      const el = { ...raw };
      el.id = String(el.id || uid());
      el.type = String(el.type || el.kind || el.element || "shape");
      // geometry defaults
      el.x = Number.isFinite(el.x) ? el.x : 0;
      el.y = Number.isFinite(el.y) ? el.y : 0;
      el.w = Number.isFinite(el.w) ? el.w : (Number.isFinite(el.width) ? el.width : 200);
      el.h = Number.isFinite(el.h) ? el.h : (Number.isFinite(el.height) ? el.height : 120);
      // z
      if(!Number.isFinite(el.zIndex) && Number.isFinite(el.z)) el.zIndex = el.z;
      // text fallback
      if(typeof el.text === "string" && typeof el.title !== "string") el.title = el.text;
      if(typeof el.subtitle === "string" && typeof el.sub !== "string") el.sub = el.subtitle;
      if(typeof el.sub !== "string") el.sub = "";
      if(typeof el.title !== "string") el.title = "";
      out.push(el);
    }
    // stable ordering by zIndex then y then x
    out.sort((a,b)=> (Number(a.zIndex||0)-Number(b.zIndex||0)) || (a.y-b.y) || (a.x-b.x));
    return out;
  }
function addElement(x=80, y=80, w=260, h=130, title="Premium Title", sub="Add your text here‚Ä¶"){
    const id = uid();
    state.elements.push({ id, x, y, w, h, title, sub });
    snapshot();
    renderAll();
    selectOnly(id);
    scheduleAutosave();
  }

  function loadAutosaveOrSeed(){
    // 0) If we arrived from Generator, load that template first (ignore autosave)
    const incoming = getDraftTemplatePayload();
    if(incoming?.elements?.length){
      // document size
      if(incoming.canvas && Number.isFinite(incoming.canvas.w) && Number.isFinite(incoming.canvas.h)){
        docW = Math.max(200, Math.floor(incoming.canvas.w));
        docH = Math.max(200, Math.floor(incoming.canvas.h));
      }
      // normalize + load
      state.elements = normalizeEditorElements(incoming.elements);

      // Clear selection and render
      snapshot();
      state.selectedIds.clear();
      fitZoomToStage(true);
      renderAll();
      updateUI();

      // Mark that we loaded a generated template (optional)
      try{ localStorage.setItem("nexora_editor_loaded_v1", String(Date.now())); }catch(e){}
      $("#autosavePill").textContent = "Autosave ON";
      return;
    }

    let saved = null;
    try{ saved = JSON.parse(localStorage.getItem("templify_autosave")||"null"); }catch(e){}
    if(saved?.elements?.length){
      state.elements = saved.elements;
      snapshot();
      fitZoomToStage(true);
      renderAll();
      state.selectedIds.clear();
      updateUI();
      $("#autosavePill").textContent = "Autosave ON";
      return;
    }

    // Seed
    addElement(90, 92, 320, 150, draft?.meta?.notes ? draft.meta.notes.slice(0,32) : "Luxury Template", "Drag, resize, duplicate‚Ä¶");
    addElement(470, 210, 360, 170, "Modern Card", "Click elements to edit properties.");
    fitZoomToStage(true);
    renderAll();
    updateUI();
  }

  // Render
  function renderAll(){
    // Keep grid overlay
    const kids = [...canvas.children].filter(n => n !== gridOverlay);
    kids.forEach(n => n.remove());
    gridOverlay.style.display = gridOn ? "block" : "none";
    canvas.style.transform = `scale(${zoom})`;
    canvas.style.width = `${docW}px`;
    canvas.style.height = `${docH}px`;

    for(const el of state.elements){
      const div = document.createElement("div");
      div.className = "el";
      div.dataset.id = el.id;
      div.style.left = el.x + "px";
      div.style.top = el.y + "px";
      div.style.width = el.w + "px";
      div.style.height = el.h + "px";

      div.style.zIndex = String(el.zIndex ?? el.z ?? 0);

      const t = String(el.type || "card");
      // reset visuals
      div.style.background = "";
      div.style.backgroundImage = "";
      div.style.backgroundSize = "";
      div.style.backgroundPosition = "";
      div.style.border = "";
      div.style.borderRadius = "";
      div.style.boxShadow = "";
      div.style.color = "";
      div.style.display = "";
      div.style.alignItems = "";
      div.style.justifyContent = "";
      div.style.textAlign = "";
      div.style.padding = "";

      if(t === "background"){
        div.innerHTML = "";
        div.style.left = (Number.isFinite(el.x) ? el.x : 0) + "px";
        div.style.top  = (Number.isFinite(el.y) ? el.y : 0) + "px";
        div.style.width  = (Number.isFinite(el.w) ? el.w : docW) + "px";
        div.style.height = (Number.isFinite(el.h) ? el.h : docH) + "px";
        div.style.background = el.gradient || el.fill || el.color || "linear-gradient(135deg,#0a1433,#061022)";
        div.style.borderRadius = (Number.isFinite(el.radius) ? el.radius : 18) + "px";
      } else if(t === "image"){
        div.innerHTML = "";
        const src = el.src || el.url || "";
        if(src) div.style.backgroundImage = `url("${String(src).replace(/"/g,'%22')}")`;
        div.style.backgroundSize = "cover";
        div.style.backgroundPosition = "center";
        div.style.backgroundColor = el.fill || "rgba(255,255,255,0.06)";
        div.style.borderRadius = (Number.isFinite(el.radius) ? el.radius : 18) + "px";
        if(el.stroke) div.style.border = `1px solid ${el.stroke}`;
      } else if(t === "shape"){
        div.innerHTML = "";
        div.style.background = el.gradient || el.fill || el.color || "rgba(255,255,255,0.06)";
        div.style.borderRadius = (Number.isFinite(el.radius) ? el.radius : 18) + "px";
        if(el.stroke) div.style.border = `1px solid ${el.stroke}`;
        if(Number.isFinite(el.opacity)) div.style.opacity = String(el.opacity);
      } else if(t === "heading" || t === "text"){
        const txt = el.text ?? el.title ?? "";
        const sub = el.sub ?? el.subtitle ?? "";
        div.innerHTML = `<div style="font-size:${Number.isFinite(el.fontSize)?el.fontSize: (t==='heading'?44:22)}px; font-weight:${Number.isFinite(el.fontWeight)?el.fontWeight:(t==='heading'?800:500)}; line-height:${Number.isFinite(el.lineHeight)?el.lineHeight:1.1}; letter-spacing:${Number.isFinite(el.letterSpacing)?el.letterSpacing:0}px;">${escapeHtml(txt)}</div>` +
                        (sub ? `<div style="margin-top:10px; font-size:${Math.max(14, Math.round((Number.isFinite(el.fontSize)?el.fontSize:22)*0.55))}px; opacity:0.85;">${escapeHtml(sub)}</div>` : "");
        div.style.background = el.fill || "transparent";
        div.style.color = el.color || "#eaf0ff";
        div.style.padding = (Number.isFinite(el.padding)? el.padding : 18) + "px";
        div.style.borderRadius = (Number.isFinite(el.radius) ? el.radius : 18) + "px";
      } else if(t === "badge"){
        const txt = el.text ?? el.title ?? "BADGE";
        div.innerHTML = `<div style="font-size:${Number.isFinite(el.fontSize)?el.fontSize:14}px; font-weight:${Number.isFinite(el.fontWeight)?el.fontWeight:700}; letter-spacing:${Number.isFinite(el.letterSpacing)?el.letterSpacing:1.2}px; text-transform:uppercase;">${escapeHtml(txt)}</div>`;
        div.style.background = el.fill || "rgba(255,255,255,0.10)";
        div.style.color = el.color || "#eaf0ff";
        div.style.display = "flex";
        div.style.alignItems = "center";
        div.style.justifyContent = "center";
        div.style.textAlign = "center";
        div.style.borderRadius = (Number.isFinite(el.radius) ? el.radius : 999) + "px";
        if(el.stroke) div.style.border = `1px solid ${el.stroke}`;
        if(Number.isFinite(el.opacity)) div.style.opacity = String(el.opacity);
      } else if(t === "cta"){
        const txt = el.text ?? el.title ?? "Shop Now";
        div.innerHTML = `<div style="font-size:${Number.isFinite(el.fontSize)?el.fontSize:16}px; font-weight:${Number.isFinite(el.fontWeight)?el.fontWeight:800};">${escapeHtml(txt)}</div>`;
        div.style.background = el.fill || "#0b5fff";
        div.style.color = el.color || "#ffffff";
        div.style.display = "flex";
        div.style.alignItems = "center";
        div.style.justifyContent = "center";
        div.style.textAlign = "center";
        div.style.borderRadius = (Number.isFinite(el.radius) ? el.radius : 999) + "px";
      } else {
        // Default: existing card behavior
        div.innerHTML = `<h4>${escapeHtml(el.title)}</h4><p>${escapeHtml(el.sub)}</p>`;
      }

      if(el.shadow){
        div.style.boxShadow = String(el.shadow);
      }

      if(state.selectedIds.has(el.id)) div.classList.add("selected");
      canvas.appendChild(div);
      wireElement(div);
    }
  }

  
  // Initial paint
  renderAll();
  updateUI();

function escapeHtml(str){
    return String(str??"").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

  function updateUI(){
    $("#zoomPill").textContent = Math.round(zoom*100) + "%";
    gridOverlay.style.display = gridOn ? "block" : "none";

    const sel = getSingleSelected();
    if(!sel){
      $("#propX").value = "";
      $("#propY").value = "";
      $("#propW").value = "";
      $("#propH").value = "";
      $("#propTitle").value = "";
      $("#propSub").value = "";
      return;
    }
    $("#propX").value = sel.x;
    $("#propY").value = sel.y;
    $("#propW").value = sel.w;
    $("#propH").value = sel.h;
    $("#propTitle").value = sel.title;
    $("#propSub").value = sel.sub;
  }

  function getById(id){ return state.elements.find(e => e.id === id); }
  function getSingleSelected(){
    const ids = [...state.selectedIds];
    if(ids.length !== 1) return null;
    return getById(ids[0]) || null;
  }

  function selectOnly(id){
    state.selectedIds.clear();
    state.selectedIds.add(id);
    renderAll();
    updateUI();
  }

  function toggleSelect(id){
    if(state.selectedIds.has(id)) state.selectedIds.delete(id);
    else state.selectedIds.add(id);
    renderAll();
    updateUI();
  }

  // Element interactions (drag move)
  function wireElement(div){
    div.addEventListener("mousedown", (e)=>{
      e.preventDefault();
      const id = div.dataset.id;
      const multi = e.shiftKey;
      if(multi) toggleSelect(id);
      else if(!state.selectedIds.has(id)) selectOnly(id);

      const startX = e.clientX, startY = e.clientY;
      const ids = [...state.selectedIds];
      const startPos = ids.map(pid => {
        const el = getById(pid);
        return { id: pid, x: el.x, y: el.y };
      });

      const onMove = (ev)=>{
        const dx = (ev.clientX - startX) / zoom;
        const dy = (ev.clientY - startY) / zoom;
        for(const p of startPos){
          const el = getById(p.id);
          el.x = Math.round(p.x + dx);
          el.y = Math.round(p.y + dy);
        }
        renderAll();
        updateUI();
      };
      const onUp = ()=>{
        window.removeEventListener("mousemove", onMove);
        window.removeEventListener("mouseup", onUp);
        snapshot();
        scheduleAutosave();
      };
      window.addEventListener("mousemove", onMove);
      window.addEventListener("mouseup", onUp);
    });
  }

  // Panels tabs content
  const leftData = {
    templates: [
      { t:"Instagram Post", d:"1080√ó1080 modern layout" },
      { t:"YouTube Thumbnail", d:"Bold headline + image zone" },
      { t:"Flyer", d:"A4 / Letter ready for print" },
      { t:"Business Card", d:"Clean premium brand card" },
      { t:"Story", d:"1080√ó1920 vertical" },
    ],
    layers: [],
    assets: [
      { t:"Shapes Pack", d:"Modern blobs & lines" },
      { t:"Gradients", d:"Premium backgrounds" },
      { t:"Icons", d:"Minimal icon set" },
    ]
  };

  function refreshLeft(){
    const active = $("#leftTabs .chip.active")?.dataset.tab || "templates";
    // layers reflect elements
    leftData.layers = state.elements.map((e, idx)=>({ t: e.title || `Layer ${idx+1}`, d: `x:${e.x} y:${e.y} ‚Ä¢ ${e.w}√ó${e.h}` , id: e.id }));
    const q = ($("#leftSearch").value || "").toLowerCase().trim();
    const list = $("#leftList");
    list.innerHTML = "";
    for(const it of leftData[active]){
      const show = !q || (it.t.toLowerCase().includes(q) || it.d.toLowerCase().includes(q));
      if(!show) continue;
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `<b>${escapeHtml(it.t)}</b><span>${escapeHtml(it.d)}</span>`;
      div.addEventListener("click", ()=>{
        if(active === "templates"){
          // load template preset
          if(it.t.includes("Story")) resizeCanvas(900, 1400);
          else if(it.t.includes("Flyer")) resizeCanvas(900, 1200);
          else resizeCanvas(980, 620);
        }else if(active === "layers" && it.id){
          selectOnly(it.id);
        }else if(active === "assets"){
          addElement(120, 120, 260, 120, it.t, it.d);
        }
      });
      list.appendChild(div);
    }
  }

  function resizeCanvas(w,h){
    // simple: change canvas size by modifying base dims used in renderAll
    // We'll store in state as special element? Keep lightweight: store in localStorage
    localStorage.setItem("templify_canvas_size", JSON.stringify({w,h}));
    baseCanvas.w = w; baseCanvas.h = h;
    snapshot();
    renderAll();
    scheduleAutosave();
  }

  const baseCanvas = { w: 980, h: 620 };
  function loadCanvasSize(){
    try{
      const s = JSON.parse(localStorage.getItem("templify_canvas_size")||"null");
      if(s?.w && s?.h){ baseCanvas.w = s.w; baseCanvas.h = s.h; }
    }catch(e){}
  }

  // Override renderAll to use baseCanvas
  const _renderAll = renderAll;
  renderAll = function(){
    const kids = [...canvas.children].filter(n => n !== gridOverlay);
    kids.forEach(n => n.remove());
    gridOverlay.style.display = gridOn ? "block" : "none";
    canvas.style.transform = `scale(${zoom})`;
    canvas.style.width = `${baseCanvas.w}px`;
    canvas.style.height = `${baseCanvas.h}px`;

    for(const el of state.elements){
      const div = document.createElement("div");
      div.className = "el";
      div.dataset.id = el.id;
      div.style.left = el.x + "px";
      div.style.top = el.y + "px";
      div.style.width = el.w + "px";
      div.style.height = el.h + "px";

      div.style.zIndex = String(el.zIndex ?? el.z ?? 0);

      const t = String(el.type || "card");
      // reset visuals
      div.style.background = "";
      div.style.backgroundImage = "";
      div.style.backgroundSize = "";
      div.style.backgroundPosition = "";
      div.style.border = "";
      div.style.borderRadius = "";
      div.style.boxShadow = "";
      div.style.color = "";
      div.style.display = "";
      div.style.alignItems = "";
      div.style.justifyContent = "";
      div.style.textAlign = "";
      div.style.padding = "";

      if(t === "background"){
        div.innerHTML = "";
        div.style.left = (Number.isFinite(el.x) ? el.x : 0) + "px";
        div.style.top  = (Number.isFinite(el.y) ? el.y : 0) + "px";
        div.style.width  = (Number.isFinite(el.w) ? el.w : docW) + "px";
        div.style.height = (Number.isFinite(el.h) ? el.h : docH) + "px";
        div.style.background = el.gradient || el.fill || el.color || "linear-gradient(135deg,#0a1433,#061022)";
        div.style.borderRadius = (Number.isFinite(el.radius) ? el.radius : 18) + "px";
      } else if(t === "image"){
        div.innerHTML = "";
        const src = el.src || el.url || "";
        if(src) div.style.backgroundImage = `url("${String(src).replace(/"/g,'%22')}")`;
        div.style.backgroundSize = "cover";
        div.style.backgroundPosition = "center";
        div.style.backgroundColor = el.fill || "rgba(255,255,255,0.06)";
        div.style.borderRadius = (Number.isFinite(el.radius) ? el.radius : 18) + "px";
        if(el.stroke) div.style.border = `1px solid ${el.stroke}`;
      } else if(t === "shape"){
        div.innerHTML = "";
        div.style.background = el.gradient || el.fill || el.color || "rgba(255,255,255,0.06)";
        div.style.borderRadius = (Number.isFinite(el.radius) ? el.radius : 18) + "px";
        if(el.stroke) div.style.border = `1px solid ${el.stroke}`;
        if(Number.isFinite(el.opacity)) div.style.opacity = String(el.opacity);
      } else if(t === "heading" || t === "text"){
        const txt = el.text ?? el.title ?? "";
        const sub = el.sub ?? el.subtitle ?? "";
        div.innerHTML = `<div style="font-size:${Number.isFinite(el.fontSize)?el.fontSize: (t==='heading'?44:22)}px; font-weight:${Number.isFinite(el.fontWeight)?el.fontWeight:(t==='heading'?800:500)}; line-height:${Number.isFinite(el.lineHeight)?el.lineHeight:1.1}; letter-spacing:${Number.isFinite(el.letterSpacing)?el.letterSpacing:0}px;">${escapeHtml(txt)}</div>` +
                        (sub ? `<div style="margin-top:10px; font-size:${Math.max(14, Math.round((Number.isFinite(el.fontSize)?el.fontSize:22)*0.55))}px; opacity:0.85;">${escapeHtml(sub)}</div>` : "");
        div.style.background = el.fill || "transparent";
        div.style.color = el.color || "#eaf0ff";
        div.style.padding = (Number.isFinite(el.padding)? el.padding : 18) + "px";
        div.style.borderRadius = (Number.isFinite(el.radius) ? el.radius : 18) + "px";
      } else if(t === "badge"){
        const txt = el.text ?? el.title ?? "BADGE";
        div.innerHTML = `<div style="font-size:${Number.isFinite(el.fontSize)?el.fontSize:14}px; font-weight:${Number.isFinite(el.fontWeight)?el.fontWeight:700}; letter-spacing:${Number.isFinite(el.letterSpacing)?el.letterSpacing:1.2}px; text-transform:uppercase;">${escapeHtml(txt)}</div>`;
        div.style.background = el.fill || "rgba(255,255,255,0.10)";
        div.style.color = el.color || "#eaf0ff";
        div.style.display = "flex";
        div.style.alignItems = "center";
        div.style.justifyContent = "center";
        div.style.textAlign = "center";
        div.style.borderRadius = (Number.isFinite(el.radius) ? el.radius : 999) + "px";
        if(el.stroke) div.style.border = `1px solid ${el.stroke}`;
        if(Number.isFinite(el.opacity)) div.style.opacity = String(el.opacity);
      } else if(t === "cta"){
        const txt = el.text ?? el.title ?? "Shop Now";
        div.innerHTML = `<div style="font-size:${Number.isFinite(el.fontSize)?el.fontSize:16}px; font-weight:${Number.isFinite(el.fontWeight)?el.fontWeight:800};">${escapeHtml(txt)}</div>`;
        div.style.background = el.fill || "#0b5fff";
        div.style.color = el.color || "#ffffff";
        div.style.display = "flex";
        div.style.alignItems = "center";
        div.style.justifyContent = "center";
        div.style.textAlign = "center";
        div.style.borderRadius = (Number.isFinite(el.radius) ? el.radius : 999) + "px";
      } else {
        // Default: existing card behavior
        div.innerHTML = `<h4>${escapeHtml(el.title)}</h4><p>${escapeHtml(el.sub)}</p>`;
      }

      if(el.shadow){
        div.style.boxShadow = String(el.shadow);
      }

      if(state.selectedIds.has(el.id)) div.classList.add("selected");
      canvas.appendChild(div);
      wireElement(div);
    }
    refreshLeft();
  }

  // Splitter drag resize
  function wireSplitter(splitter, side){
    let dragging = false;
    splitter.addEventListener("mousedown", (e)=>{
      dragging = true;
      e.preventDefault();
      document.body.style.cursor = "col-resize";
    });
    window.addEventListener("mousemove", (e)=>{
      if(!dragging) return;
      const rect = document.body.getBoundingClientRect();
      if(side === "left"){
        const w = Math.max(240, Math.min(420, e.clientX));
        document.documentElement.style.setProperty("--leftW", w + "px");
      }else{
        const w = Math.max(260, Math.min(460, rect.width - e.clientX));
        document.documentElement.style.setProperty("--rightW", w + "px");
      }
    });
    window.addEventListener("mouseup", ()=>{
      if(!dragging) return;
      dragging = false;
      document.body.style.cursor = "";
    });
  }

  // Toolbar actions
  $("#backBtn").addEventListener("click", ()=>{ window.location.href = "index.html"; });
  $("#themeBtn").addEventListener("click", ()=>{
    const cur = document.body.getAttribute("data-theme") || "dark";
    setTheme(cur==="dark" ? "light" : "dark");
  });

  $("#addBtn").addEventListener("click", ()=> addElement(140, 140, 300, 140, "New Card", "Edit me from the Properties panel."));
  $("#duplicateBtn").addEventListener("click", ()=> duplicateSelected());
  $("#deleteBtn").addEventListener("click", ()=> deleteSelected());

  $("#undoBtn").addEventListener("click", undo);
  $("#redoBtn").addEventListener("click", redo);

  $("#zoomInBtn").addEventListener("click", ()=> setZoom(zoom * 1.1, true));
  $("#zoomOutBtn").addEventListener("click", ()=> setZoom(zoom / 1.1, true));

  $("#toggleGridBtn").addEventListener("click", ()=>{
    gridOn = !gridOn;
    snapshot();
    renderAll();
    updateUI();
    scheduleAutosave();
  });

  $("#exportBtn").addEventListener("click", exportDoc);

  // Properties bindings
  function bindProp(id, fn){
    const el = $(id);
    el.addEventListener("input", ()=>{
      const sel = getSingleSelected();
      if(!sel) return;
      fn(sel, el.value);
      renderAll();
      scheduleAutosave();
    });
    el.addEventListener("change", ()=>{
      snapshot();
    });
  }

  bindProp("#propX", (s,v)=> s.x = parseInt(v||"0",10) || 0);
  bindProp("#propY", (s,v)=> s.y = parseInt(v||"0",10) || 0);
  bindProp("#propW", (s,v)=> s.w = Math.max(80, parseInt(v||"0",10) || 80));
  bindProp("#propH", (s,v)=> s.h = Math.max(60, parseInt(v||"0",10) || 60));
  bindProp("#propTitle", (s,v)=> s.title = String(v||""));
  bindProp("#propSub", (s,v)=> s.sub = String(v||""));

  // -----------------------------
  // Phase G: Editor Intelligence
  // -----------------------------

  // Document settings
  function applyDoc(){
    docW = Math.max(200, Number($("#docW")?.value || 980));
    docH = Math.max(200, Number($("#docH")?.value || 620));
    docBg = String($("#docBg")?.value || "").trim();

    canvas.style.width = docW + "px";
    canvas.style.height = docH + "px";
    if(docBg){
      canvas.style.background = docBg;
    }else{
      canvas.style.background = "transparent";
    }
    renderAll();
    updateUI();
  }

  $("#applyDocBtn")?.addEventListener("click", applyDoc);
  $("#resetDocBtn")?.addEventListener("click", ()=>{
    $("#docW").value = 980;
    $("#docH").value = 620;
    $("#docBg").value = "";
    applyDoc();
  });

  // Prompt helpers
  function getGeneratorPrompt(){
    // Try draft first, then settings
    if(draft && typeof draft.prompt === "string" && draft.prompt.trim()) return draft.prompt.trim();
    try{
      const s = JSON.parse(localStorage.getItem("nexora_last_settings_v1")||"null");
      if(s && typeof s.prompt === "string") return s.prompt.trim();
    }catch(e){}
    return "";
  }

  function cleanText(s){
    return String(s||"").replace(/\s+/g," ").trim();
  }

  function titleCaseWords(s){
    const w = cleanText(s).split(" ").slice(0, 6);
    return w.map(x=> x.length<=2 ? x.toUpperCase() : (x[0].toUpperCase()+x.slice(1))).join(" ");
  }

  function makeHeadline(prompt){
    if(!prompt) return "New Collection";
    const p = cleanText(prompt);
    // Try split on punctuation
    const first = p.split(/[\n\.\!\?]/)[0] || p;
    return titleCaseWords(first);
  }

  function makeSubtitle(prompt){
    if(!prompt) return "Premium ‚Ä¢ Ready";
    const p = cleanText(prompt);
    const parts = p.split(/[\n\.\!\?]/).map(x=>cleanText(x)).filter(Boolean);
    if(parts.length>=2) return parts[1].slice(0, 64);
    return (p.length>64 ? p.slice(0,64)+"‚Ä¶" : p);
  }

  function selectedOrAll(){
    const ids = [...state.selectedIds];
    if(ids.length) return state.elements.filter(e=>ids.includes(e.id));
    return state.elements;
  }

  function applyPromptToDesign(){
    const prompt = getGeneratorPrompt();
    if(!prompt){
      // no prompt: still keep stable
      return;
    }
    snapshot();
    const headline = makeHeadline(prompt);
    const subtitle = makeSubtitle(prompt);

    // Apply to first 2 text-like elements we find, otherwise to all as fallbacks
    const targets = selectedOrAll();
    let applied = 0;
    for(const el of targets){
      if(typeof el.title === "string" && applied === 0){
        el.title = headline;
        applied++;
        continue;
      }
      if(typeof el.sub === "string" && applied <= 2){
        el.sub = subtitle;
        applied++;
      }
    }
    // If nothing matched, set on first element
    if(!applied && state.elements[0]){
      state.elements[0].title = headline;
      state.elements[0].sub = subtitle;
    }

    renderAll();
    refreshLeft();
    updateUI();
  }

  $("#smartApplyPrompt")?.addEventListener("click", applyPromptToDesign);

  // Layout helpers
  function smartCenter(){
    const targets = selectedOrAll();
    if(!targets.length) return;
    snapshot();
    const cx = docW/2, cy = docH/2;
    const bb = targets.reduce((acc,e)=>{
      acc.minX = Math.min(acc.minX, e.x);
      acc.minY = Math.min(acc.minY, e.y);
      acc.maxX = Math.max(acc.maxX, e.x + e.w);
      acc.maxY = Math.max(acc.maxY, e.y + e.h);
      return acc;
    }, {minX:1e9, minY:1e9, maxX:-1e9, maxY:-1e9});
    const bw = bb.maxX - bb.minX;
    const bh = bb.maxY - bb.minY;
    const dx = Math.round(cx - (bb.minX + bw/2));
    const dy = Math.round(cy - (bb.minY + bh/2));
    targets.forEach(e=>{ e.x += dx; e.y += dy; });
    renderAll(); refreshLeft(); updateUI();
  }

  function smartTidy(){
    const targets = selectedOrAll();
    if(targets.length < 2) return;
    snapshot();
    // Sort top-to-bottom, then left-to-right
    const sorted = [...targets].sort((a,b)=> (a.y-b.y) || (a.x-b.x));
    // Determine row size by proximity on y
    const rowGap = 22;
    const colGap = 22;

    let x = 60, y = 60, rowH = 0;
    for(const e of sorted){
      if(x + e.w > docW - 60){
        x = 60;
        y = y + rowH + rowGap;
        rowH = 0;
      }
      e.x = x;
      e.y = y;
      x = x + e.w + colGap;
      rowH = Math.max(rowH, e.h);
    }
    renderAll(); refreshLeft(); updateUI();
  }

  function smartDistribute(){
    const targets = selectedOrAll();
    if(targets.length < 3) return;
    snapshot();
    const sorted = [...targets].sort((a,b)=>a.x-b.x);
    const left = sorted[0].x;
    const right = sorted[sorted.length-1].x;
    const span = right - left;
    if(span <= 0) return;
    const step = span / (sorted.length-1);
    sorted.forEach((e,i)=>{ e.x = Math.round(left + step*i); });
    renderAll(); refreshLeft(); updateUI();
  }

  $("#smartTidy")?.addEventListener("click", smartTidy);
  $("#smartCenter")?.addEventListener("click", smartCenter);
  $("#smartDistribute")?.addEventListener("click", smartDistribute);

  // Typography helpers
  $("#smartUpcase")?.addEventListener("click", ()=>{
    const targets = selectedOrAll();
    if(!targets.length) return;
    snapshot();
    targets.forEach(e=>{
      if(typeof e.title === "string") e.title = e.title.toUpperCase();
      if(typeof e.sub === "string") e.sub = e.sub.toUpperCase();
    });
    renderAll(); refreshLeft(); updateUI();
  });

  $("#smartShorten")?.addEventListener("click", ()=>{
    const targets = selectedOrAll();
    if(!targets.length) return;
    snapshot();
    targets.forEach(e=>{
      if(typeof e.title === "string") e.title = cleanText(e.title).slice(0, 32);
      if(typeof e.sub === "string") e.sub = cleanText(e.sub).slice(0, 64);
    });
    renderAll(); refreshLeft(); updateUI();
  });

  // Auto-apply prompt once when editor opens (non-destructive: only if we have a real prompt)
  try{
    if(getGeneratorPrompt()){
      applyPromptToDesign();
    }
  }catch(e){}


  // Keyboard shortcuts
  window.addEventListener("resize", ()=>{ try{ fitZoomToStage(false); renderAll(); updateUI(); }catch(_){} });
  window.addEventListener("keydown", (e)=>{
    const isMac = navigator.platform.toLowerCase().includes("mac");
    const ctrl = isMac ? e.metaKey : e.ctrlKey;

    if(ctrl && (e.key.toLowerCase()==="d")){
      e.preventDefault();
      duplicateSelected();
    }
    if(ctrl && (e.key.toLowerCase()==="z")){
      e.preventDefault();
      undo();
    }
    if(ctrl && (e.key.toLowerCase()==="y")){
      e.preventDefault();
      redo();
    }
    if(e.key==="Delete"){
      deleteSelected();
    }
  });

  // Click empty canvas to clear selection
  canvas.addEventListener("mousedown", (e)=>{
    if(e.target === canvas || e.target === gridOverlay){
      state.selectedIds.clear();
      renderAll();
      updateUI();
    }
  });

  function duplicateSelected(){
    const ids = [...state.selectedIds];
    if(ids.length===0) return;
    const newIds = [];
    for(const id of ids){
      const src = getById(id);
      if(!src) continue;
      const copy = { ...src, id: uid(), x: src.x + 24, y: src.y + 24 };
      state.elements.push(copy);
      newIds.push(copy.id);
    }
    snapshot();
    state.selectedIds = new Set(newIds);
    renderAll();
    updateUI();
    scheduleAutosave();
  }

  function deleteSelected(){
    const ids = new Set(state.selectedIds);
    if(ids.size===0) return;
    state.elements = state.elements.filter(e => !ids.has(e.id));
    state.selectedIds.clear();
    snapshot();
    renderAll();
    updateUI();
    scheduleAutosave();
  }

  function setZoom(z, user=false){
    if(user) autoFitZoom = false;
    zoom = clamp(Number(z)||1, 0.08, 2.2);
    try{ $("#zoomPill").textContent = Math.round(zoom*100) + "%"; }catch(_){}
    renderAll();
    updateUI();
  }

  function fitZoomToView(){
    // public helper: re-enable auto-fit and fit canvas into view
    autoFitZoom = true;
    fitZoomToStage(true);
    renderAll();
    updateUI();
  }


  function undo(){
    if(state.history.length<=1) return;
    const cur = state.history.pop();
    state.future.push(cur);
    const prev = state.history[state.history.length-1];
    restore(prev);
    scheduleAutosave();
  }

  function redo(){
    if(state.future.length===0) return;
    const snap = state.future.pop();
    state.history.push(snap);
    restore(snap);
    scheduleAutosave();
  }

  function exportDoc(){
    const payload = {
      v: 1,
      exportedAt: new Date().toISOString(),
      title: $("#docTitle").textContent,
      canvas: { w: baseCanvas.w, h: baseCanvas.h, zoom },
      elements: state.elements
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "templify_export.json";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // Left tabs
  $("#leftTabs").addEventListener("click", (e)=>{
    const chip = e.target.closest(".chip");
    if(!chip) return;
    $$("#leftTabs .chip").forEach(c => c.classList.remove("active"));
    chip.classList.add("active");
    refreshLeft();
  });

  // Right tabs (Selected / Document / Smart)
  function showRightPane(tab){
    $$("#rightTabs .chip").forEach(c => c.classList.toggle("active", c.dataset.tab === tab));
    $$("#rightPanel .pane").forEach(p => p.classList.toggle("hidden", p.dataset.pane !== tab));
  }

  $("#rightTabs")?.addEventListener("click", (e)=>{
    const chip = e.target.closest(".chip");
    if(!chip) return;
    showRightPane(chip.dataset.tab || "props");
  });

  // Default
  showRightPane("props");


  $("#leftSearch").addEventListener("input", refreshLeft);

  // Wire splitters
  wireSplitter($("#splitLeft"), "left");
  wireSplitter($("#splitRight"), "right");

  // Boot
  loadCanvasSize();
  snapshot(); // initial empty
  loadAutosaveOrSeed();
  refreshLeft();
  updateUI();
})();
</script>

<script>
(function(){
  function resetZoom(){
    const canvas = document.getElementById('canvas');
    if(!canvas) return;

    // Remove any scale transforms applied by editor
    canvas.style.transform = 'scale(1)';
    canvas.style.transformOrigin = '0 0';

    // Also reset parent wrappers if scaled
    let p = canvas.parentElement;
    while(p){
      if(p.style && p.style.transform){
        p.style.transform = 'scale(1)';
        p.style.transformOrigin = '0 0';
      }
      p = p.parentElement;
    }
  }

  // Run after template open
  resetZoom();
  setTimeout(resetZoom, 100);
  setTimeout(resetZoom, 300);
  setTimeout(resetZoom, 600);
})();
</script>


<script>
/* === NEW CANVAS LOGIC (REPLACED) === */
(function(){
  const canvas = document.getElementById('canvas');
  if(canvas){
    canvas.style.width = '880px';
    canvas.style.height = '620px';
    canvas.style.transform = 'none';
  }

  // Disable all legacy canvas controllers
  window.resizeCanvas = function(){};
  window.fitZoomToStage = function(){};
  window.fitZoomToView = function(){};
  window.resetZoom = function(){};

  // Lock zoom
  try{
    if(window.zoom !== undefined) window.zoom = 1;
    if(window.autoFitZoom !== undefined) window.autoFitZoom = false;
  }catch(e){}

})();
</script>

<script>
/* === Canva clone: left sidebar modes + selection->properties === */
(function(){
  // Rail mode switching (visual only; keeps existing leftList population)
  const rail = document.getElementById('rail');
  const sideTitle = document.getElementById('sideTitle');
  const sideTabs = document.getElementById('sideTabs');
  const sideBody = document.getElementById('sideBody');
  const leftSearch = document.getElementById('leftSearch');
  const leftList = document.getElementById('leftList');

  // Keep references to original properties panel DOM (already built by existing code later)
  const rightPanel = document.getElementById('rightPanel');

  function setRailActive(mode){
    rail?.querySelectorAll('.railBtn')?.forEach(b=>{
      b.classList.toggle('active', b.dataset.mode===mode);
    });
  }

  function showDesignMode(){
    setRailActive('design');
    sideTitle.textContent = 'Design';
    sideTabs.classList.remove('hidden');
    // Ensure search + list visible
    if(leftSearch) leftSearch.classList.remove('hidden');
    if(leftList) leftList.classList.remove('hidden');
    // If we previously moved property UI into sidebar, move it back to hidden right panel
    const propsRoot = document.getElementById('propsRoot');
    if(propsRoot && rightPanel){
      // return to rightPanelBody if present
      const host = document.getElementById('rightPanelBody') || rightPanel.querySelector('.panelBody');
      if(host && !host.contains(propsRoot)) host.appendChild(propsRoot);
    }
  }

  function showPropertiesMode(){
    setRailActive('design'); // Canva keeps "Design" highlighted; we keep rail stable
    sideTitle.textContent = 'Position'; // Canva shows contextual label; "Position" is common
    sideTabs.classList.add('hidden');
    if(leftSearch) leftSearch.classList.add('hidden');
    if(leftList) leftList.classList.add('hidden');

    // Move properties UI into sidebar body (no duplicates)
    const host = sideBody;
    if(!host) return;
    // Find the existing properties UI (created by your editor code). We'll wrap it once as #propsRoot.
    let propsRoot = document.getElementById('propsRoot');
    if(!propsRoot){
      // Try common containers in current editor
      propsRoot =
        document.querySelector('#rightPanel .pane')?.parentElement ||
        document.querySelector('#rightPanel .propGrid')?.closest('.pane') ||
        document.querySelector('#rightPanel .panelBody');
      if(propsRoot){
        // Ensure stable id by wrapping children
        const wrapper = document.createElement('div');
        wrapper.id = 'propsRoot';
        // move all children of panelBody into wrapper
        const body = document.getElementById('rightPanelBody') || document.querySelector('#rightPanel .panelBody');
        if(body){
          while(body.firstChild) wrapper.appendChild(body.firstChild);
          body.appendChild(wrapper);
          propsRoot = wrapper;
        }else{
          propsRoot.id = 'propsRoot';
        }
      }
    }
    if(propsRoot && !host.contains(propsRoot)){
      host.appendChild(propsRoot);
    }
  }

  // Public-ish hooks for existing editor logic (non-breaking)
  window.__NEXORA_CANVA_CLONE__ = { showDesignMode, showPropertiesMode };

  // Click handling for rail
  rail?.addEventListener('click', (e)=>{
    const btn = e.target.closest('.railBtn');
    if(!btn) return;
    // For now only 'design' is functional; others are placeholders but keep Canva feel
    showDesignMode();
  });

  // Auto-switch to properties when selection changes:
  // Existing code often updates "selectedIds" or calls updateUI/renderAll.
  // We'll monkeypatch updateUI if present.
  const prevUpdateUI = window.updateUI;
  if(typeof prevUpdateUI === 'function'){
    window.updateUI = function(){
      const r = prevUpdateUI.apply(this, arguments);
      try{
        // If any element has .selected class, show properties; else show design.
        const hasSel = !!document.querySelector('#canvas .selected');
        if(hasSel) showPropertiesMode(); else showDesignMode();
      }catch{}
      return r;
    }
  } else {
    // Fallback: observe selection class changes
    const canvas = document.getElementById('canvas');
    if(canvas){
      const mo = new MutationObserver(()=>{
        const hasSel = !!canvas.querySelector('.selected');
        if(hasSel) showPropertiesMode(); else showDesignMode();
      });
      mo.observe(canvas, { subtree:true, attributes:true, attributeFilter:['class'] });
    }
  }

  // Start in design mode
  showDesignMode();
})();
</script>

<script>
/* === FIX: Wire Canva-style buttons to existing editor logic === */
(function(){
  // Helper to safely trigger original UI actions
  function clickIfExists(sel){
    const el = document.querySelector(sel);
    if(el){ el.click(); return true; }
    return false;
  }

  function callIfExists(name, args=[]){
    if(typeof window[name] === 'function'){
      window[name].apply(window, args);
      return true;
    }
    return false;
  }

  // Map Canva rail modes to your existing editor capabilities
  const MODE_MAP = {
    design(){
      // Prefer template view
      return (
        clickIfExists('[data-view="templates"]') ||
        clickIfExists('#btnTemplates') ||
        callIfExists('showTemplates') ||
        true
      );
    },
    elements(){
      return (
        clickIfExists('[data-view="elements"]') ||
        clickIfExists('#btnElements') ||
        callIfExists('showElements') ||
        true
      );
    },
    text(){
      return (
        clickIfExists('[data-view="text"]') ||
        clickIfExists('#btnText') ||
        callIfExists('addTextMode') ||
        true
      );
    },
    uploads(){
      return (
        clickIfExists('[data-view="uploads"]') ||
        clickIfExists('#btnUploads') ||
        callIfExists('showUploads') ||
        true
      );
    },
    projects(){
      return (
        clickIfExists('[data-view="projects"]') ||
        clickIfExists('#btnProjects') ||
        true
      );
    }
  };

  // Attach to rail
  const rail = document.getElementById('rail');
  if(rail){
    rail.addEventListener('click', (e)=>{
      const btn = e.target.closest('.railBtn');
      if(!btn) return;
      const mode = btn.dataset.mode;
      if(MODE_MAP[mode]) MODE_MAP[mode]();
    });
  }

  // Ensure canvas click deselects -> returns to Design mode
  const canvas = document.getElementById('canvas');
  if(canvas){
    canvas.addEventListener('mousedown', ()=>{
      if(window.__NEXORA_CANVA_CLONE__){
        window.__NEXORA_CANVA_CLONE__.showDesignMode();
      }
    });
  }
})();
</script>


<script>
/* === GLOBAL EVENT DELEGATION FIX (Top + Left Bars) === */
(function(){
  function call(fn){
    if(typeof window[fn] === 'function'){
      window[fn]();
      return true;
    }
    return false;
  }

  function clickSel(sel){
    const el = document.querySelector(sel);
    if(el){ el.click(); return true; }
    return false;
  }

  document.addEventListener('click', function(e){
    const btn = e.target.closest('button, .btn, [role="button"], [data-action]');
    if(!btn) return;

    const label = (btn.innerText || btn.getAttribute('aria-label') || '').toLowerCase();

    // Top bar actions
    if(label.includes('undo')){ call('undo'); return; }
    if(label.includes('redo')){ call('redo'); return; }
    if(label.includes('export')){ call('exportCanvas') || clickSel('#exportBtn'); return; }
    if(label.includes('zoom')){
      if(label.includes('+')) call('zoomIn');
      else if(label.includes('-')) call('zoomOut');
      return;
    }

    // Left design tabs
    if(label.includes('template')){ call('showTemplates'); return; }
    if(label.includes('element')){ call('showElements'); return; }
    if(label.includes('text')){ call('addTextMode'); return; }
    if(label.includes('upload')){ call('showUploads'); return; }
  }, true);
})();
</script>


<script>
/* === SAFE DIRECT-OPEN BOOTSTRAP === */
(function(){
  // If editor state already exists (normal flow), do nothing
  if (window.__EDITOR_BOOTSTRAPPED__) return;

  // Detect missing core state
  const needsBootstrap = (
    typeof window.editorState === "undefined" ||
    typeof window.currentDoc === "undefined"
  );

  if (!needsBootstrap) return;

  // Minimal compatible state (matches existing expectations)
  window.editorState = window.editorState || {
    mode: "design",
    zoom: 1,
    selected: null
  };

  window.currentDoc = window.currentDoc || {
    pages: [],
    activePage: 0
  };

  // Flags used by existing logic
  window.autoFitZoom = false;
  window.zoom = window.editorState.zoom;

  // Call existing init hooks if present
  if (typeof window.initEditor === "function") {
    try { window.initEditor(); } catch(e){}
  }
  if (typeof window.renderUI === "function") {
    try { window.renderUI(); } catch(e){}
  }
  if (typeof window.showTemplates === "function") {
    try { window.showTemplates(); } catch(e){}
  }

  window.__EDITOR_BOOTSTRAPPED__ = true;
})();
</script>

</body>
</html>
