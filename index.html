
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Templify ‚Äì Ultimate Editor v1</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#0b5fff;
      --muted:#aab0bd;

      --bg:#050712;
      --panel:rgba(15,18,32,.58);
      --panel2:rgba(15,18,32,.36);
      --stroke:rgba(255,255,255,.10);
      --text:#f6f7fb;

      --shadow:0 18px 50px rgba(0,0,0,.45);
      --radius:18px;

      --topH:58px;
      --leftW:300px;
      --rightW:320px;
    }
    [data-theme="light"]{
      --bg:#f5f7ff;
      --panel:rgba(255,255,255,.76);
      --panel2:rgba(255,255,255,.55);
      --stroke:rgba(10,20,60,.12);
      --text:#0b1020;
      --shadow:0 18px 40px rgba(10,20,60,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(11,95,255,.22), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(136,71,255,.18), transparent 55%),
        radial-gradient(900px 600px at 35% 95%, rgba(0,225,255,.10), transparent 55%),
        var(--bg);
      overflow:hidden;
    }

    /* Layout */
    .app{
      height:100%;
      display:grid;
      grid-template-rows: var(--topH) 1fr;
      grid-template-columns: 1fr;
    }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid var(--stroke);
      background:var(--panel);
      backdrop-filter: blur(16px);
      box-shadow: 0 8px 26px rgba(0,0,0,.25);
      position:sticky;top:0;z-index:50;
    }

    .brand{
      display:flex;align-items:center;gap:10px;min-width:210px;
    }
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:linear-gradient(135deg, rgba(11,95,255,.95), rgba(136,71,255,.88));
      box-shadow:0 10px 26px rgba(11,95,255,.22);
      border:1px solid rgba(255,255,255,.16);
      flex:0 0 auto;
    }
    .brand b{font-size:13px;letter-spacing:.2px}
    .brand span{display:block;font-size:11px;color:var(--muted);margin-top:1px}
    .pill{
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background:var(--panel2);
      color:var(--muted);
      font-size:11px;
      white-space:nowrap;
    }

    .tools{
      display:flex;align-items:center;gap:8px;
      flex: 1 1 auto;
      min-width: 260px;
      overflow:auto;
      padding:2px 0;
    }
    .tools::-webkit-scrollbar{height:8px}
    .tools::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}
    [data-theme="light"] .tools::-webkit-scrollbar-thumb{background:rgba(10,20,60,.14)}
    .btn{
      appearance:none;
      border:1px solid var(--stroke);
      background:var(--panel2);
      color:var(--text);
      padding:9px 10px;
      border-radius:14px;
      font-weight:600;
      font-size:12px;
      cursor:pointer;
      transition:.15s ease;
      backdrop-filter: blur(16px);
      display:inline-flex;align-items:center;gap:8px;
      white-space:nowrap;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(11,95,255,.35)}
    .btn:active{transform:translateY(0px)}
    .btn.primary{
      background:linear-gradient(135deg, rgba(11,95,255,.95), rgba(136,71,255,.85));
      border-color:rgba(255,255,255,.14);
      box-shadow:0 12px 30px rgba(11,95,255,.18);
    }
    .btn.danger{border-color:rgba(255,80,120,.35)}
    .btn.tiny{padding:7px 10px;font-size:11.5px;border-radius:12px}
    .righttools{
      max-width:140px;
      overflow:hidden;

      display:flex;align-items:center;gap:8px;flex:0 0 auto;
    }
    .kbd{
      max-width:200px;
      overflow:hidden;
      white-space:normal;
      word-break:break-word;

      max-width:260px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:normal;
      line-height:1.4;

      font-size:10.5px;color:var(--muted);
      padding:6px 10px;border:1px solid var(--stroke);
      background:var(--panel2);border-radius:999px;
      white-space:nowrap;
      display:flex;align-items:center;gap:8px;
    }

    /* Work area */
    .work{
      display:grid;
      grid-template-columns: var(--leftW) 8px 1fr 8px var(--rightW);
      height:100%;
      overflow:hidden;
    }

    .panel{
      border-right:1px solid var(--stroke);
      background:var(--panel);
      backdrop-filter: blur(16px);
      overflow:hidden;
      min-width: 220px;
    }
    .panel.right{
      border-right:none;border-left:1px solid var(--stroke);
      min-width: 260px;
    }

    .panelHeader{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--stroke);
      display:flex;align-items:center;justify-content:space-between;gap:8px;
    }
    .panelHeader b{font-size:12.5px}
    .panelHeader .seg{
      display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;
    }
    .seg .chip{
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background:var(--panel2);
      color:var(--muted);
      font-size:11px;
      cursor:pointer;
      user-select:none;
    }
    .seg .chip.active{
      color:var(--text);
      border-color:rgba(11,95,255,.40);
      box-shadow:0 10px 24px rgba(11,95,255,.10);
    }

    .panelBody{padding:12px;overflow:auto;height:calc(100% - 52px)}
    .panelBody::-webkit-scrollbar{width:10px}
    .panelBody::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}
    [data-theme="light"] .panelBody::-webkit-scrollbar-thumb{background:rgba(10,20,60,.14)}

    .search{
      width:100%;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.12);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      outline:none;
      margin-bottom:10px;
    }
    [data-theme="light"] .search{background:rgba(255,255,255,.55)}

    .list{display:grid;gap:10px}
    .item{
      border:1px solid var(--stroke);
      background:var(--panel2);
      border-radius:16px;
      padding:10px;
      cursor:pointer;
      transition:.12s ease;
    }
    .item:hover{transform:translateY(-1px);border-color:rgba(11,95,255,.30)}
    .item b{display:block;font-size:12.5px}
    .item span{display:block;font-size:12px;color:var(--muted);margin-top:3px;line-height:1.35}

    .splitter{
      cursor:col-resize;
      background:transparent;
      position:relative;
    }
    .splitter::after{
      content:"";
      position:absolute;left:50%;top:10px;bottom:10px;
      width:2px;transform:translateX(-50%);
      background:rgba(255,255,255,.10);
      border-radius:999px;
    }
    [data-theme="light"] .splitter::after{background:rgba(10,20,60,.12)}

    /* Canvas */
    .stage{
      position:relative;
      overflow:auto;
      background:transparent;
      padding:18px;
    }
    .stage::-webkit-scrollbar{width:12px;height:12px}
    .stage::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:999px}
    [data-theme="light"] .stage::-webkit-scrollbar-thumb{background:rgba(10,20,60,.14)}

    .canvasWrap{
      min-height: calc(100% - 18px);
      display:flex;align-items:flex-start;justify-content:center;
    }
    .canvas{
      width: 980px;   /* BIG center workspace */
      height: 620px;
      border-radius: 18px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)),
        rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 22px 70px rgba(0,0,0,.45);
      position:relative;
      transform-origin: 0 0;
    }
    [data-theme="light"] .canvas{
      background:
        linear-gradient(180deg, rgba(10,20,60,.05), rgba(10,20,60,.02)),
        rgba(255,255,255,.85);
      border:1px solid rgba(10,20,60,.12);
      box-shadow: 0 18px 55px rgba(10,20,60,.20);
    }

    .gridOverlay{
      position:absolute;inset:0;border-radius:18px;
      background-image:
        linear-gradient(to right, rgba(255,255,255,.07) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.07) 1px, transparent 1px);
      background-size: 24px 24px;
      opacity:.55;
      pointer-events:none;
      mix-blend-mode: overlay;
    }
    [data-theme="light"] .gridOverlay{
      background-image:
        linear-gradient(to right, rgba(10,20,60,.08) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(10,20,60,.08) 1px, transparent 1px);
      opacity:.45;
      mix-blend-mode: multiply;
    }

    .el{
      position:absolute;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.15);
      background: rgba(11,95,255,.18);
      color: var(--text);
      padding: 10px 12px;
      min-width: 120px;
      cursor: pointer;
      user-select:none;
      box-shadow:0 14px 38px rgba(0,0,0,.25);
    }
    .el h4{margin:0;font-size:14px;line-height:1.2}
    .el p{margin:6px 0 0;font-size:12px;color:rgba(255,255,255,.85);line-height:1.35}
    [data-theme="light"] .el{
      background: rgba(11,95,255,.10);
      border:1px solid rgba(10,20,60,.12);
      box-shadow:0 12px 28px rgba(10,20,60,.16);
    }
    [data-theme="light"] .el p{color:rgba(10,20,60,.82)}

    .selected{outline:2px solid rgba(11,95,255,.95); outline-offset:2px}

    /* Properties */
    .propGrid{display:grid;gap:10px}
    .field label{display:block;font-size:11.5px;color:var(--muted);margin:0 0 6px}
    .field input,.field select{
      width:100%;padding:10px 12px;border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.12);
      color:var(--text);outline:none;
    }
    [data-theme="light"] .field input,
    [data-theme="light"] .field select{background:rgba(255,255,255,.55)}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    .miniHelp{
      font-size:11px;color:var(--muted);line-height:1.45;
      border:1px solid var(--stroke);
      background:var(--panel2);
      border-radius:16px;padding:10px;margin-top:10px;
    }

    /* Responsive */
    
    @media (max-width: 1120px){
      .kbd{display:none;}

      :root{ --leftW: 270px; --rightW: 290px; }
      .canvas{width: 900px;}
    }
    @media (max-width: 980px){
      .work{grid-template-columns: 1fr;}
      .panel,.splitter{display:none}
      .stage{padding:14px}
      .canvas{width: min(920px, 100%); height: 560px;}
      .tools{min-width: 1px}
    }
  </style>
</head>

<body data-theme="dark">
  <div class="app">
    <!-- TOP BAR (fixed alignment + visible) -->
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <b>Templify Editor</b>
          <span id="docTitle">Untitled</span>
        </div>
      </div>

      <div class="tools" role="toolbar" aria-label="Editor toolbar">
        <button class="btn tiny" id="backBtn" type="button">‚Üê Back</button>
        <button class="btn tiny" id="themeBtn" type="button">üåó Theme</button>
        <span class="pill" id="autosavePill">Autosave ON</span>

        <button class="btn tiny" id="selectBtn" type="button">üñ± Select</button>
        <button class="btn tiny" id="addBtn" type="button">Ôºã Add</button>
        <button class="btn tiny" id="duplicateBtn" type="button">‚éò Duplicate</button>
        <button class="btn tiny" id="deleteBtn" type="button">üóë Delete</button>

        <button class="btn tiny" id="undoBtn" type="button">‚Ü∂ Undo</button>
        <button class="btn tiny" id="redoBtn" type="button">‚Ü∑ Redo</button>

        <button class="btn tiny" id="zoomOutBtn" type="button">‚àí Zoom</button>
        <button class="btn tiny" id="zoomInBtn" type="button">Ôºã Zoom</button>
        <span class="pill" id="zoomPill">100%</span>

        <button class="btn tiny" id="toggleGridBtn" type="button">‚ñ¶ Grid</button>
        <button class="btn tiny primary" id="exportBtn" type="button">‚¨á Export</button>
      </div>

      <div class="righttools">
        
    <button class="btn tiny" id="helpj" title="Shortcuts:
Shift+Click = Multi-select
Ctrl+D = Duplicate
Ctrl+Z / Ctrl+Y = Undo / Redo">‚å®</button>
    
      </div>
    </div>

    <div class="work">
      <!-- LEFT PANEL -->
      <aside class="panel left" id="leftPanel">
        <div class="panelHeader">
          <b>Library</b>
          <div class="seg" id="leftTabs">
            <div class="chip active" data-tab="templates">Templates</div>
            <div class="chip" data-tab="layers">Layers</div>
            <div class="chip" data-tab="assets">Assets</div>
          </div>
        </div>
        <div class="panelBody">
          <input class="search" id="leftSearch" placeholder="Search‚Ä¶" />
          <div class="list" id="leftList"></div>
        </div>
      </aside>

      <div class="splitter" id="splitLeft" title="Drag to resize"></div>

      <!-- CENTER STAGE -->
      <main class="stage" id="stage">
        <div class="canvasWrap">
          <div class="canvas" id="canvas">
            <div class="gridOverlay" id="gridOverlay"></div>
          </div>
        </div>
      </main>

      <div class="splitter" id="splitRight" title="Drag to resize"></div>

      <!-- RIGHT PANEL -->
      <aside class="panel right" id="rightPanel">
        <div class="panelHeader">
          <b>Properties</b>
          <div class="seg">
            <div class="chip active" data-tab="props">Selected</div>
            <div class="chip" data-tab="doc">Document</div>
          </div>
        </div>
        <div class="panelBody">
          <div class="propGrid">
            <div class="field">
              <label>Element</label>
              <select id="propType">
                <option value="card">Card</option>
              </select>
            </div>

            <div class="row2">
              <div class="field">
                <label>X</label>
                <input id="propX" type="number" />
              </div>
              <div class="field">
                <label>Y</label>
                <input id="propY" type="number" />
              </div>
            </div>

            <div class="row2">
              <div class="field">
                <label>W</label>
                <input id="propW" type="number" />
              </div>
              <div class="field">
                <label>H</label>
                <input id="propH" type="number" />
              </div>
            </div>

            <div class="field">
              <label>Title</label>
              <input id="propTitle" placeholder="Heading‚Ä¶" />
            </div>

            <div class="field">
              <label>Subtitle</label>
              <input id="propSub" placeholder="Supporting text‚Ä¶" />
            </div>

            <div class="miniHelp" id="helpBox">
              Click an element to select. Drag to move. Use the toolbar for duplicate, delete, undo/redo, and export.
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

<script>
(() => {
  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => [...el.querySelectorAll(s)];

  // Theme
  const savedTheme = localStorage.getItem("templify_theme");
  if(savedTheme==="light"||savedTheme==="dark") document.body.setAttribute("data-theme", savedTheme);

  function setTheme(next){
    document.body.setAttribute("data-theme", next);
    localStorage.setItem("templify_theme", next);
  }

  // Draft meta from index
  let draft = null;
  try{ draft = JSON.parse(localStorage.getItem("templify_draft")||"null"); }catch(e){}
  const title = draft?.meta?.cat ? `${draft.meta.cat} ‚Ä¢ ${draft.meta.style || "Style"}` : "Untitled";
  $("#docTitle").textContent = title;

  // State
  const canvas = $("#canvas");
  const stage = $("#stage");
  const gridOverlay = $("#gridOverlay");
  let zoom = 1;
  let gridOn = true;

  const state = {
    elements: [],
    selectedIds: new Set(),
    history: [],
    future: [],
    autosave: true,
  };

  // Helpers
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

  function snapshot(){
    const snap = JSON.stringify({
      elements: state.elements,
      selected: [...state.selectedIds],
      zoom, gridOn
    });
    state.history.push(snap);
    if(state.history.length>100) state.history.shift();
    state.future.length = 0;
  }

  function restore(snap){
    const obj = JSON.parse(snap);
    state.elements = obj.elements || [];
    state.selectedIds = new Set(obj.selected || []);
    zoom = obj.zoom ?? zoom;
    gridOn = obj.gridOn ?? gridOn;
    renderAll();
    updateUI();
  }

  function autosave(){
    if(!state.autosave) return;
    const payload = {
      v: 1,
      savedAt: Date.now(),
      docTitle: $("#docTitle").textContent,
      elements: state.elements
    };
    localStorage.setItem("templify_autosave", JSON.stringify(payload));
    $("#autosavePill").textContent = "Autosave ON";
  }

  let autosaveTimer = null;
  function scheduleAutosave(){
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(autosave, 250);
  }

  // Init content
  function addElement(x=80, y=80, w=260, h=130, title="Premium Title", sub="Add your text here‚Ä¶"){
    const id = uid();
    state.elements.push({ id, x, y, w, h, title, sub });
    snapshot();
    renderAll();
    selectOnly(id);
    scheduleAutosave();
  }

  function loadAutosaveOrSeed(){
    let saved = null;
    try{ saved = JSON.parse(localStorage.getItem("templify_autosave")||"null"); }catch(e){}
    if(saved?.elements?.length){
      state.elements = saved.elements;
      snapshot();
      renderAll();
      state.selectedIds.clear();
      updateUI();
      $("#autosavePill").textContent = "Autosave ON";
      return;
    }
    // Seed
    addElement(90, 92, 320, 150, draft?.meta?.notes ? draft.meta.notes.slice(0,32) : "Luxury Template", "Drag, resize, duplicate‚Ä¶");
    addElement(470, 210, 360, 170, "Modern Card", "Click elements to edit properties.");
  }

  // Render
  function renderAll(){
    // Keep grid overlay
    const kids = [...canvas.children].filter(n => n !== gridOverlay);
    kids.forEach(n => n.remove());
    gridOverlay.style.display = gridOn ? "block" : "none";
    canvas.style.transform = `scale(${zoom})`;
    canvas.style.width = `${980}px`;
    canvas.style.height = `${620}px`;

    for(const el of state.elements){
      const div = document.createElement("div");
      div.className = "el";
      div.dataset.id = el.id;
      div.style.left = el.x + "px";
      div.style.top = el.y + "px";
      div.style.width = el.w + "px";
      div.style.height = el.h + "px";
      div.innerHTML = `<h4>${escapeHtml(el.title)}</h4><p>${escapeHtml(el.sub)}</p>`;
      if(state.selectedIds.has(el.id)) div.classList.add("selected");
      canvas.appendChild(div);
      wireElement(div);
    }
  }

  function escapeHtml(str){
    return String(str??"").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

  function updateUI(){
    $("#zoomPill").textContent = Math.round(zoom*100) + "%";
    gridOverlay.style.display = gridOn ? "block" : "none";

    const sel = getSingleSelected();
    if(!sel){
      $("#propX").value = "";
      $("#propY").value = "";
      $("#propW").value = "";
      $("#propH").value = "";
      $("#propTitle").value = "";
      $("#propSub").value = "";
      return;
    }
    $("#propX").value = sel.x;
    $("#propY").value = sel.y;
    $("#propW").value = sel.w;
    $("#propH").value = sel.h;
    $("#propTitle").value = sel.title;
    $("#propSub").value = sel.sub;
  }

  function getById(id){ return state.elements.find(e => e.id === id); }
  function getSingleSelected(){
    const ids = [...state.selectedIds];
    if(ids.length !== 1) return null;
    return getById(ids[0]) || null;
  }

  function selectOnly(id){
    state.selectedIds.clear();
    state.selectedIds.add(id);
    renderAll();
    updateUI();
  }

  function toggleSelect(id){
    if(state.selectedIds.has(id)) state.selectedIds.delete(id);
    else state.selectedIds.add(id);
    renderAll();
    updateUI();
  }

  // Element interactions (drag move)
  function wireElement(div){
    div.addEventListener("mousedown", (e)=>{
      e.preventDefault();
      const id = div.dataset.id;
      const multi = e.shiftKey;
      if(multi) toggleSelect(id);
      else if(!state.selectedIds.has(id)) selectOnly(id);

      const startX = e.clientX, startY = e.clientY;
      const ids = [...state.selectedIds];
      const startPos = ids.map(pid => {
        const el = getById(pid);
        return { id: pid, x: el.x, y: el.y };
      });

      const onMove = (ev)=>{
        const dx = (ev.clientX - startX) / zoom;
        const dy = (ev.clientY - startY) / zoom;
        for(const p of startPos){
          const el = getById(p.id);
          el.x = Math.round(p.x + dx);
          el.y = Math.round(p.y + dy);
        }
        renderAll();
        updateUI();
      };
      const onUp = ()=>{
        window.removeEventListener("mousemove", onMove);
        window.removeEventListener("mouseup", onUp);
        snapshot();
        scheduleAutosave();
      };
      window.addEventListener("mousemove", onMove);
      window.addEventListener("mouseup", onUp);
    });
  }

  // Panels tabs content
  const leftData = {
    templates: [
      { t:"Instagram Post", d:"1080√ó1080 modern layout" },
      { t:"YouTube Thumbnail", d:"Bold headline + image zone" },
      { t:"Flyer", d:"A4 / Letter ready for print" },
      { t:"Business Card", d:"Clean premium brand card" },
      { t:"Story", d:"1080√ó1920 vertical" },
    ],
    layers: [],
    assets: [
      { t:"Shapes Pack", d:"Modern blobs & lines" },
      { t:"Gradients", d:"Premium backgrounds" },
      { t:"Icons", d:"Minimal icon set" },
    ]
  };

  function refreshLeft(){
    const active = $("#leftTabs .chip.active")?.dataset.tab || "templates";
    // layers reflect elements
    leftData.layers = state.elements.map((e, idx)=>({ t: e.title || `Layer ${idx+1}`, d: `x:${e.x} y:${e.y} ‚Ä¢ ${e.w}√ó${e.h}` , id: e.id }));
    const q = ($("#leftSearch").value || "").toLowerCase().trim();
    const list = $("#leftList");
    list.innerHTML = "";
    for(const it of leftData[active]){
      const show = !q || (it.t.toLowerCase().includes(q) || it.d.toLowerCase().includes(q));
      if(!show) continue;
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `<b>${escapeHtml(it.t)}</b><span>${escapeHtml(it.d)}</span>`;
      div.addEventListener("click", ()=>{
        if(active === "templates"){
          // load template preset
          if(it.t.includes("Story")) resizeCanvas(900, 1400);
          else if(it.t.includes("Flyer")) resizeCanvas(900, 1200);
          else resizeCanvas(980, 620);
        }else if(active === "layers" && it.id){
          selectOnly(it.id);
        }else if(active === "assets"){
          addElement(120, 120, 260, 120, it.t, it.d);
        }
      });
      list.appendChild(div);
    }
  }

  function resizeCanvas(w,h){
    // simple: change canvas size by modifying base dims used in renderAll
    // We'll store in state as special element? Keep lightweight: store in localStorage
    localStorage.setItem("templify_canvas_size", JSON.stringify({w,h}));
    baseCanvas.w = w; baseCanvas.h = h;
    snapshot();
    renderAll();
    scheduleAutosave();
  }

  const baseCanvas = { w: 980, h: 620 };
  function loadCanvasSize(){
    try{
      const s = JSON.parse(localStorage.getItem("templify_canvas_size")||"null");
      if(s?.w && s?.h){ baseCanvas.w = s.w; baseCanvas.h = s.h; }
    }catch(e){}
  }

  // Override renderAll to use baseCanvas
  const _renderAll = renderAll;
  renderAll = function(){
    const kids = [...canvas.children].filter(n => n !== gridOverlay);
    kids.forEach(n => n.remove());
    gridOverlay.style.display = gridOn ? "block" : "none";
    canvas.style.transform = `scale(${zoom})`;
    canvas.style.width = `${baseCanvas.w}px`;
    canvas.style.height = `${baseCanvas.h}px`;

    for(const el of state.elements){
      const div = document.createElement("div");
      div.className = "el";
      div.dataset.id = el.id;
      div.style.left = el.x + "px";
      div.style.top = el.y + "px";
      div.style.width = el.w + "px";
      div.style.height = el.h + "px";
      div.innerHTML = `<h4>${escapeHtml(el.title)}</h4><p>${escapeHtml(el.sub)}</p>`;
      if(state.selectedIds.has(el.id)) div.classList.add("selected");
      canvas.appendChild(div);
      wireElement(div);
    }
    refreshLeft();
  }

  // Splitter drag resize
  function wireSplitter(splitter, side){
    let dragging = false;
    splitter.addEventListener("mousedown", (e)=>{
      dragging = true;
      e.preventDefault();
      document.body.style.cursor = "col-resize";
    });
    window.addEventListener("mousemove", (e)=>{
      if(!dragging) return;
      const rect = document.body.getBoundingClientRect();
      if(side === "left"){
        const w = Math.max(240, Math.min(420, e.clientX));
        document.documentElement.style.setProperty("--leftW", w + "px");
      }else{
        const w = Math.max(260, Math.min(460, rect.width - e.clientX));
        document.documentElement.style.setProperty("--rightW", w + "px");
      }
    });
    window.addEventListener("mouseup", ()=>{
      if(!dragging) return;
      dragging = false;
      document.body.style.cursor = "";
    });
  }

  // Toolbar actions
  $("#backBtn").addEventListener("click", ()=>{ window.location.href = "index.html"; });
  $("#themeBtn").addEventListener("click", ()=>{
    const cur = document.body.getAttribute("data-theme") || "dark";
    setTheme(cur==="dark" ? "light" : "dark");
  });

  $("#addBtn").addEventListener("click", ()=> addElement(140, 140, 300, 140, "New Card", "Edit me from the Properties panel."));
  $("#duplicateBtn").addEventListener("click", ()=> duplicateSelected());
  $("#deleteBtn").addEventListener("click", ()=> deleteSelected());

  $("#undoBtn").addEventListener("click", undo);
  $("#redoBtn").addEventListener("click", redo);

  $("#zoomInBtn").addEventListener("click", ()=> setZoom(zoom * 1.1));
  $("#zoomOutBtn").addEventListener("click", ()=> setZoom(zoom / 1.1));

  $("#toggleGridBtn").addEventListener("click", ()=>{
    gridOn = !gridOn;
    snapshot();
    renderAll();
    updateUI();
    scheduleAutosave();
  });

  $("#exportBtn").addEventListener("click", exportDoc);

  // Properties bindings
  function bindProp(id, fn){
    const el = $(id);
    el.addEventListener("input", ()=>{
      const sel = getSingleSelected();
      if(!sel) return;
      fn(sel, el.value);
      renderAll();
      scheduleAutosave();
    });
    el.addEventListener("change", ()=>{
      snapshot();
    });
  }

  bindProp("#propX", (s,v)=> s.x = parseInt(v||"0",10) || 0);
  bindProp("#propY", (s,v)=> s.y = parseInt(v||"0",10) || 0);
  bindProp("#propW", (s,v)=> s.w = Math.max(80, parseInt(v||"0",10) || 80));
  bindProp("#propH", (s,v)=> s.h = Math.max(60, parseInt(v||"0",10) || 60));
  bindProp("#propTitle", (s,v)=> s.title = String(v||""));
  bindProp("#propSub", (s,v)=> s.sub = String(v||""));

  // Keyboard shortcuts
  window.addEventListener("keydown", (e)=>{
    const isMac = navigator.platform.toLowerCase().includes("mac");
    const ctrl = isMac ? e.metaKey : e.ctrlKey;

    if(ctrl && (e.key.toLowerCase()==="d")){
      e.preventDefault();
      duplicateSelected();
    }
    if(ctrl && (e.key.toLowerCase()==="z")){
      e.preventDefault();
      undo();
    }
    if(ctrl && (e.key.toLowerCase()==="y")){
      e.preventDefault();
      redo();
    }
    if(e.key==="Delete"){
      deleteSelected();
    }
  });

  // Click empty canvas to clear selection
  canvas.addEventListener("mousedown", (e)=>{
    if(e.target === canvas || e.target === gridOverlay){
      state.selectedIds.clear();
      renderAll();
      updateUI();
    }
  });

  function duplicateSelected(){
    const ids = [...state.selectedIds];
    if(ids.length===0) return;
    const newIds = [];
    for(const id of ids){
      const src = getById(id);
      if(!src) continue;
      const copy = { ...src, id: uid(), x: src.x + 24, y: src.y + 24 };
      state.elements.push(copy);
      newIds.push(copy.id);
    }
    snapshot();
    state.selectedIds = new Set(newIds);
    renderAll();
    updateUI();
    scheduleAutosave();
  }

  function deleteSelected(){
    const ids = new Set(state.selectedIds);
    if(ids.size===0) return;
    state.elements = state.elements.filter(e => !ids.has(e.id));
    state.selectedIds.clear();
    snapshot();
    renderAll();
    updateUI();
    scheduleAutosave();
  }

  function setZoom(z){
    zoom = Math.max(0.35, Math.min(2.2, z));
    renderAll();
    updateUI();
  }

  function undo(){
    if(state.history.length<=1) return;
    const cur = state.history.pop();
    state.future.push(cur);
    const prev = state.history[state.history.length-1];
    restore(prev);
    scheduleAutosave();
  }

  function redo(){
    if(state.future.length===0) return;
    const snap = state.future.pop();
    state.history.push(snap);
    restore(snap);
    scheduleAutosave();
  }

  function exportDoc(){
    const payload = {
      v: 1,
      exportedAt: new Date().toISOString(),
      title: $("#docTitle").textContent,
      canvas: { w: baseCanvas.w, h: baseCanvas.h, zoom },
      elements: state.elements
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "templify_export.json";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // Left tabs
  $("#leftTabs").addEventListener("click", (e)=>{
    const chip = e.target.closest(".chip");
    if(!chip) return;
    $$("#leftTabs .chip").forEach(c => c.classList.remove("active"));
    chip.classList.add("active");
    refreshLeft();
  });

  $("#leftSearch").addEventListener("input", refreshLeft);

  // Wire splitters
  wireSplitter($("#splitLeft"), "left");
  wireSplitter($("#splitRight"), "right");

  // Boot
  loadCanvasSize();
  snapshot(); // initial empty
  loadAutosaveOrSeed();
  refreshLeft();
  updateUI();
})();
</script>

<script>
// Nexora Style Renderer v1
setTimeout(() => {
  document.querySelectorAll('.el').forEach(el => {
    const h = el.querySelector('h4');
    const p = el.querySelector('p');
    if(h){
      h.style.fontSize = (el.dataset.fontSize || 36) + 'px';
      h.style.fontWeight = el.dataset.fontWeight || 700;
    }
    if(p){
      p.style.fontSize = (el.dataset.fontSize || 18) + 'px';
    }
  });
}, 50);
</script>

</body>
</html>
