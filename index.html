<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Templify â€“ Dark Premium AI Template Generator</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#0b5fff;
      --muted:#aab0bd;

      /* DARK (transparent) */
      --bg:#050712;
      --panel:rgba(15,18,32,.55);
      --panel2:rgba(15,18,32,.35);
      --stroke:rgba(255,255,255,.10);
      --text:#f6f7fb;

      --shadow:0 18px 50px rgba(0,0,0,.45);
      --radius:18px;
    }
    [data-theme="light"]{
      --bg:#f5f7ff;
      --panel:rgba(255,255,255,.72);
      --panel2:rgba(255,255,255,.55);
      --stroke:rgba(10,20,60,.12);
      --text:#0b1020;
      --shadow:0 18px 40px rgba(10,20,60,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(11,95,255,.22), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(136,71,255,.18), transparent 55%),
        radial-gradient(900px 600px at 35% 95%, rgba(0,225,255,.10), transparent 55%),
        var(--bg);
      overflow-x:hidden;
    }

    .wrap{max-width:1200px;margin:0 auto;padding:26px 18px 60px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--stroke);
      background:var(--panel);
      backdrop-filter: blur(16px);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      position:sticky;top:14px;z-index:20;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg, rgba(11,95,255,.95), rgba(136,71,255,.88));
      box-shadow:0 10px 26px rgba(11,95,255,.28);
      border:1px solid rgba(255,255,255,.18);
    }
    .brand h1{font-size:15px;margin:0;font-weight:700;letter-spacing:.2px}
    .brand p{margin:0;color:var(--muted);font-size:12px}
    .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .btn{
      appearance:none;border:1px solid var(--stroke);
      background:var(--panel2);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      font-weight:600;font-size:12.5px;
      cursor:pointer;transition:.15s ease;
      backdrop-filter: blur(16px);
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(11,95,255,.35)}
    .btn.primary{
      background:linear-gradient(135deg, rgba(11,95,255,.95), rgba(136,71,255,.85));
      border-color:rgba(255,255,255,.14);
      box-shadow:0 12px 30px rgba(11,95,255,.22);
    }
    .btn:active{transform:translateY(0px)}
    .tag{
      padding:6px 10px;border:1px solid var(--stroke);
      background:var(--panel2);
      border-radius:999px;font-size:12px;color:var(--muted)
    }

    main{margin-top:18px;display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
    .card{
      border:1px solid var(--stroke);
      background:var(--panel);
      backdrop-filter: blur(16px);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .hero{padding:26px}
    .hero h2{margin:0 0 10px;font-size:34px;line-height:1.12}
    .hero p{margin:0 0 16px;color:var(--muted);font-size:14px;line-height:1.55}
    .grid{
      display:grid;grid-template-columns:repeat(3,minmax(0,1fr));
      gap:12px;margin-top:18px
    }
    .tile{
      padding:14px;border:1px solid var(--stroke);
      background:var(--panel2);
      border-radius:16px;
      min-height:92px;
      position:relative;
      overflow:hidden;
    }
    .thumb{
      height:84px;
      border-radius:12px;
      margin-bottom:10px;
      position:relative;
      background:
        radial-gradient(160px 80px at 20% 20%, rgba(11,95,255,.24), transparent 60%),
        radial-gradient(140px 90px at 90% 35%, rgba(136,71,255,.18), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.14);
    }
    [data-theme="light"] .thumb{
      background:
        radial-gradient(160px 80px at 20% 20%, rgba(11,95,255,.14), transparent 60%),
        radial-gradient(140px 90px at 90% 35%, rgba(136,71,255,.10), transparent 60%),
        linear-gradient(135deg, rgba(10,20,60,.06), rgba(10,20,60,.02));
      border:1px solid rgba(10,20,60,.12);
    }
    .mini{
      position:absolute;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.10);
    }
    [data-theme="light"] .mini{
      border:1px solid rgba(10,20,60,.12);
      background:rgba(10,20,60,.06);
    }
    .tile b{display:block;font-size:12.5px;margin-bottom:6px}
    .tile span{font-size:12px;color:var(--muted);line-height:1.35}
    .right{padding:18px}
    .right h3{margin:2px 0 10px;font-size:14px}
    .field{margin:10px 0}
    .field label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    .field input,.field select,.field textarea{
      width:100%;padding:11px 12px;border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.10);
      color:var(--text);
      outline:none;
    }
    [data-theme="light"] .field input,
    [data-theme="light"] .field select,
    [data-theme="light"] .field textarea{
      background:rgba(255,255,255,.50);
    }
    textarea{min-height:96px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .foot{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 18px;border-top:1px solid var(--stroke);
      color:var(--muted);font-size:12px
    }

    @media (max-width: 980px){
      main{grid-template-columns:1fr}
      .hero h2{font-size:28px}
      .grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media (max-width: 520px){
      header{position:relative;top:auto}
      .grid{grid-template-columns:1fr}
      .row{grid-template-columns:1fr}
    }
  
    /* FIX: dropdown options visibility + borders */
    
    select{
      border:1px solid rgba(10,20,60,.45);
      background:#ffffff;
      color:#0b1020;
    }
    select option{
      color:#0b1020;
      background:#ffffff;
    }
    [data-theme="dark"] select{
      border:1px solid rgba(255,255,255,.25);
      background:#0b1020;
      color:#ffffff;
    }
    [data-theme="dark"] select option{
      color:#ffffff;
      background:#0b1020;
    }
    
    [data-theme="dark"] select option{color:#ffffff;background:#0b1020;}
    
/* === Nexora Canva-style previews === */
.tile .preview-canvas{
  position: relative;
  height: 120px;
  border-radius: 14px;
  overflow: hidden;
  background: rgba(255,255,255,.06);
  border: 1px solid var(--stroke);
  margin-bottom: 10px;
}
.tile .preview-canvas .pv-text{
  position:absolute;
  left:12px;
  right:12px;
  font-weight:700;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

</style>
    
</head>

<body data-theme="dark">
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Templify</h1>
          <p>Dark Premium AI Template Generator + Ultimate Editor v1</p>
        </div>
      </div>

      <div class="actions">
        <span class="tag">No auth â€¢ No subscriptions â€¢ Netlify-ready</span>
        <button class="btn" id="themeBtn" type="button">ðŸŒ— Toggle theme</button>
        <button class="btn primary" id="openEditor" type="button">Open Editor</button>
        <button class="btn" id="btnTemplates" type="button">ðŸ“š Library</button>
        <button class="btn" id="btnAnimate" type="button">ðŸŽ¬ Animate</button>

      </div>
    </header>

    <main>
      <section class="card hero">
        <h2>Create hundreds of premium templates in minutes.</h2>
        <p>
          Generate designs fast, then fineâ€‘tune in the editor with a Canvaâ€‘style workflow:
          layers, properties, snap grid, multiâ€‘select, duplicate, undo/redo, and autosave.
        </p>

        <div class="actions" style="margin-top:14px">
          <button class="btn primary" id="generateBtn" type="button">âš¡ Generate Templates</button>
        <button class="btn" id="newLayoutBtn" type="button">ðŸ§© New Layout</button>
        <button class="btn" id="newStyleBtn" type="button">ðŸŽ¨ New Style</button>

          <button class="btn" id="exportBtn" type="button">â¬‡ Export List (JSON)</button>
        </div>

        <div class="grid" id="previewGrid" aria-live="polite" style="margin-top:18px"></div>
      </section>

      <aside class="card right">
        <h3>Generation settings</h3>

        <div class="field">
          <label>Category</label>
          <select id="cat">
            <option>Instagram Post</option>
            <option>YouTube Thumbnail</option>
            <option>Flyer</option>
            <option>Business Card</option>
            <option>Logo</option>
            <option>Presentation Slide</option>
            <option>Resume</option>
            <option>Poster</option>
            <option>Story</option>
          </select>
        </div>

        <div class="row">
          <div class="field">
            <label>Count (max 200)</label>
            <input id="count" type="number" min="1" max="200" value="24" />
          </div>
          <div class="field">
            <label>Style</label>
            <select id="style">
              <option>Dark Premium</option>
              <option>Light Minimal</option>
              <option>Neon</option>
              <option>Glassmorphism</option>
              <option>Corporate</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label>Prompt</label>
          <textarea id="prompt" placeholder="e.g., Premium real-estate carousel for luxury apartments, bold typography, modern shapes..."></textarea>
        </div>

        <div class="field">
          <label>Notes</label>
          <input id="notes" placeholder="(optional) brand name, colors, etc." />
        </div>

        <div class="foot">
          <span>Tip: Click any preview to open it in the Editor.</span>
          <span id="status">Ready</span>
        </div>
      </aside>
    </main>
  </div>

<script>
  const $ = (s)=>document.querySelector(s);
  const grid = $("#previewGrid");
  const statusEl = $("#status");

  function setTheme(next){
    document.body.setAttribute("data-theme", next);
    localStorage.setItem("templify_theme", next);
  }
  function toggleTheme(){
    const cur = document.body.getAttribute("data-theme") || "dark";
    setTheme(cur === "dark" ? "light" : "dark");
  }

  function drawThumb(thumb, elements, bg){
    if(!thumb) return;

    // Fail-safe: never break the app if preview rendering has issues
    try{
      const W0 = 980, H0 = 620;
      thumb.innerHTML = "";
      thumb.style.position = "relative";
      thumb.style.overflow = "hidden";

      const w = Math.max(1, thumb.clientWidth || 260);
      const h = Math.max(1, thumb.clientHeight || 84);
      const sx = w / W0;
      const sy = h / H0;

      // --- background ---
      let bgCss = bg || null;
      if(!bgCss && Array.isArray(elements)){
        const bgEl = elements.find(e => String(e.type||"").toLowerCase()==="background");
        bgCss = bgEl?.fill || bgEl?.background || null;
      }
      if(bgCss){
        const s = String(bgCss);
        if(s.includes("gradient")){
          thumb.style.backgroundImage = s;
          thumb.style.backgroundColor = "";
        }else{
          thumb.style.backgroundImage = "";
          thumb.style.backgroundColor = s;
        }
      }else{
        // classy default
        thumb.style.backgroundImage = "linear-gradient(135deg, rgba(11,95,255,.55), rgba(136,71,255,.45))";
        thumb.style.backgroundColor = "";
      }

      // subtle vignette for contrast
      const vignette = document.createElement("div");
      vignette.style.position = "absolute";
      vignette.style.inset = "0";
      vignette.style.background = "radial-gradient(120px 80px at 20% 20%, rgba(255,255,255,.12), transparent 60%), linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.25))";
      vignette.style.pointerEvents = "none";
      thumb.appendChild(vignette);

      const list = Array.isArray(elements) ? elements.slice(0, 18) : [];

      // helper
      const place = (el, e) => {
        const x = Number(e.x ?? 0) * sx;
        const y = Number(e.y ?? 0) * sy;
        const ww = Number(e.w ?? e.width ?? 120) * sx;
        const hh = Number(e.h ?? e.height ?? 40) * sy;
        el.style.position = "absolute";
        el.style.left = x + "px";
        el.style.top = y + "px";
        el.style.width = Math.max(2, ww) + "px";
        el.style.height = Math.max(2, hh) + "px";
      };

      // --- render blocks first (image/cards/shapes) ---
      const blockTypes = new Set(["image","shape","card"]);
      list.filter(e => blockTypes.has(String(e.type||"").toLowerCase())).slice(0, 4).forEach((e) => {
        const type = String(e.type||"").toLowerCase();
        const d = document.createElement("div");
        place(d, e);

        const r = Number(e.radius ?? (type==="image" ? 16 : 14));
        d.style.borderRadius = Math.max(10, r * Math.min(sx,sy)) + "px";
        d.style.border = "1px solid rgba(255,255,255,.18)";
        d.style.boxShadow = "0 8px 18px rgba(0,0,0,.22)";

        if(type === "image"){
          d.style.background = e.background || "linear-gradient(135deg, rgba(255,255,255,.22), rgba(255,255,255,.06))";
        }else{
          d.style.background = e.background || "rgba(255,255,255,.10)";
        }
        d.style.backdropFilter = "blur(6px)";
        d.style.pointerEvents = "none";
        thumb.appendChild(d);
      });

      // --- badge ---
      const badge = list.find(e => String(e.type||"").toLowerCase()==="badge");
      if(badge){
        const b = document.createElement("div");
        place(b, badge);
        b.style.height = Math.max(10, Number(badge.h ?? 46) * sy) + "px";
        b.style.borderRadius = "999px";
        b.style.border = "1px solid rgba(255,255,255,.20)";
        b.style.background = "rgba(0,0,0,.18)";
        b.style.display = "flex";
        b.style.alignItems = "center";
        b.style.padding = "0 10px";
        b.style.fontSize = Math.max(9, (Number(badge.fontSize ?? 14) * Math.min(sx,sy))) + "px";
        b.style.fontWeight = String(badge.fontWeight ?? 800);
        b.style.letterSpacing = ".3px";
        b.style.color = badge.color || "rgba(255,255,255,.92)";
        b.style.textTransform = "uppercase";
        b.style.whiteSpace = "nowrap";
        b.style.overflow = "hidden";
        b.style.textOverflow = "ellipsis";
        b.textContent = (badge.title || "").toString().slice(0, 32) || "NEW";
        b.style.pointerEvents = "none";
        thumb.appendChild(b);
      }

      // --- headline + subline ---
      const heading = list.find(e => String(e.type||"").toLowerCase()==="heading") || list.find(e => String(e.type||"").toLowerCase()==="subhead");
      if(heading){
        const t = document.createElement("div");
        place(t, heading);
        t.style.height = "auto";
        t.style.maxHeight = (Math.max(18, Number(heading.h ?? 120) * sy)) + "px";
        t.style.fontWeight = String(heading.fontWeight ?? 800);
        t.style.color = heading.color || "#fff";
        t.style.fontSize = Math.max(12, (Number(heading.fontSize ?? 54) * Math.min(sx,sy))) + "px";
        t.style.lineHeight = "1.05";
        t.style.textShadow = "0 8px 18px rgba(0,0,0,.35)";
        t.style.display = "-webkit-box";
        t.style.webkitLineClamp = "2";
        t.style.webkitBoxOrient = "vertical";
        t.style.overflow = "hidden";
        t.textContent = (heading.title || "").toString().trim() || "Premium Design";
        t.style.pointerEvents = "none";
        thumb.appendChild(t);
      }

      const body = list.find(e => String(e.type||"").toLowerCase()==="text" || String(e.type||"").toLowerCase()==="subhead");
      if(body){
        const t = document.createElement("div");
        place(t, body);
        t.style.height = "auto";
        t.style.maxHeight = (Math.max(14, Number(body.h ?? 80) * sy)) + "px";
        t.style.fontWeight = "500";
        t.style.color = body.color || "rgba(255,255,255,.85)";
        t.style.fontSize = Math.max(9, (Number(body.fontSize ?? 16) * Math.min(sx,sy))) + "px";
        t.style.lineHeight = "1.15";
        t.style.display = "-webkit-box";
        t.style.webkitLineClamp = "2";
        t.style.webkitBoxOrient = "vertical";
        t.style.overflow = "hidden";
        const s = (body.sub || body.title || "").toString().trim().replace(/\s+/g," ");
        t.textContent = s.slice(0, 60);
        t.style.pointerEvents = "none";
        thumb.appendChild(t);
      }

      // --- CTA button ---
      const cta = list.find(e => String(e.type||"").toLowerCase()==="cta");
      if(cta){
        const b = document.createElement("div");
        place(b, cta);
        b.style.height = Math.max(10, Number(cta.h ?? 54) * sy) + "px";
        b.style.borderRadius = Math.max(10, Number(cta.radius ?? 16) * Math.min(sx,sy)) + "px";
        b.style.background = cta.background || "linear-gradient(135deg, rgba(11,95,255,.95), rgba(136,71,255,.85))";
        b.style.border = "1px solid rgba(255,255,255,.18)";
        b.style.boxShadow = "0 10px 20px rgba(11,95,255,.20)";
        b.style.display = "flex";
        b.style.alignItems = "center";
        b.style.justifyContent = "center";
        b.style.padding = "0 10px";
        b.style.fontSize = Math.max(9, (Number(cta.fontSize ?? 14) * Math.min(sx,sy))) + "px";
        b.style.fontWeight = String(cta.fontWeight ?? 800);
        b.style.color = cta.color || "#fff";
        b.style.whiteSpace = "nowrap";
        b.style.overflow = "hidden";
        b.style.textOverflow = "ellipsis";
        b.textContent = (cta.title || "Get Started").toString().slice(0, 22);
        b.style.pointerEvents = "none";
        thumb.appendChild(b);
      }

    }catch(err){
      console.warn("Preview render failed; using fallback boxes.", err);
      try{
        // fallback: simple minis (never crash)
        thumb.innerHTML = "";
        const w0 = 980, h0 = 620;
        const sx = (thumb.clientWidth||260) / w0;
        const sy = (thumb.clientHeight||84) / h0;
        (elements||[]).slice(0,6).forEach((e) => {
          const m = document.createElement("div");
          m.className = "mini";
          m.style.left = (Number(e.x||0)*sx) + "px";
          m.style.top = (Number(e.y||0)*sy) + "px";
          m.style.width = (Number(e.w||e.width||120)*sx) + "px";
          m.style.height = (Number(e.h||e.height||40)*sy) + "px";
          thumb.appendChild(m);
        });
      }catch(_){}
    }
  }


  function seedTemplates(n){
    grid.innerHTML = "";
    __lastTemplates = [];
    const category = $("#cat").value;
    const style = $("#style").value;

    // Simple "real" layouts for the editor (cards on canvas)
    const patterns = [
  // Instagram Post (Square)
  { name:"Bold Promo", vibe:"Modern", layout:"split", accent:"badge" },
  { name:"Minimal Quote", vibe:"Clean", layout:"center", accent:"line" },
  { name:"Product Highlight", vibe:"Vibrant", layout:"imageRight", accent:"pill" },

  // YouTube Thumbnail (16:9)
  { name:"Big Face + Text", vibe:"High Contrast", layout:"ytFace", accent:"stroke" },
  { name:"Tech Review", vibe:"Neon", layout:"ytTech", accent:"glow" },

  // Flyer / Poster (Portrait)
  { name:"Event Flyer", vibe:"Premium", layout:"flyerHero", accent:"tag" },
  { name:"Business Flyer", vibe:"Corporate", layout:"flyerSplit", accent:"curve" },

  // Business Card
  { name:"Classic Card", vibe:"Elegant", layout:"cardClassic", accent:"bar" },
  { name:"Modern Card", vibe:"Minimal", layout:"cardModern", accent:"dot" },

  // Logo
  { name:"Monogram", vibe:"Luxury", layout:"logoMono", accent:"ring" },
  { name:"Abstract Mark", vibe:"Tech", layout:"logoAbstract", accent:"gradient" },

  // Presentation Slide
  { name:"Pitch Slide", vibe:"Clean", layout:"slideSplit", accent:"footer" },
  { name:"Title Slide", vibe:"Bold", layout:"slideTitle", accent:"shape" },

  // Resume
  { name:"Resume Modern", vibe:"Professional", layout:"resumeModern", accent:"sidebar" },

  // Story (9:16)
  { name:"Story Promo", vibe:"Trendy", layout:"storyHero", accent:"sticker" }
];

    for(let i=1;i<=n;i++){
      const div = document.createElement("div");
      div.className = "tile";
      div.tabIndex = 0;

      const layoutWord = ["Bold","Clean","Modern","Vibrant","Minimal"][i%5];
      div.innerHTML = `
        <div class="thumb" aria-hidden="true"></div>
        <b>${category} #${i}</b>
        <span>${style} â€¢ ${layoutWord} layout â€¢ Click to edit</span>
      `;

      const elements = patterns[i % patterns.length](i).map(e => ({ id: (globalThis.crypto?.randomUUID?.() || (Math.random().toString(16).slice(2) + Date.now().toString(16))), ...e }));

      const thumb = div.querySelector('.thumb');
      if(thumb){
        drawThumb(thumb, elements);
      }

      const template = {
        id: `seed_${Date.now()}_${i}`,
        title: `${category} #${i}`,
        description: `${style} â€¢ ${layoutWord} layout`,
        category,
        style,
        canvas: { w: 980, h: 620 },
        elements
      };
      __lastTemplates.push(template);

      div.addEventListener("click", ()=>openEditorWith(template));
      div.addEventListener("keydown",(e)=>{ if(e.key==="Enter") openEditorWith(template); });
      grid.appendChild(div);
    }
  }

  function openEditorWith(payload){
    // payload can be {cat,style,i} OR a full template object
    const cat = payload?.category || payload?.cat || $("#cat").value;
    const style = payload?.style || $("#style").value;

    // Store draft so editor can load a REAL template (elements/positions)
    localStorage.setItem("templify_draft", JSON.stringify({
      meta: {
        cat,
        style,
        i: payload?.i || 1,
        prompt: $("#prompt").value.trim(),
        notes: $("#notes").value.trim(),
        title: payload?.title || null,
        description: payload?.description || payload?.subtitle || null,
      },
      template: payload?.elements ? payload : null,
      createdAt: Date.now()
    }));
    window.location.href = "editor.html";
  }

  // Keep latest generated templates (for tile click -> editor)
  let __lastTemplates = [];

  $("#openEditor").addEventListener("click", ()=>openEditorWith({cat:$("#cat").value, style:$("#style").value, i:1}));
  $("#themeBtn").addEventListener("click", toggleTheme);

  $("#exportBtn").addEventListener("click", ()=>{
    const items = [...grid.children].map((el, idx)=>({
      title: el.querySelector("b")?.textContent || `Template #${idx+1}`,
      desc: el.querySelector("span")?.textContent || ""
    }));
    const blob = new Blob([JSON.stringify({items}, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "templify_templates.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // restore theme + initial previews
  const saved = localStorage.getItem("templify_theme");
  if(saved==="light"||saved==="dark") setTheme(saved);
  seedTemplates(12);
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("generateBtn");
  if (!btn) {
    alert("Generate button not found. UI mismatch.");
    return;
  }

  btn.addEventListener("click", async (event) => {
currentLayout = "Modern";
currentStyle = "Dark Premium";

    const payload = {
      category: document.getElementById("cat")?.value || "Instagram Post",
      style: document.getElementById("style")?.value || "Dark Premium",
      count: parseInt(document.getElementById("count")?.value || "10", 10),
      prompt: document.getElementById("prompt")?.value || "",
      notes: document.getElementById("notes")?.value || ""
    };

    try {
      const res = await fetch("/api/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      console.log("AI RESPONSE:", data);

      // âœ… MINIMAL FIX: connect AI result to the existing renderer
      // Render AI templates into the grid
      const templates = Array.isArray(data?.templates) ? data.templates : [];
      grid.innerHTML = "";
      const cat = payload.category;
      const style = payload.style;

      // Normalize templates to our editor-friendly schema
      const normalized = (templates.length ? templates : []).map((t, i) => {
        const elements = Array.isArray(t.elements) ? t.elements : [];
        return {
          id: t.id || `ai_${Date.now()}_${i+1}`,
          title: t.title || `${cat} #${i+1}`,
          description: t.description || t.subtitle || `${style} â€¢ AI generated`,
          category: t.category || payload.category || cat,
          style: t.style || payload.style || style,
          canvas: t.canvas || { w: 980, h: 620 },
          elements: elements.map(e => ({
            id: e.id || (globalThis.crypto?.randomUUID?.() || (Math.random().toString(16).slice(2) + Date.now().toString(16))),
            type: String(e.type ?? "card"),
            x: Number(e.x ?? 80), y: Number(e.y ?? 80),
            w: Number(e.w ?? e.width ?? 420), h: Number(e.h ?? e.height ?? 120),
            title: String(e.title ?? e.text ?? (String(e.type??"").toLowerCase()==="image" ? "IMAGE" : "TEXT")),
            sub: String(e.sub ?? e.caption ?? ""),
            fontSize: (e.fontSize ?? null),
            fontWeight: (e.fontWeight ?? null),
            color: (e.color ?? null),
            align: (e.align ?? null),
            radius: (e.radius ?? null),
            fill: (e.fill ?? null),
            background: (e.background ?? null),
            opacity: (e.opacity ?? null)
          }))
        };
      });

      // Apply correct canvas sizes + attach rich thumbnail preview specs
      normalized.forEach((t,i)=>{
        applyCategoryCanvas(t);
        t.preview = buildPreviewSpec(t,i,prompt);
      });


      // If AI returned nothing usable, fall back to seeded "real" templates
      if(!normalized.length){
        seedTemplates(payload.count);
        statusEl.textContent = `Generated ${payload.count}`;
        return;
      }

      __lastTemplates = normalized;
      grid.innerHTML = "";

      __lastTemplates.forEach((t) => {
        const div = document.createElement("div");
        div.className = "tile";
        div.tabIndex = 0;
        div.innerHTML = `<div class="thumb" aria-hidden="true"></div><b>${t.title}</b><span>${t.description}</span>`;

      const thumb = div.querySelector('.thumb');
      if(thumb){
        drawThumb(thumb, t.elements, t.bg);
      }

        div.addEventListener("click", ()=>openEditorWith(t));
        div.addEventListener("keydown",(e)=>{ if(e.key==="Enter") openEditorWith(t); });
        grid.appendChild(div);
      });

      statusEl.textContent = `Generated ${__lastTemplates.length}`;
    } catch (e) {
      // âœ… Fallback: never leave user with "nothing happened"
      seedTemplates(payload.count);
    }
  });
});
</script>
<script>
  document.getElementById("btnTemplates")?.addEventListener("click", () => {
    alert("Templates Libraryâ€“ coming soon");
  });

  document.getElementById("btnAnimate")?.addEventListener("click", () => {
    alert("Animate â€“ coming soon");
  });
</script>

<script type="module">
// Nexora: New Layout + New Style (SAFE)
// UI unchanged. Only updates the preview tile text.

const layouts = ["Bold","Clean","Modern","Minimal","Vibrant"];
const styles  = ["Dark Premium","Light Minimal","Neon","Glassmorphism","Corporate"];

const grid = document.getElementById("previewGrid");
const statusEl = document.getElementById("status");

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function setStatus(msg){ if(statusEl) statusEl.textContent = msg; }

function updateTilesText({layout=null, style=null}={}){
  if(!grid) return;
  const tiles = Array.from(grid.querySelectorAll(".tile"));
  tiles.forEach((tile) => {
    const span = tile.querySelector("span");
    if(!span) return;
    const curStyle = style || (document.getElementById("style")?.value) || "Dark Premium";
    const curLayout = layout || span.textContent.match(/\b(Bold|Clean|Modern|Minimal|Vibrant)\b/)?.[0] || "Modern";
    span.textContent = `${curStyle} â€¢ ${curLayout} layout â€¢ Click to edit`;
  });
}

document.getElementById("newLayoutBtn")?.addEventListener("click", () => {
  updateTilesText({ layout: pick(layouts) });
  setStatus("New layout applied");
});

document.getElementById("newStyleBtn")?.addEventListener("click", () => {
  const s = pick(styles);
  const sel = document.getElementById("style");
  if(sel){
    const opt = Array.from(sel.options).find(o => o.textContent.trim() === s);
    if(opt) sel.value = opt.textContent.trim();
  }
  updateTilesText({ style: s });
  setStatus("New style applied");
});

</script>


<script>
// --- Real template thumbnail engine (Phase E: visible Canva-style thumbnails) ---
const CATEGORY_SIZES = {
  "Instagram Post": { w:1080, h:1080 },
  "YouTube Thumbnail": { w:1280, h:720 },
  "Flyer": { w:1080, h:1350 },
  "Business Card": { w:1050, h:600 },
  "Logo": { w:800, h:800 },
  "Presentation Slide": { w:1920, h:1080 },
  "Resume": { w:1240, h:1754 },
  "Poster": { w:1080, h:1350 },
  "Story": { w:1080, h:1920 },
  "TikTok": { w:1080, h:1920 } // if you add it later
};

function pickPalette(style, i){
  // deterministic palettes to make each template look clearly different
  const sets = [
    ["#0b1020","#101b3a","#2b6cff","#7cf6ff","#ffffff"],
    ["#0b0f1a","#1b1033","#ff3d6e","#ffd36b","#ffffff"],
    ["#071017","#0c2530","#22c55e","#a7f3d0","#ffffff"],
    ["#0d0b12","#22122c","#a855f7","#f0abfc","#ffffff"],
    ["#0b0c10","#162033","#f59e0b","#fde68a","#ffffff"],
    ["#070a12","#121a2a","#60a5fa","#93c5fd","#ffffff"],
  ];
  const s = (String(style||"") + "|" + i);
  let h=0; for(let k=0;k<s.length;k++) h = (h*31 + s.charCodeAt(k))>>>0;
  const p = sets[h % sets.length];
  return { bg1:p[0], bg2:p[1], accent:p[2], accent2:p[3], text:p[4] };
}

function safeHeadline(text){
  const t = String(text||"").trim();
  if(!t) return "New Collection";
  // shorten long prompts to a headline-like chunk
  const cleaned = t.replace(/\s+/g," ").replace(/[\r\n]+/g," ").slice(0,64);
  return cleaned.length > 34 ? cleaned.slice(0,32).trim()+"â€¦" : cleaned;
}

function buildPreviewSpec(t, i, prompt){
  const cat = t.category || "Instagram Post";
  const pal = pickPalette(t.style || t.subtitle || "Dark Premium", i);
  const headline = safeHeadline(t.title || prompt || "New Collection");
  const sub = (t.subtitle || t.style || "Dark Premium");
  const variant = (i % 6);

  // per-category layout choices (kept simple but clearly different)
  const layouts = {
    "Instagram Post": ["split","centerBadge","imageTop","diagonal","card","stack"],
    "YouTube Thumbnail": ["ytFace","ytBigText","ytSplit","ytBanner","ytBox","ytNeon"],
    "Flyer": ["flyerHero","flyerSplit","flyerCurve","flyerGrid","flyerPhoto","flyerPoster"],
    "Poster": ["posterHex","posterSplit","posterCurve","posterGrid","posterPhoto","posterMinimal"],
    "Business Card": ["cardClassic","cardModern","cardDark","cardStrip","cardLeft","cardMono"],
    "Logo": ["logoMono","logoAbstract","logoRing","logoTech","logoBadge","logoMark"],
    "Presentation Slide": ["slideSplit","slideTitle","slideAgenda","slideStats","slideQuote","slideSection"],
    "Resume": ["resumeModern","resumeSidebar","resumeMinimal","resumeTwoCol","resumeClean","resumePro"],
    "Story": ["storyHero","storySplit","storySticker","storyQuote","storyNeon","storyMinimal"]
  };

  const layout = (layouts[cat] ? layouts[cat][variant] : layouts["Instagram Post"][variant]) || "split";

  // spec is only for thumbnail rendering (does not affect editor yet)
  return {
    cat,
    layout,
    pal,
    headline,
    sub,
    cta: (["Shop Now","Get Started","Join Now","Learn More","Start Today","Download"][variant]),
    badge: (["LIMITED","NEW","PRO","HOT","2025","TREND"][variant]),
    price: (["30% OFF","$19/mo","FREE","New Drop","Limited Seats","Pro Pack"][variant])
  };
}

function applyCategoryCanvas(t){
  const s = CATEGORY_SIZES[t.category];
  if(!s) return t;
  // keep existing canvas if already correct; otherwise overwrite for correct aspect
  if(!t.canvas || !t.canvas.w || !t.canvas.h || (t.canvas.w===980 && t.canvas.h===620)){
    t.canvas = { w:s.w, h:s.h };
  }
  return t;
}

function renderPreview(canvas, t){
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);

  const p = t.preview || buildPreviewSpec(t, 0, "");
  const pal = p.pal || pickPalette(t.style || t.subtitle || "Dark Premium", 0);

  // Background
  const g = ctx.createLinearGradient(0,0,W,H);
  g.addColorStop(0, pal.bg1);
  g.addColorStop(1, pal.bg2);
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);

  // Soft vignette
  const vg = ctx.createRadialGradient(W*0.2,H*0.2,10, W*0.6,H*0.5, Math.max(W,H));
  vg.addColorStop(0, "rgba(255,255,255,0.06)");
  vg.addColorStop(1, "rgba(0,0,0,0.55)");
  ctx.fillStyle = vg;
  ctx.fillRect(0,0,W,H);

  // Helpers
  const rr = (x,y,w,h,r)=>{
    r=Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  };

  const drawBadge = (x,y,txt)=>{
    ctx.font = `700 ${Math.max(10, Math.round(W*0.04))}px Poppins,system-ui`;
    const padX = Math.round(W*0.03), padY = Math.round(H*0.02);
    const tw = ctx.measureText(txt).width;
    const bw = tw + padX*2, bh = Math.round(W*0.09);
    rr(x,y,bw,bh, bh/2);
    ctx.fillStyle = "rgba(255,255,255,0.14)";
    ctx.fill();
    rr(x,y,bw,bh, bh/2);
    ctx.strokeStyle = "rgba(255,255,255,0.18)";
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.fillStyle = pal.text;
    ctx.fillText(txt, x+padX, y+bh-padY);
  };

  const drawButton = (x,y,txt)=>{
    ctx.font = `700 ${Math.max(10, Math.round(W*0.045))}px Poppins,system-ui`;
    const padX = Math.round(W*0.05), padY = Math.round(H*0.03);
    const tw = ctx.measureText(txt).width;
    const bw = tw + padX*2, bh = Math.round(W*0.12);
    rr(x,y,bw,bh, bh/2);
    ctx.fillStyle = pal.accent;
    ctx.fill();
    ctx.fillStyle = "#06101b";
    ctx.fillText(txt, x+padX, y+bh-padY);
  };

  const wrapText = (text, x, y, maxW, lineH, maxLines)=>{
    const words = String(text||"").split(/\s+/).filter(Boolean);
    let line = "", lines = 0;
    for(let i=0;i<words.length;i++){
      const test = line ? (line+" "+words[i]) : words[i];
      if(ctx.measureText(test).width > maxW && line){
        ctx.fillText(line, x, y + lines*lineH);
        lines++; line = words[i];
        if(lines >= maxLines-1) break;
      } else {
        line = test;
      }
    }
    if(lines < maxLines) ctx.fillText(line, x, y + lines*lineH);
  };

  // Layout primitives (very visible differences)
  const layout = p.layout || "split";
  const pad = Math.round(W*0.08);
  const title = p.headline || "New Collection";
  const sub = p.sub || "Dark Premium";

  // Decorative accent shapes
  ctx.save();
  ctx.globalAlpha = 0.9;

  if(layout.includes("Neon") || layout.includes("glow")){
    ctx.shadowColor = pal.accent2;
    ctx.shadowBlur = Math.round(W*0.18);
  } else {
    ctx.shadowColor = "rgba(0,0,0,0)";
    ctx.shadowBlur = 0;
  }

  // Big accent blob
  rr(W*0.58, -H*0.18, W*0.55, H*0.55, W*0.2);
  ctx.fillStyle = "rgba(255,255,255,0.06)";
  ctx.fill();

  ctx.shadowBlur = 0;
  ctx.restore();

  // Category-specific compositions
  if(p.cat === "YouTube Thumbnail"){
    // Left: big text, Right: face/box
    rr(pad, pad, W*0.58, H*0.72, 18);
    ctx.fillStyle = "rgba(255,255,255,0.06)";
    ctx.fill();

    // "Face" placeholder
    rr(W*0.68, H*0.18, W*0.26, H*0.62, 22);
    ctx.fillStyle = "rgba(255,255,255,0.10)";
    ctx.fill();

    // Stroke
    ctx.strokeStyle = "rgba(255,255,255,0.18)";
    ctx.lineWidth = 2;
    ctx.strokeRect(W*0.68+2, H*0.18+2, W*0.26-4, H*0.62-4);

    // Text
    ctx.fillStyle = pal.text;
    ctx.font = `800 ${Math.round(W*0.11)}px Poppins,system-ui`;
    wrapText(title.toUpperCase(), pad+Math.round(W*0.04), pad+Math.round(H*0.24), W*0.50, Math.round(W*0.12), 2);

    ctx.font = `600 ${Math.round(W*0.05)}px Poppins,system-ui`;
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    wrapText(sub, pad+Math.round(W*0.04), pad+Math.round(H*0.50), W*0.50, Math.round(W*0.06), 2);

    drawBadge(pad+Math.round(W*0.04), H*0.72, p.badge || "NEW");
  }
  else if(p.cat === "Business Card"){
    // Card base
    rr(pad*0.8, pad*0.8, W-pad*1.6, H-pad*1.6, 22);
    ctx.fillStyle = "rgba(255,255,255,0.07)";
    ctx.fill();
    // Accent bar
    ctx.fillStyle = pal.accent;
    rr(pad*0.8, H-pad*1.1, W-pad*1.6, pad*0.35, 18);
    ctx.fill();
    // Logo mark
    rr(pad*1.1, pad*1.1, W*0.16, W*0.16, W*0.08);
    ctx.fillStyle = "rgba(255,255,255,0.14)";
    ctx.fill();
    // Name + title
    ctx.fillStyle = pal.text;
    ctx.font = `800 ${Math.round(W*0.08)}px Poppins,system-ui`;
    ctx.fillText(title.slice(0,14), pad*1.1, H*0.45);
    ctx.font = `600 ${Math.round(W*0.04)}px Poppins,system-ui`;
    ctx.fillStyle = "rgba(255,255,255,0.80)";
    ctx.fillText("Creative Studio", pad*1.1, H*0.55);
    // Contact lines
    ctx.fillStyle = "rgba(255,255,255,0.70)";
    ctx.font = `500 ${Math.round(W*0.035)}px Poppins,system-ui`;
    ctx.fillText("hello@nexora.app", pad*1.1, H*0.70);
    ctx.fillText("+92 300 000 0000", pad*1.1, H*0.80);
  }
  else if(p.cat === "Logo"){
    // Logo mark + word
    rr(W*0.18, H*0.18, W*0.64, H*0.64, 28);
    ctx.fillStyle = "rgba(255,255,255,0.06)";
    ctx.fill();
    ctx.save();
    ctx.translate(W*0.5, H*0.46);
    ctx.rotate(-0.15);
    rr(-W*0.18, -W*0.18, W*0.36, W*0.36, W*0.12);
    ctx.fillStyle = pal.accent;
    ctx.fill();
    ctx.restore();

    ctx.fillStyle = pal.text;
    ctx.font = `900 ${Math.round(W*0.12)}px Poppins,system-ui`;
    ctx.textAlign = "center";
    ctx.fillText((title.split(" ")[0]||"NEXORA").toUpperCase(), W*0.5, H*0.83);
    ctx.textAlign = "left";
  }
  else if(p.cat === "Presentation Slide"){
    // Split slide
    ctx.fillStyle = "rgba(255,255,255,0.06)";
    rr(pad, pad, W-pad*2, H-pad*2, 18);
    ctx.fill();
    // Left content
    ctx.fillStyle = pal.text;
    ctx.font = `900 ${Math.round(W*0.07)}px Poppins,system-ui`;
    wrapText(title, pad+Math.round(W*0.04), pad+Math.round(H*0.18), W*0.52, Math.round(W*0.08), 2);
    ctx.font = `600 ${Math.round(W*0.035)}px Poppins,system-ui`;
    ctx.fillStyle = "rgba(255,255,255,0.80)";
    ctx.fillText("â€¢ Key point 1", pad+Math.round(W*0.04), H*0.52);
    ctx.fillText("â€¢ Key point 2", pad+Math.round(W*0.04), H*0.60);
    ctx.fillText("â€¢ Key point 3", pad+Math.round(W*0.04), H*0.68);
    // Right visual
    rr(W*0.66, H*0.22, W*0.26, H*0.56, 18);
    ctx.fillStyle = "rgba(255,255,255,0.10)";
    ctx.fill();
    // Footer
    ctx.fillStyle = pal.accent;
    rr(pad, H-pad*1.1, W-pad*2, pad*0.35, 14);
    ctx.fill();
  }
  else if(p.cat === "Resume"){
    // Resume: left sidebar + sections
    rr(pad, pad, W-pad*2, H-pad*2, 18);
    ctx.fillStyle = "rgba(255,255,255,0.06)";
    ctx.fill();
    rr(pad, pad, W*0.26, H-pad*2, 18);
    ctx.fillStyle = pal.accent;
    ctx.globalAlpha = 0.22;
    ctx.fill();
    ctx.globalAlpha = 1;
    ctx.fillStyle = pal.text;
    ctx.font = `900 ${Math.round(W*0.055)}px Poppins,system-ui`;
    ctx.fillText(title.split(" ")[0] || "Hassan", pad+Math.round(W*0.03), pad+Math.round(H*0.16));
    ctx.font = `600 ${Math.round(W*0.03)}px Poppins,system-ui`;
    ctx.fillStyle = "rgba(255,255,255,0.80)";
    ctx.fillText("Product Designer", pad+Math.round(W*0.03), pad+Math.round(H*0.23));
    // Right blocks
    const bx = W*0.34, bw = W*0.58;
    const blk = (y)=>{
      rr(bx, y, bw, H*0.10, 14);
      ctx.fillStyle = "rgba(255,255,255,0.08)";
      ctx.fill();
    };
    blk(H*0.30); blk(H*0.44); blk(H*0.58); blk(H*0.72);
  }
  else if(p.cat === "Story"){
    // Story: big hero + sticker + CTA
    rr(pad, pad, W-pad*2, H-pad*2, 22);
    ctx.fillStyle = "rgba(255,255,255,0.06)";
    ctx.fill();
    rr(pad*1.2, pad*1.2, W-pad*2.4, H*0.56, 24);
    ctx.fillStyle = "rgba(255,255,255,0.10)";
    ctx.fill();
    drawBadge(pad*1.2, H*0.62, p.badge || "TREND");
    ctx.fillStyle = pal.text;
    ctx.font = `900 ${Math.round(W*0.10)}px Poppins,system-ui`;
    wrapText(title, pad*1.2, H*0.72, W-pad*2.4, Math.round(W*0.11), 2);
    drawButton(pad*1.2, H*0.86, p.cta || "Swipe Up");
  }
  else if(p.cat === "Flyer" || p.cat === "Poster"){
    // Flyer/Poster: photo left, details right
    rr(pad, pad, W-pad*2, H-pad*2, 18);
    ctx.fillStyle = "rgba(255,255,255,0.06)";
    ctx.fill();
    rr(pad*1.1, pad*1.1, W*0.46, H-pad*2.2, 18);
    ctx.fillStyle = "rgba(255,255,255,0.10)";
    ctx.fill();
    rr(W*0.58, pad*1.1, W*0.34, H*0.18, 16);
    ctx.fillStyle = pal.accent;
    ctx.globalAlpha = 0.22;
    ctx.fill();
    ctx.globalAlpha = 1;
    ctx.fillStyle = pal.text;
    ctx.font = `900 ${Math.round(W*0.075)}px Poppins,system-ui`;
    wrapText(title, W*0.58, H*0.40, W*0.34, Math.round(W*0.085), 3);
    ctx.fillStyle = "rgba(255,255,255,0.80)";
    ctx.font = `600 ${Math.round(W*0.035)}px Poppins,system-ui`;
    ctx.fillText("â€¢ Services â€¢ Pricing â€¢ Contact", W*0.58, H*0.66);
    drawButton(W*0.58, H*0.74, p.cta || "Get Started");
    drawBadge(pad*1.1, pad*1.1, p.badge || "NEW");
  }
  else {
    // Instagram Post default
    rr(pad, pad, W-pad*2, H-pad*2, 18);
    ctx.fillStyle = "rgba(255,255,255,0.06)";
    ctx.fill();

    if(layout === "centerBadge"){
      drawBadge(pad*1.1, pad*1.1, p.badge || "LIMITED");
      ctx.fillStyle = pal.text;
      ctx.font = `900 ${Math.round(W*0.10)}px Poppins,system-ui`;
      wrapText(title, pad*1.1, H*0.48, W-pad*2.2, Math.round(W*0.11), 2);
      drawButton(pad*1.1, H*0.74, p.cta || "Shop Now");
    } else {
      // image-right
      rr(W*0.58, H*0.22, W*0.30, H*0.52, 22);
      ctx.fillStyle = "rgba(255,255,255,0.10)";
      ctx.fill();
      ctx.fillStyle = pal.text;
      ctx.font = `900 ${Math.round(W*0.09)}px Poppins,system-ui`;
      wrapText(title, pad*1.1, H*0.40, W*0.44, Math.round(W*0.10), 2);
      ctx.font = `600 ${Math.round(W*0.04)}px Poppins,system-ui`;
      ctx.fillStyle = "rgba(255,255,255,0.82)";
      ctx.fillText(sub, pad*1.1, H*0.62);
      drawButton(pad*1.1, H*0.70, p.cta || "Get Started");
      drawBadge(pad*1.1, pad*1.1, p.badge || "NEW");
    }
  }

  // subtle border
  ctx.strokeStyle = "rgba(255,255,255,0.10)";
  ctx.lineWidth = 1;
  ctx.strokeRect(0.5,0.5,W-1,H-1);
}
</script>

</body>
</html>
