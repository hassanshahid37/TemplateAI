








<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nexora â€“ AI Creative Director â€“ Dark Premium AI Template Generator</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#0b5fff;
      --muted:#aab0bd;

      /* DARK (transparent) */
      --bg:#050712;
      --panel:rgba(15,18,32,.55);
      --panel2:rgba(15,18,32,.35);
      --stroke:rgba(255,255,255,.10);
      --text:#f6f7fb;

      --shadow:0 18px 50px rgba(0,0,0,.45);
      --radius:18px;
    }
    [data-theme="light"]{
      --bg:#f5f7ff;
      --panel:rgba(255,255,255,.72);
      --panel2:rgba(255,255,255,.55);
      --stroke:rgba(10,20,60,.12);
      --text:#0b1020;
      --shadow:0 18px 40px rgba(10,20,60,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(11,95,255,.22), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(136,71,255,.18), transparent 55%),
        radial-gradient(900px 600px at 35% 95%, rgba(0,225,255,.10), transparent 55%),
        var(--bg);
      overflow-x:hidden;
    }

    .wrap{max-width:1200px;margin:0 auto;padding:26px 18px 60px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--stroke);
      background:var(--panel);
      backdrop-filter: blur(16px);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      position:sticky;top:14px;z-index:20;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg, rgba(11,95,255,.95), rgba(136,71,255,.88));
      box-shadow:0 10px 26px rgba(11,95,255,.28);
      border:1px solid rgba(255,255,255,.18);
    }
    .brand h1{font-size:15px;margin:0;font-weight:700;letter-spacing:.2px}
    .brand p{margin:0;color:var(--muted);font-size:12px}
    .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .btn{
      appearance:none;border:1px solid var(--stroke);
      background:var(--panel2);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      font-weight:600;font-size:12.5px;
      cursor:pointer;transition:.15s ease;
      backdrop-filter: blur(16px);
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(11,95,255,.35)}
    .btn.primary{
      background:linear-gradient(135deg, rgba(11,95,255,.95), rgba(136,71,255,.85));
      border-color:rgba(255,255,255,.14);
      box-shadow:0 12px 30px rgba(11,95,255,.22);
    }
    .btn:active{transform:translateY(0px)}
    .tag{
      padding:6px 10px;border:1px solid var(--stroke);
      background:var(--panel2);
      border-radius:999px;font-size:12px;color:var(--muted)
    }

    main{margin-top:18px;display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
    .card{
      border:1px solid var(--stroke);
      background:var(--panel);
      backdrop-filter: blur(16px);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .hero{padding:26px}
    .hero h2{margin:0 0 10px;font-size:34px;line-height:1.12}
    .hero p{margin:0 0 16px;color:var(--muted);font-size:14px;line-height:1.55}
    .grid{
      display:grid;grid-template-columns:repeat(3,minmax(0,1fr));
      gap:12px;margin-top:18px
    }
    .tile{
      padding:14px;border:1px solid var(--stroke);
      background:var(--panel2);
      border-radius:16px;
      min-height:92px;
      position:relative;
      overflow:hidden;
    }
    .thumb{
      height:84px;
      border-radius:12px;
      margin-bottom:10px;
      position:relative;
      background:
        radial-gradient(160px 80px at 20% 20%, rgba(11,95,255,.24), transparent 60%),
        radial-gradient(140px 90px at 90% 35%, rgba(136,71,255,.18), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.14);
    }
    [data-theme="light"] .thumb{
      background:
        radial-gradient(160px 80px at 20% 20%, rgba(11,95,255,.14), transparent 60%),
        radial-gradient(140px 90px at 90% 35%, rgba(136,71,255,.10), transparent 60%),
        linear-gradient(135deg, rgba(10,20,60,.06), rgba(10,20,60,.02));
      border:1px solid rgba(10,20,60,.12);
    }
    .mini{
      position:absolute;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.10);
    }
    [data-theme="light"] .mini{
      border:1px solid rgba(10,20,60,.12);
      background:rgba(10,20,60,.06);
    }
    .tile b{display:block;font-size:12.5px;margin-bottom:6px}
    .tile span{font-size:12px;color:var(--muted);line-height:1.35}
    .right{padding:18px}
    .right h3{margin:2px 0 10px;font-size:14px}
    .field{margin:10px 0}
    .field label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    .field input,.field select,.field textarea{
      width:100%;padding:11px 12px;border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.10);
      color:var(--text);
      outline:none;
    }
    [data-theme="light"] .field input,
    [data-theme="light"] .field select,
    [data-theme="light"] .field textarea{
      background:rgba(255,255,255,.50);
    }
    textarea{min-height:96px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .foot{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 18px;border-top:1px solid var(--stroke);
      color:var(--muted);font-size:12px
    }

    @media (max-width: 980px){
      main{grid-template-columns:1fr}
      .hero h2{font-size:28px}
      .grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media (max-width: 520px){
      header{position:relative;top:auto}
      .grid{grid-template-columns:1fr}
      .row{grid-template-columns:1fr}
    }
  
    /* FIX: dropdown options visibility + borders */
    
    select{
      border:1px solid rgba(10,20,60,.45);
      background:#ffffff;
      color:#0b1020;
    }
    select option{
      color:#0b1020;
      background:#ffffff;
    }
    [data-theme="dark"] select{
      border:1px solid rgba(255,255,255,.25);
      background:#0b1020;
      color:#ffffff;
    }
    [data-theme="dark"] select option{
      color:#ffffff;
      background:#0b1020;
    }
    
    [data-theme="dark"] select option{color:#ffffff;background:#0b1020;}
    
/* === Nexora Canva-style previews === */
.tile .preview-canvas{
  position: relative;
  height: 120px;
  border-radius: 14px;
  overflow: hidden;
  background: rgba(255,255,255,.06);
  border: 1px solid var(--stroke);
  margin-bottom: 10px;
}
.tile .preview-canvas .pv-text{
  position:absolute;
  left:12px;
  right:12px;
  font-weight:700;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}


/* === Header: match editor branding (icon + stacked text) === */
.brand{display:flex;align-items:center;gap:12px}
.brandText{display:flex;flex-direction:column;gap:2px;min-width:0}
.brandText h1{margin:0;font-size:15px;font-weight:700;letter-spacing:.2px;line-height:1.1}
.brandText p{margin:0}

/* editor-like circular badge with the NEW official logo cropped to the N mark */
.logo{
  width:44px;
  height:44px;
  border-radius:14px;
  background:
    rgba(10,14,30,.92);
  border:1px solid rgba(255,255,255,.14);
  box-shadow:0 10px 26px rgba(0,0,0,.45);
  flex-shrink:0;
}

/* stacked lines like editor */
.brandTag{color:var(--muted);font-size:12px;line-height:1.2}
.brandSub{color:var(--muted);font-size:12px;line-height:1.2;opacity:.95}

/* keep header height stable on small screens */
@media (max-width:520px){
  .logo{width:40px;height:40px;border-radius:12px}
  .brandText h1{font-size:14px}
}

</style>
    

<!-- YT Preview Shell Fix (16:9 full-bleed) -->
<style>
  /* Generic preview card selectors (defensive) */
  .preview-card, .template-card, .card {
    box-sizing: border-box;
  }

  /* When YT mode is active, remove card chrome and force 16:9 */
  .yt-preview .preview-card,
  .yt-preview .template-card,
  .yt-preview .card {
    padding: 0 !important;
    border-radius: 0 !important;
    background: transparent !important;
  }

  /* Force a 16:9 viewport for thumbnails */
  .yt-preview .preview-viewport,
  .yt-preview .canvas,
  .yt-preview .thumb,
  .yt-preview .preview {
    aspect-ratio: 16 / 9;
    width: 100% !important;
    height: auto !important;
    max-width: 100%;
    overflow: hidden;
  }
</style>

</head>

<body data-theme="dark">
  <div class="wrap">
    <header>
      
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="brandText">
          <h1>Nexora</h1>
          <p class="brandTag">AI Creative Director</p>
          <p class="brandSub">Dark Premium AI Template Generator + Ultimate Editor v1</p>
        </div>
      </div>
    

      <div class="actions">
        <span class="tag">No auth â€¢ No subscriptions â€¢ Netlify-ready</span>
        <button class="btn" id="themeBtn" type="button">ðŸŒ— Toggle theme</button>
        <button class="btn primary" id="openEditor" type="button">Open Editor</button>
        <button class="btn" id="btnTemplates" type="button">ðŸ“š Library</button>
        <button class="btn" id="btnAnimate" type="button">ðŸŽ¬ Animate</button>

      </div>
    </header>

    <main>
      <section class="card hero">
        <h2>Create hundreds of premium templates in minutes.</h2>
        <p>
          Generate designs fast, then fineâ€‘tune in the editor with a Canvaâ€‘style workflow:
          layers, properties, snap grid, multiâ€‘select, duplicate, undo/redo, and autosave.
        </p>

        <div class="actions" style="margin-top:14px">
          <button class="btn primary" id="generateBtn" type="button">âš¡ Generate Templates</button>
        <button class="btn" id="newLayoutBtn" type="button">ðŸ§© New Layout</button>
        <button class="btn" id="newStyleBtn" type="button">ðŸŽ¨ New Style</button>

          <button class="btn" id="exportBtn" type="button">â¬‡ Export List (JSON)</button>
        </div>

        <div class="grid" id="previewGrid" aria-live="polite" style="margin-top:18px"></div>
      </section>

      <aside class="card right">
        <h3>Generation settings</h3>

        <div class="field">
          <label>Category</label>
          <select id="cat">
            <option>Instagram Post</option>
            <option>YouTube Thumbnail</option>
            <option>Flyer</option>
            <option>Business Card</option>
            <option>Logo</option>
            <option>Presentation Slide</option>
            <option>Resume</option>
            <option>Poster</option>
            <option>Story</option>
          </select>
        </div>

        <div class="row">
          <div class="field">
            <label>Count (max 200)</label>
            <input id="count" type="number" min="1" max="200" value="24" />
          </div>
          <div class="field">
            <label>Style</label>
            <select id="style">
              <option>Dark Premium</option>
              <option>Light Minimal</option>
              <option>Neon</option>
              <option>Glassmorphism</option>
              <option>Corporate</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label>Prompt</label>
          <textarea id="prompt" placeholder="e.g., Premium real-estate carousel for luxury apartments, bold typography, modern shapes..."></textarea>
        </div>

        <div class="field">
          <label>Notes</label>
          <input id="notes" placeholder="(optional) brand name, colors, etc." />
        </div>

        <div class="foot">
          <span>Tip: Click any preview to open it in the Editor.</span>
          <span id="status">Ready</span>
        </div>
      </aside>
    </main>
  </div>

<script>
  const $ = (s)=>document.querySelector(s);
  const grid = $("#previewGrid");
  const statusEl = $("#status");

  // Global AI commit lock: once AI templates are committed, seed/legacy renders must never run again.
  window.__NEXORA_AI_COMMITTED__ = window.__NEXORA_AI_COMMITTED__ || false;

  function setTheme(next){
    document.body.setAttribute("data-theme", next);
    localStorage.setItem("templify_theme", next);
  }
  function toggleTheme(){
    const cur = document.body.getAttribute("data-theme") || "dark";
    setTheme(cur === "dark" ? "light" : "dark");
  }

  // Phase G (Generator-side invisible editor helpers)
  // Ensures prompt meaningfully maps into template elements BEFORE rendering/opening editor.
  function applyPromptToTemplate(tpl, prompt){
    if(!tpl || !prompt) return tpl;
    const p = String(prompt).trim();
    if(!p) return tpl;

    // Title
    tpl.title = tpl.title && tpl.title.startsWith("Instagram") ? p.slice(0, 32) : (tpl.title || p.slice(0, 32));

    // Elements mapping
    const els = Array.isArray(tpl.elements) ? tpl.elements : [];
    // FIX: use the correct local list variable (was `list` which caused ReferenceError)
    const heading = els.find(e => ["heading","subhead"].includes(String(e.type||"").toLowerCase()))
        || els.find(e => String(e.type||"").toLowerCase()==="text" && (Number(e.weight||0) >= 800 || Number(e.size||0) >= 46));
    if(heading) heading.title = p.slice(0, 60);

    const body = els.find(e => String(e.type||"").toLowerCase()==="text");
    if(body) { body.subtitle = p.slice(0, 90); body.sub = body.sub ?? body.subtitle; }

    return tpl;
  }

  function applyPromptToTemplates(templates, prompt){
    if(!Array.isArray(templates)) return templates;
    templates.forEach(t => applyPromptToTemplate(t, prompt));
    return templates;
  }

  // Expose for debugging / future bridge (non-destructive)
  window.NEXORA = window.NEXORA || {};
  window.NEXORA.applyPromptToTemplates = applyPromptToTemplates;


  function drawThumb(thumb, tplOrElements, bg){
  if(!thumb) return;

  // Fail-safe: never break the app if preview rendering has issues
  try{
    const tpl = Array.isArray(tplOrElements)
      ? { elements: tplOrElements, canvas: { w: 980, h: 620 } }
      : (tplOrElements || {});
    const elements = Array.isArray(tpl.elements) ? tpl.elements : [];
    const W0 = Number(tpl?.canvas?.w || 980);
    const H0 = Number(tpl?.canvas?.h || 620);

    // Make the preview box match the template aspect ratio (critical for YouTube 16:9)
    thumb.innerHTML = "";
    thumb.style.position = "relative";
    thumb.style.overflow = "hidden";
    thumb.style.width = "100%";
    const w = Math.max(1, thumb.clientWidth || 260);
    const desiredH = Math.max(1, Math.round(w * (H0 / W0)));
    thumb.style.height = desiredH + "px";
    const h = desiredH;

    const sx = w / W0;
    const sy = h / H0;

    // --- background ---
    let bgCss = bg || null;
    if(!bgCss && Array.isArray(elements)){
      const bgEl = elements.find(e => ["background","bg"].includes(String((e.type||e.role)||"").toLowerCase()));
      bgCss = (bgEl && String(bgEl.type||"").toLowerCase()==="bg" && bgEl.style==="radial" && (bgEl.fill2||bgEl.fill))
        ? `radial-gradient(120% 90% at 20% 10%, ${bgEl.fill2||bgEl.fill}, ${bgEl.fill||bgEl.fill2})`
        : (bgEl?.fill || bgEl?.background || null);
    }
    if(bgCss){
      const s = String(bgCss);
      if(s.includes("gradient")){
        thumb.style.backgroundImage = s;
        thumb.style.backgroundColor = "";
      }else{
        thumb.style.backgroundImage = "";
        thumb.style.backgroundColor = s;
      }
    }else{
      // classy default
      thumb.style.backgroundImage = "linear-gradient(135deg, rgba(11,95,255,.55), rgba(136,71,255,.45))";
      thumb.style.backgroundColor = "";
    }

    // subtle vignette / depth
    const vignette = document.createElement("div");
    vignette.style.position = "absolute";
    vignette.style.inset = "0";
    vignette.style.background =
      "radial-gradient(140px 100px at 75% 25%, rgba(255,255,255,.10), rgba(255,255,255,0) 55%)," +
      "linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.28))";
    vignette.style.pointerEvents = "none";
    thumb.appendChild(vignette);

    const list = Array.isArray(elements)
      ? elements.slice().sort((a,b)=>{
          const za = Number((a&& (a.z ?? a.layer ?? a.order)) ?? 0);
          const zb = Number((b&& (b.z ?? b.layer ?? b.order)) ?? 0);
          return (Number.isFinite(za)?za:0) - (Number.isFinite(zb)?zb:0);
        }).slice(0, 36)
      : [];

    const toNum = (v, d=0) => {
      const n = Number(v);
      return Number.isFinite(n) ? n : d;
    };

    const place = (el, e) => {
      const x = toNum(e.x, 0) * sx;
      const y = toNum(e.y, 0) * sy;
      const ww = toNum(e.w ?? e.width, 120) * sx;
      const hh = toNum(e.h ?? e.height, 40) * sy;
      el.style.position = "absolute";
      el.style.left = x + "px";
      el.style.top = y + "px";
      el.style.width = Math.max(0, ww) + "px";
      el.style.height = Math.max(0, hh) + "px";
      if(e.r != null){
        el.style.borderRadius = (toNum(e.r, 0) * Math.min(sx, sy)) + "px";
      }
      if(e.opacity != null){
        el.style.opacity = String(e.opacity);
      }
      if(e.rotate != null){
        el.style.transform = `rotate(${toNum(e.rotate,0)}deg)`;
        el.style.transformOrigin = "center";
      }
    };

    const mkRect = (e) => {
      const d = document.createElement("div");
      place(d, e);
      if(e.fill){
        d.style.background = String(e.fill);
      }
      if(e.stroke){
        d.style.border = `${Math.max(1, Math.round(toNum(e.strokeW,2)*Math.min(sx,sy)))}px solid ${e.stroke}`;
      }
      if(e.shadow){
        d.style.boxShadow = e.shadow;
      }
      return d;
    };

    const mkPhoto = (e) => {
      const d = document.createElement("div");
      place(d, e);

      const hasSrc = !!e.src;
      if(hasSrc){
        const safe = String(e.src).replace(/"/g,'%22');
        d.style.backgroundImage = `url("${safe}")`;
        d.style.backgroundSize = e.fit || "cover";
        d.style.backgroundPosition = e.pos || "center";
        d.style.backgroundRepeat = "no-repeat";
      }else{
        // Premium placeholder (never blank)
        d.style.backgroundImage =
          "radial-gradient(220px 140px at 30% 30%, rgba(255,255,255,.14), rgba(255,255,255,0) 60%)," +
          "linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.03))";
      }

      // image treatment (Phase 2)
      // - keep it safe: if a template doesn't specify, we still add subtle depth
      const extraFilter = (e.filter || "");
      const soft = hasSrc ? "contrast(1.05) saturate(1.05)" : "blur(0.4px)";
      d.style.filter = (extraFilter ? (extraFilter + " ") : "") + soft;

      // optional vignette/overlay to match Canva-level thumbnails
      const ov = document.createElement("div");
      ov.style.position = "absolute";
      ov.style.inset = "0";
      ov.style.pointerEvents = "none";
      ov.style.background =
        "radial-gradient(120% 90% at 50% 25%, rgba(255,255,255,.08), rgba(255,255,255,0) 55%)," +
        "linear-gradient(180deg, rgba(0,0,0,.00), rgba(0,0,0,.28))";
      ov.style.mixBlendMode = "multiply";
      d.appendChild(ov);

      if(!hasSrc){
        const label = document.createElement("div");
        label.textContent = "IMAGE";
        label.style.position = "absolute";
        label.style.left = "10px";
        label.style.bottom = "10px";
        label.style.padding = "6px 10px";
        label.style.borderRadius = "999px";
        label.style.background = "rgba(0,0,0,.35)";
        label.style.border = "1px solid rgba(255,255,255,.18)";
        label.style.color = "#fff";
        label.style.fontWeight = "800";
        label.style.fontSize = Math.max(10, Math.round(12 * Math.min(sx, sy))) + "px";
        label.style.letterSpacing = "0.6px";
        label.style.textTransform = "uppercase";
        label.style.backdropFilter = "blur(3px)";
        d.appendChild(label);
      }

      if(e.stroke){
        d.style.border = `${Math.max(1, Math.round(toNum(e.strokeW,2)*Math.min(sx,sy)))}px solid ${e.stroke}`;
      }else{
        // subtle inner border like Canva cards
        d.style.boxShadow = (e.shadow || "") + (e.shadow ? "," : "") + "inset 0 0 0 1px rgba(255,255,255,.10)";
      }

      if(e.shadow){
        d.style.boxShadow = e.shadow;
      }

      return d;
    };

    const mkText = (e) => {
  const d = document.createElement("div");
  place(d, e);

  const s = e.style || {};

  // Layout
  d.style.display = "flex";
  d.style.alignItems = e.alignY || "flex-start";
  d.style.justifyContent = e.alignX || "flex-start";
  d.style.whiteSpace = "pre-wrap";
  d.style.overflow = "hidden";

  // Typography base
  const lh = (s.lineHeight != null ? s.lineHeight : (e.lineHeight || 1.05));
  d.style.lineHeight = String(lh);

  const ls = (s.letterSpacing != null ? s.letterSpacing : (e.letterSpacing != null ? e.letterSpacing : 0));
  d.style.letterSpacing = ls + "px";

  // casing priority: style-engine first, fallback to legacy uppercase flag
  if (s.casing === "uppercase") d.style.textTransform = "uppercase";
  else if (s.casing === "lowercase") d.style.textTransform = "lowercase";
  else if (s.casing === "capitalize") d.style.textTransform = "capitalize";
  else d.style.textTransform = e.uppercase ? "uppercase" : "none";

  const baseFont = (s.fontSize != null ? s.fontSize : toNum(e.size, 22));
  const fontSize0 = Math.max(10, baseFont * Math.min(sx, sy));
  d.style.fontSize = fontSize0 + "px";

  d.style.fontWeight = String(s.fontWeight || e.weight || 800);
  d.style.fontFamily = e.font || "system-ui, -apple-system, Segoe UI, Inter, Arial, sans-serif";
  d.style.color = (s.color || e.color || "#fff");

  // Alignment within box (text-align)
  const tx = (e.textAlign || s.textAlign || "");
  if(tx) d.style.textAlign = tx;

  // Background for text blocks (Canva-like label)
  // Supports e.fill for text boxes OR style.background
  const bgFill = s.background || e.fillText || null;
  if(bgFill){
    d.style.background = String(bgFill);
    d.style.padding = (s.padding != null ? s.padding : 10) * Math.min(sx, sy) + "px";
    d.style.borderRadius = ((s.radius != null ? s.radius : (e.r ?? 12)) * Math.min(sx, sy)) + "px";
    d.style.backdropFilter = "blur(2px)";
    d.style.boxShadow = (s.boxShadow || "0 10px 22px rgba(0,0,0,.22)");
  }

  // Shadow / stroke fidelity (Phase 2)
  const strokeColor = (s.strokeColor || e.stroke || null);
  const strokeW = Math.max(0, Number(s.strokeW ?? e.strokeW ?? 0));
  const shadow = (s.shadow || e.shadow || null);

  const makeStrokeShadow = (color, w) => {
    const px = Math.max(1, Math.round(w * Math.min(sx, sy)));
    const c = String(color);
    const dirs = [
      [ px, 0], [-px, 0], [0,  px], [0, -px],
      [ px, px], [ px,-px], [-px, px], [-px,-px],
    ];
    // two rings for smoother edge
    const ring2 = Math.max(1, Math.round(px * 1.6));
    const dirs2 = [
      [ ring2, 0], [-ring2, 0], [0,  ring2], [0, -ring2],
      [ ring2, ring2], [ ring2,-ring2], [-ring2, ring2], [-ring2,-ring2],
    ];
    const s1 = dirs.map(([x,y])=>`${x}px ${y}px 0 ${c}`).join(", ");
    const s2 = dirs2.map(([x,y])=>`${x}px ${y}px 0 ${c}`).join(", ");
    return s1 + ", " + s2;
  };

  let textShadow = "";
  if(strokeColor && strokeW > 0){
    textShadow = makeStrokeShadow(strokeColor, strokeW);
  }
  if(shadow){
    textShadow = (textShadow ? (textShadow + ", ") : "") + String(shadow);
  }
  if(textShadow){
    d.style.textShadow = textShadow;
  }

  // Content
  const txt = String(e.text ?? e.title ?? e.subtitle ?? e.sub ?? e.label ?? "");
  d.textContent = txt;

  // Auto-fit: shrink font until it fits box (Canva-like safety)
  const autoFit = (s.autoFit === true) || (e.autoFit === true) || (txt.length > 18 && (e.w || e.width) && (e.h || e.height));
  if(autoFit){
    // quick iterative shrink; bounded + safe
    const maxIter = 18;
    let fs = fontSize0;
    for(let i=0;i<maxIter;i++){
      if(d.scrollHeight <= d.clientHeight + 1 && d.scrollWidth <= d.clientWidth + 1) break;
      fs = Math.max(10, fs * 0.92);
      d.style.fontSize = fs + "px";
    }
  }

  return d;
};

    const mkBadge = (e) => {
      const d = document.createElement("div");
      place(d, e);
      d.style.display = "flex";
      d.style.alignItems = "center";
      d.style.justifyContent = "center";
      d.style.background = e.fill || "rgba(0,0,0,.35)";
      d.style.backdropFilter = "blur(2px)";
      d.style.color = e.color || "#fff";
      d.style.fontWeight = String(e.weight || 900);
      d.style.fontFamily = e.font || "system-ui, -apple-system, Segoe UI, Inter, Arial, sans-serif";
      d.style.fontSize = Math.max(10, toNum(e.size, 14) * Math.min(sx, sy)) + "px";
      d.style.letterSpacing = (e.letterSpacing != null ? e.letterSpacing : 0.3) + "px";
      d.style.textTransform = "uppercase";
      if(e.stroke){
        d.style.border = `${Math.max(1, Math.round(toNum(e.strokeW,2)*Math.min(sx,sy)))}px solid ${e.stroke}`;
      }
      if(e.shadow){
        d.style.boxShadow = e.shadow;
      }
      d.textContent = String(e.text || "");
      return d;
    };

    const mkPill = (e) => {
      const d = document.createElement("div");
      place(d, e);
      d.style.display = "flex";
      d.style.alignItems = "center";
      d.style.justifyContent = "center";
      d.style.background = e.fill || "rgba(255,255,255,.12)";
      d.style.color = e.color || "#fff";
      d.style.fontWeight = String(e.weight || 800);
      d.style.fontFamily = e.font || "system-ui, -apple-system, Segoe UI, Inter, Arial, sans-serif";
      d.style.fontSize = Math.max(10, toNum(e.size, 16) * Math.min(sx, sy)) + "px";
      if(e.shadow){
        d.style.boxShadow = e.shadow;
      }
      d.textContent = String(e.text || "");
      return d;
    };

    // render in order; background handled separately already
    for(const e of list){
      const type = String(e?.type || e?.role || "").toLowerCase();
      if(type === "bg" || type === "background") continue;

      let node = null;
      if(type === "shape" || type === "rect"){
        node = mkRect(e);
      }else if(type === "photo" || type === "image"){
        node = mkPhoto(e);
      }else if(type === "text" || type === "headline" || type === "subhead" || type === "heading"){
        node = mkText(e);
      }else if(type === "cta" || type === "button"){
        // Render CTAs as pills (common across many categories)
        node = mkPill(e);
      }else if(type === "badge"){
        node = mkBadge(e);
      }else if(type === "pill" || type === "chip"){
        node = mkPill(e);
      }else{
        // unknown type/role: allow fallback (text-like elements) before skipping
        node = null;
      }
      // Fallback: if element has text-like content but an unrecognized type/role, render it as text.
      if(!node){
        const _t = (e?.text ?? e?.title ?? e?.subtitle ?? e?.sub ?? e?.label);
        if(_t != null && String(_t).trim() !== "") node = mkText(e);
      }
      if(node) thumb.appendChild(node);
    }

  }catch(err){
    // silent fail: show something instead of breaking
    try{
      thumb.innerHTML = "";
      thumb.style.backgroundImage = "linear-gradient(135deg, rgba(11,95,255,.55), rgba(136,71,255,.45))";
    }catch(_){}
  }
}
// Unified preview router (no UI changes):
// Prefer Preview Renderer v1 when contract exists; fallback to legacy drawThumb otherwise.
function renderThumb(thumb, tplOrElements, bg){
  if(!thumb) return;
  try{
    const tpl = Array.isArray(tplOrElements)
      ? { elements: tplOrElements, canvas: { w: 980, h: 620 } }
      : (tplOrElements || {});
    const content = tpl && (tpl.content || tpl.doc?.content);
    const hasContent = !!(content && typeof content === "object" && (
      (typeof content.headline === "string" && content.headline.trim()) ||
      (typeof content.subhead === "string" && content.subhead.trim()) ||
      (typeof content.cta === "string" && content.cta.trim()) ||
      (typeof content.badge === "string" && content.badge.trim()) ||
      (typeof content.body === "string" && content.body.trim()) ||
      (typeof content.text === "string" && content.text.trim()) ||
      (Array.isArray(content.paragraphs) && content.paragraphs.some(p => String(p||"").trim()))
    ));

    // Use Preview Renderer v1 ONLY when a real doc/content exists.
    // Otherwise, fall back to element-based thumb renderer to avoid blank previews.
    const catName = String(tpl?.category || "").toLowerCase();
    const forceLegacy = catName.includes("flyer") || catName.includes("story");
    if(!forceLegacy && tpl && tpl.contract && hasContent && window.NexoraPreview && typeof window.NexoraPreview.renderTo === "function"){
      thumb.innerHTML = "";
      window.NexoraPreview.renderTo(thumb, { contract: tpl.contract, content });
      return;
    }
  }catch(_){}
  drawThumb(thumb, tplOrElements, bg);
}


  function seedTemplates(n){
  if (window.__NEXORA_AI_COMMITTED__) return;
grid.innerHTML = "";
    __lastTemplates = [];
    const category = $("#cat").value;
    const style = $("#style").value;
    const prompt = ($("#prompt").value || "").trim();

    // Phase I: client-side "Canva-style" generator (design.js) as the primary safe fallback.
// IMPORTANT: Keep RAW templates for correct previews + export sizing on the homepage.
if(window.NexoraDesign && typeof window.NexoraDesign.generateTemplates === "function"){
  try{
    const rawTemplates = window.NexoraDesign.generateTemplates({ category, style, prompt, count: n });
    const templates = Array.isArray(rawTemplates) ? rawTemplates : [];

    templates.forEach((t, i) => {
      const div = document.createElement("div");
      div.className = "tile";
      div.tabIndex = 0;

      const title = (t.title || (category+" #"+(i+1)));
      const desc  = (t.description || (style+" â€¢ Canva-style"));

      div.innerHTML = `<div class="thumb" aria-hidden="true"></div><b>${escapeHtml(title)}</b><span>${escapeHtml(desc)}</span>`;

      const thumb = div.querySelector(".thumb");
      if(thumb){
        // Prefer design.js renderer for non-YouTube. For YouTube, use drawThumb so backend archetype styles can show.
const isYT = String(category).toLowerCase().includes("youtube");
if(!isYT && window.NexoraDesign && typeof window.NexoraDesign.renderPreview === "function"){
  window.NexoraDesign.renderPreview(t, thumb);
}else{
  // Use our renderer (supports element.style bridge via mkText)
  renderThumb(thumb, toEditorTemplate(t), (t.bg || null));
}
      }

      __lastTemplates.push(t);               // RAW
      div.addEventListener("click", ()=>openEditorWith(t)); // conversion happens in openEditorWith()
      div.addEventListener("keydown",(e)=>{ if(e.key==="Enter") openEditorWith(t); });
      grid.appendChild(div);
    });

    statusEl.textContent = `Generated ${templates.length}`;
    return;
  }catch(e){
    // fall through to legacy seeds
  }
}

// Legacy ultra-safe seeds (never blank UI)
    const patterns = [
      (i)=> ([
        { type: "background", x:0,y:0,w:980,h:620, title:"BG", sub:"", fill:"linear-gradient(135deg,#0b5fff,#7b5cff)" },
        { type: "heading", x: 80, y: 70,  w: 820, h: 120, title: "Grow Your Brand", sub: "", fontSize: 72, fontWeight: 800, color:"#ffffff" },
        { type: "text", x: 80, y: 210, w: 620, h: 110, title: "",  sub: "Premium design with clear hierarchy and focus." },
        { type: "cta", x: 80, y: 350, w: 360, h: 110, title: "Shop Now", sub: "" },
        { type: "image", x: 520,y: 260, w: 380, h: 300, title: "", sub: "" },
      ]),
      (i)=> ([
        { type: "heading", x: 70, y: 80,  w: 420, h: 150, title: "New Collection", sub: "" },
        { type: "text", x: 70, y: 250, w: 420, h: 170, title: "",  sub: "â€¢ Premium quality\nâ€¢ Fast delivery\nâ€¢ Limited offer" },
        { type: "image", x: 520,y: 80,  w: 390, h: 360, title: "", sub: "" },
      ]),
      (i)=> ([
        { type: "badge", x: 320,y: 70,  w: 320, h: 70,  title: "LIMITED", sub: "" },
        { type: "heading", x: 160,y: 190, w: 660, h: 150, title: "Flash Sale", sub: "" },
        { type: "cta", x: 250,y: 390, w: 480, h: 90, title: "Get 30% Off", sub: "" },
      ]),
    ];

    for(let i=1;i<=n;i++){
      const div = document.createElement("div");
      div.className = "tile";
      div.tabIndex = 0;

      const layoutWord = ["Bold","Clean","Modern","Vibrant","Minimal"][i%5];
      div.innerHTML = `
        <div class="thumb" aria-hidden="true"></div>
        <b>${category} #${i}</b>
        <span>${style} â€¢ ${layoutWord} layout â€¢ Click to edit</span>
      `;

      const elements = patterns[i % patterns.length](i).map(e => ({ id: (globalThis.crypto?.randomUUID?.() || (Math.random().toString(16).slice(2) + Date.now().toString(16))), ...e }));

      const thumb = div.querySelector('.thumb');
      if(thumb){
        drawThumb(thumb, { elements, canvas: { w: 980, h: 620 } });
      }

      const template = {
        id: `seed_${Date.now()}_${i}`,
        title: `${category} #${i}`,
        description: `${style} â€¢ ${layoutWord} layout`,
        category,
        style,
        canvas: { w: 980, h: 620 },
        elements
      };
      __lastTemplates.push(template);

      div.addEventListener("click", ()=>openEditorWith(template));
      div.addEventListener("keydown",(e)=>{ if(e.key==="Enter") openEditorWith(template); });
      grid.appendChild(div);
    }
  }

function toEditorTemplate(tpl){
    if(!tpl) return tpl;
    const elements = Array.isArray(tpl.elements) ? tpl.elements : [];
    const looksLikeDesignJS = elements.some(e => ["bg","photo","pill","chip"].includes(String(e.type||"").toLowerCase()) || ("text" in (e||{}) && !("title" in (e||{}))));
    if(!looksLikeDesignJS) return tpl;

    const W = Number(tpl?.canvas?.w || 980);
    const H = Number(tpl?.canvas?.h || 620);

    const outEls = elements.map((e, idx)=> {
      const type = String(e.type||e.role||"card").toLowerCase();
      const id = e.id || (globalThis.crypto?.randomUUID?.() || (Math.random().toString(16).slice(2) + Date.now().toString(16)));
      const x = Number(e.x ?? 80), y = Number(e.y ?? 80);
      const w = Number(e.w ?? 320), h = Number(e.h ?? 120);

      let title = "";
      let sub = "";

      if(type === "text"){
        title = String(e.text ?? "");
        sub = "";
      }else if(["pill","badge","chip"].includes(type)){
        title = String(e.text ?? e.title ?? "BADGE");
      }else if(type === "button" || type === "cta"){
        title = String(e.text ?? e.title ?? "CTA");
      }else if(type === "photo" || type === "image"){
        title = "IMAGE";
        sub = String(e.label ?? "");
      }else if(type === "bg"){
        title = "BG";
      }else if(type === "shape"){
        title = "SHAPE";
      }else{
        title = String(e.title ?? "");
        sub = String(e.sub ?? "");
      }

      return { id, type, x, y, w, h, title, sub };
    });

    return {
      id: tpl.id || `tpl_${Date.now()}`,
      title: tpl.title || "Template",
      description: tpl.description || tpl.subtitle || "",
      category: tpl.category || "Instagram Post",
      style: tpl.style || "Dark Premium",
      bg: tpl.bg || null,
      canvas: tpl.canvas || { w: W, h: H },
      contract: tpl.contract || null,
      content: tpl.content || null,
      doc: tpl.doc || null,
      elements: outEls
    };
  }

function openEditorWith(payload){
    // payload can be {cat,style,i} OR a full template object
    const cat = payload?.category || payload?.cat || $("#cat").value;
    const style = payload?.style || $("#style").value;
let tpl = payload?.elements ? toEditorTemplate(payload) : null;
    // If called with settings-only payload (e.g., Open Editor button), default to latest generated template #1
    if(!tpl && Array.isArray(__lastTemplates) && __lastTemplates.length){
      tpl = toEditorTemplate(__lastTemplates[(payload?.i? (Number(payload.i)-1):0)] || __lastTemplates[0]);
    }

    // keep latest settings for editor intelligence
    try{
      localStorage.setItem("nexora_last_settings_v1", JSON.stringify({ category: cat, style, prompt: $("#prompt").value.trim(), notes: $("#notes").value.trim(), count: Number($("#count")?.value||24) }));
    }catch(e){}

    // Also store selected template in a stable key
    try{
      if(tpl) localStorage.setItem("nexora_selected_template_v1", JSON.stringify(tpl));
    }catch(e){}

    // Store draft so editor can load a REAL template (elements/positions)
    localStorage.setItem("templify_draft", JSON.stringify({
      meta: {
        cat,
        style,
        i: payload?.i || 1,
        prompt: $("#prompt").value.trim(),
        notes: $("#notes").value.trim(),
        title: (tpl?.title || payload?.title || null),
        description: (tpl?.description || payload?.description || payload?.subtitle || null),
      },
      template: tpl,
      createdAt: Date.now()
    }));

    // allow homepage to restore when user comes back from editor
    try{ sessionStorage.setItem("nexora_restore_home_v1","1"); }catch(_){}
    try{ saveHomeState && saveHomeState(); }catch(_){}
    window.location.href = location.origin + "/editor.html";
  }

  // Keep latest generated templates (for tile click -> editor)
  let __lastTemplates = [];

  // --- Homepage state persistence (restore after returning from editor) ---
  const HOME_STATE_KEY = "nexora_home_state_v1";

  function getNavType(){
    try{
      const nav = performance.getEntriesByType && performance.getEntriesByType("navigation");
      if(nav && nav[0] && nav[0].type) return nav[0].type;
    }catch(_){}
    try{
      if(performance && performance.navigation){
        const t = performance.navigation.type;
        if(t === 1) return "reload";
        if(t === 2) return "back_forward";
      }
    }catch(_){}
    return "navigate";
  }

  function saveHomeState(){
    try{
      const catEl = document.getElementById("cat");
      const countEl = document.getElementById("count");
      const styleEl = document.getElementById("style");
      const promptEl = document.getElementById("prompt");
      const notesEl = document.getElementById("notes");
      const state = {
        v: 1,
        ts: Date.now(),
        scrollY: window.scrollY || 0,
        settings: {
          cat: catEl ? catEl.value : "",
          count: countEl ? (Number(countEl.value||1) || 1) : 1,
          style: styleEl ? styleEl.value : "",
          prompt: promptEl ? (promptEl.value||"") : "",
          notes: notesEl ? (notesEl.value||"") : ""
        },
        templates: Array.isArray(__lastTemplates) ? __lastTemplates : []
      };
      sessionStorage.setItem(HOME_STATE_KEY, JSON.stringify(state));
    }catch(_){}
  }

  function loadHomeState(){
    try{
      const raw = sessionStorage.getItem(HOME_STATE_KEY);
      if(!raw) return null;
      const st = JSON.parse(raw);
      if(!st || !Array.isArray(st.templates) || !st.settings) return null;
      return st;
    }catch(_){ return null; }
  }

  function clearHomeState(){
    try{ sessionStorage.removeItem(HOME_STATE_KEY); }catch(_){}
    try{ sessionStorage.removeItem("nexora_restore_home_v1"); }catch(_){}
  }

  
function renderTemplatesFromList(list){
    const grid = document.getElementById("previewGrid");
    if(!grid) return;

    grid.innerHTML = "";
    __lastTemplates = [];

    (list||[]).forEach((t, i)=>{
      if(!t) return;

      // Keep RAW templates; convert only when opening the editor.
      __lastTemplates.push(t);

      const div = document.createElement("div");
      div.className = "tile";
      div.tabIndex = 0;

      const title = ((window.__NEXORA_AI_COMMITTED__ && t.category) ? (t.category + ' #' + (i+1)) : (t.title || ((t.category||'Template') + ' #' + (i+1))));
      const desc = (t.description || ((t.style||"")+" â€¢ Canva-style")).trim();

      div.innerHTML = `<div class="thumb" aria-hidden="true"></div><b>${escapeHtml(title)}</b><span>${escapeHtml(desc)}</span>`;

      const thumb = div.querySelector(".thumb");
      if(thumb){
        const cat = String(t.category || document.getElementById("cat")?.value || "");
        const isYT = cat.toLowerCase().includes("youtube");
        const hasStyle = Array.isArray(t.elements) && t.elements.some(e => e && typeof e === "object" && e.style);
        const hasContract = !!t.contract;

        const tpl = toEditorTemplate(t);

        // SINGLE AUTHORITY ROUTING:
        // - Contract ALWAYS uses unified renderer
        // - After AI commit, legacy renderer is NEVER allowed (prevents renderer fights / flashing)
        if (hasContract || window.__NEXORA_AI_COMMITTED__) {
          renderThumb(thumb, tpl, tpl.bg);
        } else if (!isYT && !hasStyle && window.NexoraDesign && typeof window.NexoraDesign.renderPreview === "function") {
          window.NexoraDesign.renderPreview(t, thumb);
        } else {
          renderThumb(thumb, tpl, tpl.bg);
        }
      }

      div.addEventListener("click", ()=>openEditorWith(t));
      div.addEventListener("keydown",(e)=>{ if(e.key==="Enter") openEditorWith(t); });
      grid.appendChild(div);
    });

    // expose for debugging
    window.NEXORA = window.NEXORA || {};
    window.NEXORA.lastTemplates = __lastTemplates;
  }

  function tryRestoreHome(){
    // only restore when we explicitly came back from editor; refresh should reset
    const navType = getNavType();
    if(navType === "reload"){ clearHomeState(); return false; }

    try{
      const flag = sessionStorage.getItem("nexora_restore_home_v1");
      if(!flag) return false;

      const st = loadHomeState();
      if(!st) { sessionStorage.removeItem("nexora_restore_home_v1"); return false; }

      const catEl = document.getElementById("cat");
      const countEl = document.getElementById("count");
      const styleEl = document.getElementById("style");
      const promptEl = document.getElementById("prompt");
      const notesEl = document.getElementById("notes");

      if(catEl && st.settings.cat) catEl.value = st.settings.cat;
      if(countEl && st.settings.count) countEl.value = String(st.settings.count);
      if(styleEl && st.settings.style) styleEl.value = st.settings.style;
      if(promptEl) promptEl.value = st.settings.prompt || "";
      if(notesEl) notesEl.value = st.settings.notes || "";

      // If restored templates include contract/doc/content, treat as AI-committed so seed can't overwrite.
      try{
        window.__NEXORA_AI_COMMITTED__ = Array.isArray(st.templates) && st.templates.some(t => t && (t.contract || t.doc || t.content));
      }catch(_){ window.__NEXORA_AI_COMMITTED__ = window.__NEXORA_AI_COMMITTED__ || false; }

      renderTemplatesFromList(st.templates);

      requestAnimationFrame(()=>{ try{ window.scrollTo(0, st.scrollY||0); }catch(_){} });

      sessionStorage.removeItem("nexora_restore_home_v1");
      return true;
    }catch(_){
      try{ sessionStorage.removeItem("nexora_restore_home_v1"); }catch(__){}
      return false;
    }
  }

  function escapeHtml(s){
    return String(s||"")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }


  $("#openEditor").addEventListener("click", (ev)=>{
    ev.preventDefault();
    // If user didn't click a preview tile, open the latest generated template #1 (fallback to seeded)
    const first = (Array.isArray(__lastTemplates) && __lastTemplates.length ? __lastTemplates[0] : null)
      || (Array.isArray(seedTemplates) ? seedTemplates[0] : null);
    openEditorWith(first || {cat:$("#cat").value, style:$("#style").value, i:1});
  });
  $("#themeBtn").addEventListener("click", toggleTheme);

  $("#exportBtn").addEventListener("click", ()=>{
    const items = [...grid.children].map((el, idx)=>({
      title: el.querySelector("b")?.textContent || `Template #${idx+1}`,
      desc: el.querySelector("span")?.textContent || ""
    }));
    const blob = new Blob([JSON.stringify({items}, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "templify_templates.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // restore theme + initial previews
  const saved = localStorage.getItem("templify_theme");
  if(saved==="light"||saved==="dark") setTheme(saved);
  // initial previews are rendered on DOMContentLoaded so restore can win
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Globals used by some UI modules (avoid ReferenceError)
  let currentLayout = "";
  let currentStyle = "";
    const restored = tryRestoreHome();
    if(!restored){ seedTemplates(12); }

  const btn = document.getElementById("generateBtn");
  if (!btn) {
    alert("Generate button not found. UI mismatch.");
    return;
  }

  btn.addEventListener("click", async (event) => {
  // New generation cycle: allow seed before AI, then lock after AI commit
  window.__NEXORA_AI_COMMITTED__ = false;
currentLayout = "Modern";
currentStyle = "Dark Premium";

    const payload = {
      category: document.getElementById("cat")?.value || "Instagram Post",
      style: document.getElementById("style")?.value || "Dark Premium",
      count: parseInt(document.getElementById("count")?.value || "10", 10),
      prompt: document.getElementById("prompt")?.value || "",
      notes: document.getElementById("notes")?.value || ""
    };

    try {
      // Instant client-side templates (design.js) â€” never blocks UI.
      // Use the requested count for ALL categories (YouTube included)
      if (!window.__NEXORA_AI_COMMITTED__) seedTemplates(payload.count);
      try{ saveHomeState(); }catch(_){ }
      statusEl.textContent = `Generated ${payload.count}`;

      // Optional backend copy enrichment (fire-and-forget). Never blocks and never throws.
      fetch("/api/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...payload, count: payload.count, mode: "templates" })
      }).then(res => {
        if(!res || !res.ok) return null;
        return res.json().catch(() => null);
      }).then(data => {
    if(!data || !Array.isArray(data.templates) || !data.templates.length) return;

    // Replace seeded templates with REAL backend templates (archetypes + style-engine).
    window.__NEXORA_AI_COMMITTED__ = true;
    __lastTemplates = data.templates;

    // Re-render the grid using the same UI (template boxes remain identical).
    renderTemplatesFromList(__lastTemplates);

    try{ saveHomeState(); }catch(_){}

    statusEl.textContent = `Generated ${__lastTemplates.length} (AI templates)`;
  }).catch(() => {});

} catch (e) {
      // âœ… Fallback: never leave user with "nothing happened"
      if (!window.__NEXORA_AI_COMMITTED__) seedTemplates(payload.count);
    }
  });
});
</script>
<script>
  document.getElementById("btnTemplates")?.addEventListener("click", () => {
    alert("Templates Libraryâ€“ coming soon");
  });

  document.getElementById("btnAnimate")?.addEventListener("click", () => {
    alert("Animate â€“ coming soon");
  });
</script>

<script type="module">
// Nexora: New Layout + New Style (SAFE)
// UI unchanged. Only updates the preview tile text.

const layouts = ["Bold","Clean","Modern","Minimal","Vibrant"];
const styles  = ["Dark Premium","Light Minimal","Neon","Glassmorphism","Corporate"];

const grid = document.getElementById("previewGrid");
const statusEl = document.getElementById("status");

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function setStatus(msg){ if(statusEl) statusEl.textContent = msg; }

function updateTilesText({layout=null, style=null}={}){
  if(!grid) return;
  const tiles = Array.from(grid.querySelectorAll(".tile"));
  tiles.forEach((tile) => {
    const span = tile.querySelector("span");
    if(!span) return;
    const curStyle = style || (document.getElementById("style")?.value) || "Dark Premium";
    const curLayout = layout || span.textContent.match(/\b(Bold|Clean|Modern|Minimal|Vibrant)\b/)?.[0] || "Modern";
    span.textContent = `${curStyle} â€¢ ${curLayout} layout â€¢ Click to edit`;
  });
}

document.getElementById("newLayoutBtn")?.addEventListener("click", () => {
  updateTilesText({ layout: pick(layouts) });
  setStatus("New layout applied");
});

document.getElementById("newStyleBtn")?.addEventListener("click", () => {
  const s = pick(styles);
  const sel = document.getElementById("style");
  if(sel){
    const opt = Array.from(sel.options).find(o => o.textContent.trim() === s);
    if(opt) sel.value = opt.textContent.trim();
  }
  updateTilesText({ style: s });
  setStatus("New style applied");
});

</script>


<script>
function renderPreview(canvas, t){
  if(!canvas) return;
  canvas.innerHTML="";
  if(t.bg) canvas.style.background=t.bg;
  const texts=(t.elements||[]).filter(e=>e.type==="heading"||e.type==="text").slice(0,2);
  texts.forEach((e,i)=>{
    const d=document.createElement("div");
    d.className="pv-text";
    d.textContent=(e.text ?? e.title ?? "");
    d.style.top=(14+i*32)+"px";
    d.style.fontSize=(i===0?16:12)+"px";
    d.style.color=e.color||"#fff";
    canvas.appendChild(d);
  });
}
</script>



<script>
// Inlined CategorySpecV1 to avoid 404s on static deploys.
// Source: category-spec-v1.js (P5.1)
/**
 * Nexora P5.1 â€“ CategorySpecV1
 * Single source of truth for category normalization.
 * ADDITIVE ONLY. Does not modify existing logic.
 *
 * UMD-style so it works in:
 * - Browser <script> (window.CategorySpecV1 / window.normalizeCategory)
 * - Node/CommonJS (require('./category-spec-v1.js'))
 * It does NOT require bundlers or "type=module".
 */
(function () {
  const root = (typeof window !== "undefined") ? window : globalThis;

  const CategorySpecV1 = {
    instagram_post: {
      id: "instagram_post",
      label: "Instagram Post",
      kind: "social",
      canvas: { w: 1080, h: 1080 },
      exportProfiles: ["instagram_post"],
      roles: { required: ["background"], optional: ["headline", "subhead", "image", "logo", "cta"] },
      defaults: { style: "Dark Premium", background: "solid" },
      constraints: { allowCTA: true }
    },

    youtube_thumbnail: {
      id: "youtube_thumbnail",
      label: "YouTube Thumbnail",
      kind: "video",
      canvas: { w: 1280, h: 720 },
      exportProfiles: ["youtube_thumbnail"],
      roles: { required: ["background", "headline"], optional: ["image", "badge"] },
      defaults: { style: "Dark Premium", background: "solid" },
      constraints: { allowCTA: false }
    },

    story: {
      id: "story",
      label: "Story",
      kind: "social",
      canvas: { w: 1080, h: 1920 },
      exportProfiles: ["story"],
      roles: { required: ["background"], optional: ["headline", "subhead", "image", "logo", "cta"] },
      defaults: { style: "Dark Premium", background: "solid" },
      constraints: { allowCTA: true }
    },

    flyer: {
      id: "flyer",
      label: "Flyer",
      kind: "print",
      canvas: { w: 1080, h: 1350 },
      exportProfiles: ["flyer"],
      roles: { required: ["background", "headline"], optional: ["subhead", "image", "cta", "logo"] },
      defaults: { style: "Dark Premium", background: "solid" },
      constraints: { allowCTA: true }
    },

    poster: {
      id: "poster",
      label: "Poster",
      kind: "print",
      canvas: { w: 1414, h: 2000 },
      exportProfiles: ["poster"],
      roles: { required: ["background", "headline"], optional: ["subhead", "image", "cta", "logo"] },
      defaults: { style: "Dark Premium", background: "solid" },
      constraints: { allowCTA: true }
    },

    business_card: {
      id: "business_card",
      label: "Business Card",
      kind: "print",
      canvas: { w: 1050, h: 600 },
      exportProfiles: ["business_card"],
      roles: { required: ["background", "logo"], optional: ["headline", "subhead"] },
      defaults: { style: "Corporate", background: "solid" },
      constraints: { allowCTA: false }
    },

    presentation_slide: {
      id: "presentation_slide",
      label: "Presentation Slide",
      kind: "deck",
      canvas: { w: 1920, h: 1080 },
      exportProfiles: ["presentation_slide"],
      roles: { required: ["background", "headline"], optional: ["subhead", "image", "logo"] },
      defaults: { style: "Corporate", background: "solid" },
      constraints: { allowCTA: false }
    },

    resume: {
      id: "resume",
      label: "Resume",
      kind: "doc",
      canvas: { w: 1240, h: 1754 },
      exportProfiles: ["resume"],
      roles: { required: ["background", "headline"], optional: ["subhead", "logo"] },
      defaults: { style: "Light Minimal", background: "solid" },
      constraints: { allowCTA: false }
    },

    // Logo is intentionally different: transparent-capable canvas, symbol/wordmark only.
    logo: {
      id: "logo",
      label: "Logo",
      kind: "logo",
      canvas: { w: 1000, h: 1000 },
      exportProfiles: ["logo"],
      roles: { required: ["image"], optional: ["tagline"], forbidden: ["headline", "subhead", "cta"] },
      defaults: { style: "Corporate", background: "transparent" },
      constraints: { allowCTA: false, allowPhoto: false }
    }
  };

  // Build alias map once (label -> spec, id -> spec, key -> spec)
  const __alias = Object.create(null);
  for (const k of Object.keys(CategorySpecV1)) {
    const spec = CategorySpecV1[k];
    __alias[String(k).toLowerCase()] = spec;
    if (spec && spec.id) __alias[String(spec.id).toLowerCase()] = spec;
    if (spec && spec.label) __alias[String(spec.label).toLowerCase()] = spec;
  }

  function normalizeCategory(input) {
    if (!input) return CategorySpecV1.instagram_post;

    // Accept passing a spec object
    if (typeof input === "object" && input && typeof input.label === "string") {
      const byLabel = __alias[String(input.label).toLowerCase()];
      if (byLabel) return byLabel;
    }

    const raw = String(input).trim();
    if (!raw) return CategorySpecV1.instagram_post;

    const lower = raw.toLowerCase();
    const key = lower.replace(/\s+/g, "_");
    return __alias[lower] || __alias[key] || CategorySpecV1.instagram_post;
  }

  // Browser globals (simple, non-spine)
  if (!root.CategorySpecV1) root.CategorySpecV1 = CategorySpecV1;
  if (!root.normalizeCategory) root.normalizeCategory = normalizeCategory;

  // Optional: also expose under NexoraSpine if present (merge-safe)
  if (root.NexoraSpine) {
    if (!root.NexoraSpine.CategorySpecV1) root.NexoraSpine.CategorySpecV1 = CategorySpecV1;
    if (!root.NexoraSpine.normalizeCategory) root.NexoraSpine.normalizeCategory = normalizeCategory;
  }

  // CommonJS export
  if (typeof module !== "undefined" && module.exports) {
    module.exports.CategorySpecV1 = CategorySpecV1;
    module.exports.normalizeCategory = normalizeCategory;
  }
})();
</script>
<script src="template-contract.js"></script>
  <script src="spine-core.js"></script>
  <script src="style-engine.js"></script>
  <script src="preview-renderer.js"></script>
  <script src="design.js"></script>
<script src="invisible-editor.js"></script>


<!-- YT Preview Shell Toggle -->
<script>
(function(){
  function isYouTubeSelected(){
    const sel = document.getElementById('cat') || document.querySelector('select');
    if(!sel) return false;
    return (sel.value || '').toLowerCase().includes('youtube');
  }

  function toggleYT(){
    const root = document.body;
    if(isYouTubeSelected()){
      root.classList.add('yt-preview');
    } else {
      root.classList.remove('yt-preview');
    }
  }

  // On generate button click
  document.addEventListener('click', function(e){
    const btn = e.target.closest('button');
    if(!btn) return;
    if(btn.textContent && btn.textContent.toLowerCase().includes('generate')){
      setTimeout(toggleYT, 0);
    }
  });

  // Also toggle on category change
  document.addEventListener('change', function(e){
    if(e.target && e.target.tagName === 'SELECT'){
      setTimeout(toggleYT, 0);
    }
  });

  // Initial check
  setTimeout(toggleYT, 0);
  // Initial apply
  document.addEventListener('DOMContentLoaded', toggleYT);
})();
</script>

</body>
</html>
